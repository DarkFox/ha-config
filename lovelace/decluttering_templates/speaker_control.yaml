card:
  type: custom:stack-in-card
  mode: vertical
  cards:
    - type: custom:mini-media-player
      entity: "media_player.[[room]]"
      group: true
      artwork: cover
      idle_view:
        when_idle: true
        when_paused: true
        when_standby: true
      hide:
        icon: true
        source: true
        power: true
        volume: true
        runtime: false
        shuffle: false
        repeat: false
        play_stop: false
      tap_action:
        action: navigate
        navigation_path: /d5369777_music_assistant_beta/ingress
      speaker_group:
        platform: sonos
        entities:
          - entity_id: media_player.stue
            name: Stue
          - entity_id: media_player.sovevaerelse
            name: Soveværelse
          - entity_id: media_player.kokken
            name: Køkken
          - entity_id: media_player.kontor
            name: Kontor
          - entity_id: media_player.badevaerelse
            name: Badeværelse
          - entity_id: media_player.roam
            name: Roam
    - type: conditional
      conditions:
        - entity: "media_player.[[room]]"
          state_not: "off"
        - entity: "media_player.[[room]]"
          state_not: "idle"
        - entity: "media_player.[[room]]"
          state_not: "paused"
        - entity: "media_player.[[room]]"
          state_not: "unavailable"
      card:
        type: entities
        entities:
          - type: custom:auto-entities
            card:
              type: custom:fold-entity-row
              head:
                type: custom:mushroom-number-card
                entity: "input_number.[[room]]_group_volume"
                primary_info: none
                secondary_info: none
                fill_container: true
                icon: mdi:volume-mute
                layout: horizontal
                tap_action:
                  action: call-service
                  service: script.group_mute_toggle
                  data:
                    group: "[[room]]"
                card_mod:
                  style:
                    .: |
                      ha-card {
                        box-shadow: none !important;
                        background: none !important;
                        padding: 0px !important;
                        margin: 0px !important;
                      }
            filter:
              template: |
                {% set group_members = state_attr('media_player.[[room]]', 'group_members') %}
                {% set ns = namespace(ret=[]) %}
                {% for member in group_members %}
                  {% set ns.ret = ns.ret + [
                    {
                      "type": "custom:mushroom-media-player-card",
                      "entity": member,
                      "show_volume_level": true,
                      "volume_controls": [
                          "volume_set",
                          "volume_mute"
                      ],
                      "fill_container": true,
                      "primary_info": "name",
                      "secondary_info": "none",
                      "icon_type": "none",
                      "card_mod": {
                        "style": {
                          ".": "ha-card {\n  box-shadow: none !important;\n  background: none !important;\n  padding: 0px !important;\n  margin: 0px !important;\n}\n"
                        }
                      }
                  }
                ] %}
                {% endfor %}
                {{ ns.ret }}
