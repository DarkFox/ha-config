card:
  type: custom:stack-in-card
  mode: vertical
  cards:
    - type: custom:mini-media-player
      entity: "[[entity]]"
      artwork: cover
      idle_view:
        when_idle: true
        when_paused: true
        when_standby: true
      volume_stateless: true
      replace_mute: stop
      hide:
        icon: true
        source: true
        power: true
        runtime: false
        shuffle: false
        repeat: false
      tap_action:
        action: navigate
        navigation_path: /d5369777_music_assistant_beta/ingress
      speaker_group:
        platform: sonos
        entities:
          - entity_id: media_player.stue
            name: Stue
          - entity_id: media_player.sovevaerelse
            name: Soveværelse
          - entity_id: media_player.kokken
            name: Køkken
          - entity_id: media_player.badevaerelse
            name: Badeværelse
    - type: conditional
      conditions:
        - entity: "[[entity]]"
          state_not: "off"
        - entity: "[[entity]]"
          state_not: "idle"
        - entity: "[[entity]]"
          state_not: "paused"
      card:
        type: entities
        entities:
          - type: custom:auto-entities
            card:
              type: custom:fold-entity-row
              head:
                type: custom:bubble-card
                card_type: button
                entity: "[[entity]]"
                name: " "
                icon: mdi:volume-high
                button_type: slider
                show_state: false
                tap_action:
                  action: call-service
                  service: script.toggle_mute
                  service_data:
                    entity_id: "[[entity]]"
            filter:
              template: |
                {% set group_members = state_attr('[[entity]]', 'group_members') %}
                {% set ns = namespace(ret=[{
                  "type": "section",
                  "label": "Grupperede"
                }]) %}
                {% for member in group_members %}
                  {% set ns.ret = ns.ret + [
                    {
                      "type": "custom:bubble-card",
                      "card_type": "button",
                      "entity": member,
                      "icon": "mdi:volume-high",
                      "button_type": "slider",
                      "show_state": false,
                      "tap_action": {
                        "action": "call-service",
                        "service": "script.toggle_mute",
                        "service_data": {
                          "media_player": member
                        }
                      }
                    }
                  ] %}
                {% endfor %}
                {{ ns.ret }}

              # template: |
              #   {% set group_members = state_attr('[[entity]]', 'group_members') %}
              #   {% set ns = namespace(ret=[]) %}
              #   {% for member in group_members %}
              #     {% if member != '[[entity]]' %}
              #       {% set ns.ret = ns.ret + [
              #         {
              #             "type": "section",
              #             "label": state_attr(member, 'friendly_name')
              #         },
              #         {
              #           "type": "custom:slider-entity-row",
              #           "entity": member,
              #           "toggle": true,
              #           "full_row": true,
              #           "grow": true,
              #           "show_icon": false
              #         }
              #       ] %}
              #     {% endif %}
              #   {% endfor %}
              #   {{ ns.ret }}
