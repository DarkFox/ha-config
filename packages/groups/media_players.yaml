script:
  toggle_mute:
    fields:
      media_player:
        description: Media Player that will be mute or unmuted
        example: media_player.media_room
    sequence:
      - service: media_player.volume_mute
        target:
          entity_id: "{{ media_player }}"
        data:
          is_volume_muted: "{{ not state_attr(media_player , 'is_volume_muted') }}"

template:
  - binary_sensor:
      - name: Stue Group Leader
        state: >-
          {% set entity = 'media_player.stue' %}
          {% set group_members = state_attr(entity, 'group_members') %}
          {% if (group_members|length) > 1 %}
            {{ group_members[0] == entity }}
          {% else %}
            {{ is_state(entity, 'playing') }}
          {% endif %}

      - name: Køkken Group Leader
        state: >-
          {% set entity = 'media_player.kokken' %}
          {% set group_members = state_attr(entity, 'group_members') %}
          {% if (group_members|length) > 1 %}
            {{ group_members[0] == entity }}
          {% else %}
            {{ is_state(entity, 'playing') }}
          {% endif %}

      - name: Sovevaerelse Group Leader
        state: >-
          {% set entity = 'media_player.sovevaerelse' %}
          {% set group_members = state_attr(entity, 'group_members') %}
          {% if (group_members|length) > 1 %}
            {{ group_members[0] == entity }}
          {% else %}
            {{ is_state(entity, 'playing') }}
          {% endif %}

      - name: Badevaerelse Group Leader
        state: >-
          {% set entity = 'media_player.badevaerelse' %}
          {% set group_members = state_attr(entity, 'group_members') %}
          {% if (group_members|length) > 1 %}
            {{ group_members[0] == entity }}
          {% else %}
            {{ is_state(entity, 'playing') }}
          {% endif %}

  - sensor:
      - name: Stue Speaker Lead By
        state: >-
          {% set entity = 'media_player.stue' %}
          {% set group_members = state_attr(entity, 'group_members') %}
          {{ group_members[0] }}

      - name: Køkken Speaker Lead By
        state: >-
          {% set entity = 'media_player.kokken' %}
          {% set group_members = state_attr(entity, 'group_members') %}
          {{ group_members[0] }}

      - name: Sovevaerelse Speaker Lead By
        state: >-
          {% set entity = 'media_player.sovevaerelse' %}
          {% set group_members = state_attr(entity, 'group_members') %}
          {{ group_members[0] }}

      - name: Badevaerelse Speaker Lead By
        state: >-
          {% set entity = 'media_player.badevaerelse' %}
          {% set group_members = state_attr(entity, 'group_members') %}
          {{ group_members[0] }}

      - name: Active Media Player
        state: >
          {% set dev = namespace(active_player='') %}
          {% for item in states.group.all_media.attributes.entity_id if is_state(item, 'playing') %}
            {% if dev.active_player == '' %}
              {% set dev.active_player = item %}
            {% endif %}
          {%- endfor %}

          {{ dev.active_player }}

group:
  sonos:
    name: Sonos Højttalere
    entities:
      - media_player.stue
      - media_player.sovevaerelse
      - media_player.kokken
      - media_player.badevaerelse
  all_media:
    name: All Media
    entities:
      - media_player.sovevaerelse
      - media_player.kokken
      - media_player.badevaerelse

      - media_player.stue_shield
      - media_player.kokken_chromecast
      - media_player.kontor_chromecast
      - media_player.sovevaerelse_chromecast
      - media_player.bar_skaerm

      - media_player.kokken_soundbar
      - media_player.stue_soundbar

      - media_player.sovevaerelse_tv_dlna

      - media_player.kokken_soundbar_songpal
      - media_player.stue_soundbar_songpal
