input_select:
  martin_status:
    name: Martin Status
    options:
      - Snart hjemme
      - Hjemme
      - Lige ankommet
      - Lige gået
      - Væk
      - Udvidet væk

proximity:
  martin_to_home:
    ignored_zones:
      - graested
      - foraeldre
      - work
    devices:
      - device_tracker.google_maps_102040676821115196041
    unit_of_measurement: m
    tolerance: 100

sensor:
  - platform: template
    sensors:
      martin_to_home_dir_of_travel:
        friendly_name: "Direction of Travel to Home"
        value_template: "{{ state_attr('proximity.martin_to_home', 'dir_of_travel') }}"
      martin_to_home_distance_change:
        friendly_name: "Distance change to Home"
        value_template: "{{ state_attr('sensor.proximity_martin_to_home_stats', 'change') }}"
        unit_of_measurement: "m"
      martin_to_home_distance_average_change:
        friendly_name: "Distance change average to Home"
        value_template: "{{ state_attr('sensor.proximity_martin_to_home_stats', 'average_change') }}"
        unit_of_measurement: "m"


  - platform: statistics
    name: proximity_martin_to_home_stats
    entity_id: proximity.martin_to_home
    max_age:
      minutes: 5

binary_sensor:
  - platform: template
    sensors:
      martin_home_soon:
        friendly_name: "Martin Snart hjemme"
        value_template: >
          {{
            states('proximity.martin_to_home')|float < 1500
            or
            (
              states('sensor.martin_to_home_distance_change')|float * 4
            ) + states('proximity.martin_to_home')|float < 0
          }}


      martin_presence_delayed:
        friendly_name: 'Martin Presence - Delayed'
        device_class: presence
        entity_id: binary_sensor.martin_presence
        value_template: >-
          {{ is_state('binary_sensor.martin_presence', 'on') }}
        delay_off:
          minutes: 10
      martin_presence_extended:
        friendly_name: 'Martin Presence - Extended Away'
        device_class: presence
        entity_id: binary_sensor.martin_presence
        value_template: >-
          {{ is_state('binary_sensor.martin_presence', 'on') }}
        delay_off:
          hours: 24

  - platform: bayesian
    name: 'Martin Presence'
    prior: 0.5
    probability_threshold: 0.8
    observations:
      - entity_id: 'device_tracker.google_maps_102040676821115196041'
        prob_given_true: 0.9
        prob_given_false: -0.5
        platform: 'state'
        to_state: 'home'
      - entity_id: 'binary_sensor.activity_last30'
        prob_given_true: 0.7
        prob_given_false: 0.3
        platform: 'state'
        to_state: 'on'
      - entity_id: 'binary_sensor.activity_last10'
        prob_given_true: 0.8
        prob_given_false: 0.5
        platform: 'state'
        to_state: 'on'
      - entity_id: 'input_select.latest_motion'
        prob_given_true: 0.4
        prob_given_false: 0.3
        platform: 'state'
        to_state: 'Bedroom'

automation:
    
  ## Notifications ##
  - alias: presence notification
    trigger:
      - platform: state
        entity_id: binary_sensor.martin_presence
        from: 'on'
        to: 'off'
      - platform: state
        entity_id: binary_sensor.martin_presence
        from: 'off'
        to: 'on'
    action:
      - service: persistent_notification.create
        data_template:
          message: "Presence: {{ states('binary_sensor.martin_presence') }}"
          title: "Presence"

  - alias: home soon notification
    trigger:
      - platform: state
        entity_id: binary_sensor.martin_home_soon
        from: 'on'
        to: 'off'
      - platform: state
        entity_id: binary_sensor.martin_home_soon
        from: 'off'
        to: 'on'
    action:
      - service: persistent_notification.create
        data_template:
          message: "Home Soon: {{ states('binary_sensor.martin_home_soon') }}"
          title: "Home Soon"
