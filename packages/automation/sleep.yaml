group:
  sleep_as_android:
    name: 'Sleep as Android'
    entities:
      - sensor.sleep_tracker
      - sensor.phone_alarm
      - counter.snooze_counter

counter:
  snooze_counter:
    name: Snooze Counter
    icon: mdi:alarm-snooze

script:
  morning_briefing:
    alias: Morning Briefing
    sequence:
      - service: tts.google_say
        data_template:
          entity_id: "{{ device_entity_id }}"
          message: >
            Godmorgen. Klokken er {{ states.sensor.time.state }}.
            Vejrudsigt: {{ states('sensor.pws_temp_c') | replace('.',',') }}° og {{ states('sensor.pws_weather') }}.
            {% if is_state('binary_sensor.workday_sensor', 'on') -%}
              S-Tog Linje B:
              {% if is_state('sensor.s_train_b_status', 'Til tiden') -%}
                Kører normalt.
              {% else -%}
                 {{ states('sensor.s_train_b_status') }}. {{ states('sensor.s_train_message') }}
                 Estimeret rejsetid: {{ states('sensor.travel_time_to_work_public_transit') }} minutter.
              {%- endif -%}
            {%- endif -%}
          language: 'da'

  alexa_calendar:
    alias: Alexa Calendar
    sequence:
      - service: tts.google_say
        data_template:
          entity_id: "{{ device_entity_id }}"
          message: Alexa, what's today's schedule?

  morning_lights:
    alias: Turn lights to default and turn off the fan.
    sequence:
      - service: input_select.select_option
        data_template:
          option: 'Default'
          entity_id: >
            {% if is_state('input_boolean.guests', 'on') %}
              input_select.bedroom_light_profile
            {% else %}
              input_select.light_profile
            {% endif %}
      - service: switch.turn_off
        entity_id: switch.bedroom_fan


automation:
  - alias: bedtime
    trigger:
      platform: state
      entity_id: sensor.phone_alarm
      to: 'bedtime'
    condition:
      condition: state
      entity_id: binary_sensor.martin_presence
      state: 'on'
    action:
      service: input_select.select_option
      data_template:
        option: 'Night'
        entity_id: >
          {% if is_state('input_boolean.guests', 'on') %}
            input_select.bedroom_light_profile
          {% else %}
            input_select.light_profile
          {% endif %}

  - alias: sleep_time
    trigger:
      platform: state
      entity_id: sensor.sleep_tracker
      to: 'tracking'
    condition:
      condition: state
      entity_id: binary_sensor.martin_presence
      state: 'on'
    action:
      service: input_select.select_option
      data_template:
        option: 'Off'
        entity_id: >
          {% if is_state('input_boolean.guests', 'on') %}
            input_select.bedroom_light_profile
          {% else %}
            input_select.light_profile
          {% endif %}

  - alias: sleep_paused
    trigger:
      platform: state
      entity_id: sensor.sleep_tracker
      to: 'paused'
    condition:
      condition: state
      entity_id: binary_sensor.martin_presence
      state: 'on'
    action:
      service: input_select.select_option
      data_template:
        option: 'Night'
        entity_id: >
          {% if is_state('input_boolean.guests', 'on') %}
            input_select.bedroom_light_profile
          {% else %}
            input_select.light_profile
          {% endif %}

  - alias: sleep_stopped
    trigger:
      platform: state
      entity_id: sensor.sleep_tracker
      to: 'stopped'
    condition:
      condition: state
      entity_id: binary_sensor.martin_presence
      state: 'on'
    action:
      service: input_select.select_option
      data_template:
        option: 'Ambient'
        entity_id: >
          {% if is_state('input_boolean.guests', 'on') %}
            input_select.bedroom_light_profile
          {% else %}
            input_select.light_profile
          {% endif %}

  - alias: alarm_ringing
    trigger:
      platform: state
      entity_id: sensor.phone_alarm
      to: 'ringing'
    condition:
      condition: state
      entity_id: binary_sensor.martin_presence
      state: 'on'
    action:
      service: input_select.select_option
      data_template:
        option: 'Ambient'
        entity_id: >
          {% if is_state('input_boolean.guests', 'on') %}
            input_select.bedroom_light_profile
          {% else %}
            input_select.light_profile
          {% endif %}

  - alias: alarm_snooze
    trigger:
      platform: state
      entity_id: sensor.phone_alarm
      to: 'snooze'
    condition:
      condition: state
      entity_id: binary_sensor.martin_presence
      state: 'on'
    action:
      service: input_select.select_option
      data_template:
        option: 'Night'
        entity_id: >
          {% if is_state('input_boolean.guests', 'on') %}
            input_select.bedroom_light_profile
          {% else %}
            input_select.light_profile
          {% endif %}

  - alias: alarm_dismissed
    trigger:
      platform: state
      entity_id: sensor.phone_alarm
      to: 'dismissed'
    condition:
      condition: state
      entity_id: binary_sensor.martin_presence
      state: 'on'
    action:
      service: input_select.select_option
      data_template:
        option: 'Ambient'
        entity_id: >
          {% if is_state('input_boolean.guests', 'on') %}
            input_select.bedroom_light_profile
          {% else %}
            input_select.light_profile
          {% endif %}

  # Actions
  - alias: sleeping_activity
    trigger:
      platform: state
      entity_id: sensor.sleep_tracker
      to: 'tracking'
    condition:
      condition: state
      entity_id: binary_sensor.martin_presence
      state: 'on'
    action:
      service: input_select.select_option
      data:
        entity_id: input_select.martin_activity
        option: Sleeping

  - alias: snoozing_activity
    trigger:
      platform: state
      entity_id: sensor.phone_alarm
      to: 'snooze'
    action:
      service: counter.increment
      data:
        entity_id: counter.snooze_counter

  - alias: snooze_counter_reset
    trigger:
      platform: state
      entity_id: sensor.phone_alarm
      to: 'dismissed'
    action:
      service: counter.reset
      data:
        entity_id: counter.snooze_counter

  - alias: alarm_dismissed_activity
    trigger:
      platform: state
      entity_id: sensor.phone_alarm
      to: 'dismissed'
    condition:
      condition: state
      entity_id: binary_sensor.martin_presence
      state: 'on'
    action:
      - service: input_select.select_option
        data:
          entity_id: input_select.martin_activity
          option: Waking
      - service: input_select.select_option
        data:
          entity_id: input_select.playlist_player
          option: 'media_player.east_side_speakers'
      - delay:
          seconds: 1
      - service: input_select.set_options
        data_template:
          entity_id: input_select.playlist
          options:
            - "==SCRIPT==morning_briefing"
            - "{{ states.sensor.podcast_daily_tech_news_show.state }}"
            - "==END=="
      - delay:
          seconds: 2
      - service: media_player.volume_set
        data_template:
          entity_id: 'media_player.east_side_speakers'
          volume_level: 0.35

  - alias: morning_awake
    trigger:
      platform: state
      entity_id: binary_sensor.hallway_sensor
      to: 'on'
    condition:
      condition: and
      conditions:
        - condition: state
          entity_id: binary_sensor.martin_presence
          state: 'on'
        - condition: state
          entity_id: input_select.martin_activity
          state: 'Waking'
    action:
      - service: script.turn_on
        data:
          entity_id: script.morning_lights
      - service: joaoapps_join.phone_send_tasker
        data:
          command: "sleep_tracking_stop"


  - alias: morning_podcast
    trigger:
      platform: state
      entity_id: input_select.martin_activity
      to: 'Waking'
    condition:
      condition: state
      entity_id: binary_sensor.martin_presence
      state: 'on'
    action:
      - service: input_select.select_option
        data:
          entity_id: input_select.playlist_player
          option: 'media_player.east_side_speakers'
      - delay:
          seconds: 1
      - service: input_select.set_options
        data_template:
          entity_id: input_select.playlist
          options:
            - "==SCRIPT==morning_briefing"
            - "{{ states.sensor.podcast_bbc_minute.state }}"
            - "{{ states.sensor.podcast_24syv_nyheder.state }}"
            - "==END=="
      - delay:
          seconds: 2
      - service: media_player.volume_set
        data_template:
          entity_id: 'media_player.east_side_speakers'
          volume_level: 0.35
