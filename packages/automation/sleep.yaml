group:
  sleep_as_android:
    name: 'Sleep as Android'
    entities:
      - sensor.sleep_tracker
      - sensor.phone_alarm
      - counter.snooze_counter
      - input_select.sleep_state

input_select:
  sleep_state:
    options:
      - awake
      - bedtime
      - in bed
      - sleeping
      - paused
      - alarm
      - snoozing
      - waking

counter:
  snooze_counter:
    name: Snooze Counter
    icon: mdi:alarm-snooze

script:
  morning_briefing:
    alias: Morning Briefing
    sequence:
      - service: homeassistant.update_entity
        data:
          entity_id: sensor.tts_greeting
      - service: tts.google_cloud_say
        data_template:
          entity_id: "{{ device_entity_id }}"
          message: >
            {{ states("sensor.tts_greeting") }}. Klokken er {{ states("sensor.time") }}.
            Vejrudsigt: {{ states("sensor.dmi_vejr") }}.
            {% if is_state('binary_sensor.workday_sensor', 'on') and now().hour < 12 -%}
              S-Tog Linje B:
              {%- if is_state('sensor.s_train_b_status', 'Til tiden') -%}
                {{ ' ' }}KÃ¸rer normalt.
              {%- else -%}
                 {{ ' ' }}{{ states('sensor.s_train_b_status') }}.
                 {{ states('sensor.s_train_message') }}.
              {%- endif -%}
            {%- endif -%}

automation:

  #######################
  # SLEEP STATE MACHINE #
  #######################

  - alias: sleep_state_bedtime
    initial_state: true
    trigger:
      platform: state
      entity_id: sensor.phone_alarm
      to: 'bedtime'
    condition:
      condition: and
      conditions:
        - condition: state
          entity_id: binary_sensor.martin_presence_delayed
          state: 'on'
        - condition: state
          entity_id: input_select.sleep_state
          state: 'awake'
    action:
      service: input_select.select_option
      data:
        entity_id: input_select.sleep_state
        option: bedtime

  - alias: sleep_state_in_bed
    initial_state: true
    trigger:
      - platform: state
        entity_id: binary_sensor.seng_bevaegelse
        to: 'on'
      - platform: state
        entity_id: input_select.sleep_state
        to: 'bedtime'
      - platform: state
        entity_id: binary_sensor.sovevaerelse_gulv_bevaegelse
        to: 'off'
    condition:
      condition: and
      conditions:
        - condition: state
          entity_id: binary_sensor.seng_bevaegelse
          state: 'on'
        - condition: state
          entity_id: input_select.sleep_state
          state: 'bedtime'
        - condition: state
          entity_id: binary_sensor.martin_presence_delayed
          state: 'on'
        - condition: state
          entity_id: binary_sensor.sovevaerelse_gulv_bevaegelse
          state: 'off'
    action:
      service: input_select.select_option
      data:
        entity_id: input_select.sleep_state
        option: in bed

  - alias: sleep_state_sleeping
    initial_state: true
    trigger:
      platform: state
      entity_id: sensor.sleep_tracker
      to: 'tracking'
    condition:
      condition: and
      conditions:
        - condition: state
          entity_id: binary_sensor.martin_presence_delayed
          state: 'on'
        - condition: or
          conditions:
            - condition: state
              entity_id: input_select.sleep_state
              state: in bed
            - condition: state
              entity_id: input_select.sleep_state
              state: paused
    action:
      - service: input_select.select_option
        data:
          entity_id: input_select.sleep_state
          option: sleeping
      - service: input_select.select_option
        data:
          entity_id: input_select.martin_activity
          option: Sleeping


  - alias: sleep_state_sleeping_cancelled
    initial_state: true
    trigger:
      platform: state
      entity_id: sensor.sleep_tracker
      to: 'stopped'
    condition:
      condition: and
      conditions:
        - condition: state
          entity_id: binary_sensor.martin_presence_delayed
          state: 'on'
        - condition: time
          after: "20:00:00"
          before: "05:00:00"
        - condition: or
          conditions:
            - condition: state
              entity_id: input_select.sleep_state
              state: sleeping
            - condition: state
              entity_id: input_select.sleep_state
              state: paused
    action:
      - service: input_select.select_option
        data:
          entity_id: input_select.sleep_state
          option: bedtime

  - alias: sleep_state_paused
    initial_state: true
    trigger:
      - platform: state
        entity_id: sensor.sleep_tracker
        to: 'paused'
      - platform: state
        entity_id: binary_sensor.sovevaerelse_gulv_bevaegelse
        to: 'on'
      - platform: state
        entity_id: binary_sensor.hallway_sensor
        to: 'on'
    condition:
      condition: and
      conditions:
        - condition: state
          entity_id: binary_sensor.martin_presence_delayed
          state: 'on'
        - condition: state
          entity_id: input_select.sleep_state
          state: sleeping
    action:
      service: input_select.select_option
      data:
        entity_id: input_select.sleep_state
        option: paused

  - alias: sleep_state_unpause
    initial_state: true
    trigger:
      - platform: state
        entity_id: binary_sensor.seng_bevaegelse
        to: 'on'
      - platform: state
        entity_id: input_select.sleep_state
        to: 'paused'
      - platform: state
        entity_id: binary_sensor.sovevaerelse_gulv_bevaegelse
        to: 'off'
    condition:
      condition: and
      conditions:
        - condition: state
          entity_id: binary_sensor.seng_bevaegelse
          state: 'on'
        - condition: state
          entity_id: input_select.sleep_state
          state: 'paused'
        - condition: state
          entity_id: input_select.latest_motion
          state: 'Bedroom'
        - condition: state
          entity_id: binary_sensor.sovevaerelse_gulv_bevaegelse
          state: 'off'
    action:
      service: input_select.select_option
      data:
        entity_id: input_select.sleep_state
        option: sleeping

  - alias: sleep_state_alarm
    initial_state: true
    trigger:
      platform: state
      entity_id: sensor.phone_alarm
      to: 'ringing'
    condition:
      condition: and
      conditions:
        - condition: state
          entity_id: binary_sensor.martin_presence_delayed
          state: 'on'
        - condition: or
          conditions:
            - condition: state
              entity_id: input_select.sleep_state
              state: in bed
            - condition: state
              entity_id: input_select.sleep_state
              state: sleeping
            - condition: state
              entity_id: input_select.sleep_state
              state: paused
    action:
      - service: input_select.select_option
        data:
          entity_id: input_select.sleep_state
          option: alarm

  - alias: sleep_state_snoozing
    initial_state: true
    trigger:
      platform: state
      entity_id: sensor.phone_alarm
      to: 'snooze'
    condition:
      condition: and
      conditions:
        - condition: state
          entity_id: binary_sensor.martin_presence_delayed
          state: 'on'
        - condition: state
          entity_id: input_select.sleep_state
          state: alarm
    action:
      - service: input_select.select_option
        data:
          entity_id: input_select.sleep_state
          option: snoozing

  - alias: sleep_state_waking
    initial_state: true
    trigger:
      platform: state
      entity_id: sensor.phone_alarm
      to: 'dismissed'
    condition:
      condition: or
      conditions:
        - condition: state
          entity_id: input_select.sleep_state
          state: alarm
        - condition: state
          entity_id: input_select.sleep_state
          state: snoozing
    action:
      - service: input_select.select_option
        data:
          entity_id: input_select.sleep_state
          option: waking

  - alias: sleep_state_awake
    initial_state: true
    trigger:
      - platform: state
        entity_id: binary_sensor.hallway_sensor
        to: 'on'
      - platform: state
        entity_id: binary_sensor.sovevaerelse_gulv_bevaegelse
        to: 'on'
    condition:
      condition: or
      conditions:
        - condition: state
          entity_id: input_select.sleep_state
          state: alarm
        - condition: state
          entity_id: input_select.sleep_state
          state: snoozing
        - condition: state
          entity_id: input_select.sleep_state
          state: waking
    action:
      - service: input_select.select_option
        data:
          entity_id: input_select.sleep_state
          option: awake

  ######################
  # ACTIONS START HERE #
  ######################

  - alias: bedtime_action
    initial_state: true
    trigger:
      platform: state
      entity_id: input_select.sleep_state
      to: 'bedtime'
    action:
      - service: input_number.set_value
        data:
          entity_id: "input_number.scene_transition_time"
          value: 300.0
      - delay:
          seconds: 1
      - service: input_select.select_option
        data_template:
          option: 'Ambient'
          entity_id: >
            {% if is_state('input_boolean.guests', 'on') %}
              input_select.bedroom_light_profile
            {% else %}
              input_select.light_profile
            {% endif %}
      - delay:
          seconds: 2
      - service: automation.trigger
        data:
          entity_id: "automation.reset_scene_transition_time"

  - alias: in_bed_action
    initial_state: true
    trigger:
      platform: state
      entity_id: input_select.sleep_state
      to: 'in bed'
    action:
      - service: input_number.set_value
        data:
          entity_id: "input_number.scene_transition_time"
          value: 120.0
      - delay:
          seconds: 1
      - service: input_select.select_option
        data_template:
          option: 'Night'
          entity_id: >
            {% if is_state('input_boolean.guests', 'on') %}
              input_select.bedroom_light_profile
            {% else %}
              input_select.light_profile
            {% endif %}
      - delay:
          seconds: 2
      - service: automation.trigger
        data:
          entity_id: "automation.reset_scene_transition_time"

  - alias: sleeping_action
    initial_state: true
    trigger:
      platform: state
      entity_id: input_select.sleep_state
      to: 'sleeping'
      from: 'in bed'
    action:
      - service: input_number.set_value
        data:
          entity_id: "input_number.scene_transition_time"
          value: 10.0
      - delay:
          seconds: 1
      - service: input_select.select_option
        data_template:
          option: 'Off'
          entity_id: >
            {% if is_state('input_boolean.guests', 'on') %}
              input_select.bedroom_light_profile
            {% else %}
              input_select.light_profile
            {% endif %}
      - delay:
          seconds: 2
      - service: automation.trigger
        data:
          entity_id: "automation.reset_scene_transition_time"

  - alias: sleep_paused_action
    initial_state: true
    trigger:
      platform: state
      entity_id: input_select.sleep_state
      to: 'paused'
    action:
      - service: joaoapps_join.phone_send_tasker
        data:
          command: "sleep_tracking_pause"
      - service: input_select.select_option
        data_template:
          option: 'Night'
          entity_id: >
            {% if is_state('input_boolean.guests', 'on') %}
              input_select.bedroom_light_profile
            {% else %}
              input_select.light_profile
            {% endif %}

  - alias: resume_sleep_action
    initial_state: true
    trigger:
      platform: state
      entity_id: input_select.sleep_state
      to: 'sleeping'
      from: 'paused'
    action:
      - service: joaoapps_join.phone_send_tasker
        data:
          command: "sleep_tracking_resume"
      - service: input_select.select_option
        data_template:
          option: 'Off'
          entity_id: >
            {% if is_state('input_boolean.guests', 'on') %}
              input_select.bedroom_light_profile
            {% else %}
              input_select.light_profile
            {% endif %}

  - alias: alarm_action
    initial_state: true
    trigger:
      platform: state
      entity_id: input_select.sleep_state
      to: 'alarm'
    action:
      - service: input_select.select_option
        data_template:
          option: 'Night'
          entity_id: >
            {% if is_state('input_boolean.guests', 'on') %}
              input_select.bedroom_light_profile
            {% else %}
              input_select.light_profile
            {% endif %}
      - delay:
          seconds: 10
      - service: input_number.set_value
        data:
          entity_id: "input_number.scene_transition_time"
          value: 600.0
      - delay:
          seconds: 1
      - service: input_select.select_option
        data_template:
          option: 'Ambient'
          entity_id: >
            {% if is_state('input_boolean.guests', 'on') %}
              input_select.bedroom_light_profile
            {% else %}
              input_select.light_profile
            {% endif %}
      - service: input_select.select_option
        data:
          entity_id: input_select.playlist_player
          option: 'media_player.sovevaerelse_soundbar'
      - service: input_select.set_options
        data_template:
          entity_id: input_select.playlist
          options:
            - "==SCRIPT==morning_briefing"
            - "{{ states('sensor.podcast_bbc_minute') }}"
            - "http://live-icy.gss.dr.dk:8000/A/A05H.mp3"
            - "==END=="
      - delay:
          seconds: 2
      - service: media_player.volume_set
        data_template:
          entity_id: 'media_player.sovevaerelse_soundbar'
          volume_level: 0.25
      - service: automation.trigger
        data:
          entity_id: "automation.reset_scene_transition_time"

  - alias: snoozing_action
    initial_state: true
    trigger:
      platform: state
      entity_id: input_select.sleep_state
      to: 'snoozing'
      from: 'alarm'
    action:
      - service: input_number.set_value
        data:
          entity_id: "input_number.scene_transition_time"
          value: 120.0
      - delay:
          seconds: 1
      - service: input_select.select_option
        data_template:
          option: 'Ambient'
          entity_id: >
            {% if is_state('input_boolean.guests', 'on') %}
              input_select.bedroom_light_profile
            {% else %}
              input_select.light_profile
            {% endif %}
      - delay: 00:00:02
      - service: automation.trigger
        data:
          entity_id: "automation.reset_scene_transition_time"

  - alias: waking_action
    initial_state: true
    trigger:
      platform: state
      entity_id: input_select.sleep_state
      to: 'waking'
    action:
      - service: input_number.set_value
        data:
          entity_id: "input_number.scene_transition_time"
          value: 120.0
      - delay:
          seconds: 1
      - service: input_select.select_option
        data_template:
          option: 'Dimmed'
          entity_id: >
            {% if is_state('input_boolean.guests', 'on') %}
              input_select.bedroom_light_profile
            {% else %}
              input_select.light_profile
            {% endif %}
      - service: input_select.select_option
        data:
          entity_id: input_select.playlist_player
          option: 'media_player.sovevaerelse_soundbar'
      - service: input_select.set_options
        data_template:
          entity_id: input_select.playlist
          options:
            - "==SCRIPT==morning_briefing"
            - "{{ states('sensor.podcast_bbc_minute') }}"
            - "{{ states('sensor.podcast_24syv_nyheder') }}"
            - "http://live-icy.gss.dr.dk:8000/A/A05H.mp3"
            - "==END=="
      - delay:
          seconds: 2
      - service: media_player.volume_set
        data_template:
          entity_id: 'media_player.sovevaerelse_soundbar'
          volume_level: 0.25
      - service: automation.trigger
        data:
          entity_id: "automation.reset_scene_transition_time"

  - alias: awake_activity
    initial_state: true
    trigger:
      platform: state
      entity_id: input_select.sleep_state
      to: 'awake'
      from: 'waking'
    action:
      - service: input_boolean.turn_on
        data:
          entity_id:
            - input_boolean.hallway_activity_override
            - input_boolean.bathroom_activity_override
      - delay:
          seconds: 1
      - service: input_number.set_value
        data:
          entity_id: "input_number.scene_transition_time"
          value: 240.0
      - delay:
          seconds: 1
      - service: input_select.select_option
        data_template:
          option: 'Default'
          entity_id: >
            {% if is_state('input_boolean.guests', 'on') %}
              input_select.bedroom_light_profile
            {% else %}
              input_select.light_profile
            {% endif %}
      - service: joaoapps_join.phone_send_tasker
        data:
          command: "sleep_tracking_stop"
      - service: input_select.select_option
        data:
          entity_id: input_select.playlist_player
          option: 'media_player.ost_hojttalere'
      - delay:
          seconds: 1
      - service: input_select.set_options
        data_template:
          entity_id: input_select.playlist
          options:
            - "==SCRIPT==morning_briefing"
            - "{{ states('sensor.podcast_bbc_minute') }}"
            - "{{ states('sensor.podcast_daily_tech_news_show') }}"
            - "{{ states('sensor.podcast_24syv_nyheder') }}"
            - "http://live-icy.gss.dr.dk:8000/A/A05H.mp3"
            - "==END=="
      - delay:
          seconds: 2
      - service: media_player.volume_set
        data_template:
          entity_id: 'media_player.sovevaerelse_soundbar'
          volume_level: 0.3
      - service: media_player.volume_set
        data_template:
          entity_id: 'media_player.ost_hojttalere'
          volume_level: 0.4
      - service: automation.trigger
        data:
          entity_id: "automation.reset_scene_transition_time"
      - service: input_boolean.turn_off
        data:
          entity_id:
            - input_boolean.hallway_activity_override
            - input_boolean.bathroom_activity_override