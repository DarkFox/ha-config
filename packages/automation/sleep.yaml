group:
  sleep_as_android:
    name: 'Sleep as Android'
    entities:
      - sensor.sleep_tracker
      - sensor.phone_alarm
      - counter.snooze_counter
      - input_select.sleep_state

input_select:
  sleep_state:
    options:
      - awake
      - bedtime
      - in bed
      - sleeping
      - paused
      - alarm
      - snoozing
      - waking

counter:
  snooze_counter:
    name: Snooze Counter
    icon: mdi:alarm-snooze

script:
  morning_briefing:
    alias: Morning Briefing
    sequence:
      - service: homeassistant.update_entity
        data:
          entity_id: sensor.tts_greeting
      - service: tts.google_say
        data_template:
          entity_id: "{{ device_entity_id }}"
          message: >
            {{ states.sensor.tts_greeting.state }}. Klokken er {{ states.sensor.time.state }}.
            Vejrudsigt: {{ states.sensor.dmi_city_weather.state }}.
            Temperaturer mellem {{ (states.sensor.dark_sky_daytime_low_temperature.state or states.sensor.dark_sky_overnight_low_temperature.state) | round | int }}
            {{- '' }} og {{ (states.sensor.dark_sky_daytime_high_temperature.state or states.sensor.dark_sky_overnight_high_temperature.state) | round | int }}˚,
            {{- '' }} med {{ states.sensor.dark_sky_wind_speed_name.state }}.
            {% if states('sensor.dark_sky_precip_probability')|int > 25 -%}
              {{ states.sensor.dark_sky_precip_probability.state|round|int }}% risiko for op til {{ states.sensor.dark_sky_precip_intensity.state | round | int }} mm {{ states.sensor.dark_sky_precip_dk.state }}.
            {%- endif %}
            {% if is_state('binary_sensor.workday_sensor', 'on') and now().hour < 12 -%}
              S-Tog Linje B:
              {% if is_state('sensor.s_train_b_status', 'Til tiden') -%}
                Kører normalt.
              {% else -%}
                 {{ states('sensor.s_train_b_status') }}. {{ states('sensor.s_train_message') }}.
                 Estimeret rejsetid: {{ states('sensor.travel_time_to_work_public_transit') }} minutter.
              {%- endif -%}
            {%- endif -%}
          language: 'da'

automation:

  #######################
  # SLEEP STATE MACHINE #
  #######################

  - alias: sleep_state_bedtime
    initial_state: true
    trigger:
      platform: state
      entity_id: sensor.phone_alarm
      to: 'bedtime'
    condition:
      condition: and
      conditions:
        - condition: state
          entity_id: binary_sensor.martin_presence_delayed
          state: 'on'
        - condition: state
          entity_id: input_select.sleep_state
          state: 'awake'
    action:
      service: input_select.select_option
      data:
        entity_id: input_select.sleep_state
        option: bedtime

  - alias: sleep_state_in_bed
    initial_state: true
    trigger:
      - platform: state
        entity_id: binary_sensor.bed_motion
        to: 'on'
      - platform: state
        entity_id: input_select.sleep_state
        to: 'bedtime'
    condition:
      condition: and
      conditions:
        - condition: state
          entity_id: binary_sensor.bed_motion
          state: 'on'
        - condition: state
          entity_id: input_select.sleep_state
          state: 'bedtime'
        - condition: state
          entity_id: binary_sensor.martin_presence_delayed
          state: 'on'
    action:
      service: input_select.select_option
      data:
        entity_id: input_select.sleep_state
        option: in bed

  - alias: sleep_state_sleeping
    initial_state: true
    trigger:
      platform: state
      entity_id: sensor.sleep_tracker
      to: 'tracking'
    condition:
      condition: and
      conditions:
        - condition: state
          entity_id: binary_sensor.martin_presence_delayed
          state: 'on'
        - condition: or
          conditions:
            - condition: state
              entity_id: input_select.sleep_state
              state: in bed
            - condition: state
              entity_id: input_select.sleep_state
              state: paused
    action:
      - service: input_select.select_option
        data:
          entity_id: input_select.sleep_state
          option: sleeping
      - service: input_select.select_option
        data:
          entity_id: input_select.martin_activity
          option: Sleeping


  - alias: sleep_state_sleeping_cancelled
    initial_state: true
    trigger:
      platform: state
      entity_id: sensor.sleep_tracker
      to: 'stopped'
    condition:
      condition: and
      conditions:
        - condition: state
          entity_id: binary_sensor.martin_presence_delayed
          state: 'on'
        - condition: time
          after: "20:00:00"
          before: "05:00:00"
        - condition: or
          conditions:
            - condition: state
              entity_id: input_select.sleep_state
              state: sleeping
            - condition: state
              entity_id: input_select.sleep_state
              state: paused
    action:
      - service: input_select.select_option
        data:
          entity_id: input_select.sleep_state
          option: bedtime

  - alias: sleep_state_paused
    initial_state: true
    trigger:
      platform: state
      entity_id: sensor.sleep_tracker
      to: 'paused'
    condition:
      condition: and
      conditions:
        - condition: state
          entity_id: binary_sensor.martin_presence_delayed
          state: 'on'
        - condition: state
          entity_id: input_select.sleep_state
          state: sleeping
    action:
      service: input_select.select_option
      data:
        entity_id: input_select.sleep_state
        option: paused

  - alias: sleep_state_alarm
    initial_state: true
    trigger:
      platform: state
      entity_id: sensor.phone_alarm
      to: 'ringing'
    condition:
      condition: and
      conditions:
        - condition: state
          entity_id: binary_sensor.martin_presence_delayed
          state: 'on'
        - condition: or
          conditions:
            - condition: state
              entity_id: input_select.sleep_state
              state: in bed
            - condition: state
              entity_id: input_select.sleep_state
              state: sleeping
            - condition: state
              entity_id: input_select.sleep_state
              state: paused
    action:
      - service: input_select.select_option
        data:
          entity_id: input_select.sleep_state
          option: alarm

  - alias: sleep_state_snoozing
    initial_state: true
    trigger:
      platform: state
      entity_id: sensor.phone_alarm
      to: 'snooze'
    condition:
      condition: and
      conditions:
        - condition: state
          entity_id: binary_sensor.martin_presence_delayed
          state: 'on'
        - condition: state
          entity_id: input_select.sleep_state
          state: alarm
    action:
      - service: input_select.select_option
        data:
          entity_id: input_select.sleep_state
          option: snoozing

  - alias: sleep_state_waking
    initial_state: true
    trigger:
      platform: state
      entity_id: sensor.phone_alarm
      to: 'dismissed'
    condition:
      condition: or
      conditions:
        - condition: state
          entity_id: input_select.sleep_state
          state: alarm
        - condition: state
          entity_id: input_select.sleep_state
          state: snoozing
    action:
      - service: input_select.select_option
        data:
          entity_id: input_select.sleep_state
          option: waking

  - alias: sleep_state_awake
    initial_state: true
    trigger:
      platform: state
      entity_id: binary_sensor.hallway_sensor
      to: 'on'
    condition:
      condition: or
      conditions:
        - condition: state
          entity_id: input_select.sleep_state
          state: alarm
        - condition: state
          entity_id: input_select.sleep_state
          state: snoozing
        - condition: state
          entity_id: input_select.sleep_state
          state: waking
    action:
      - service: input_select.select_option
        data:
          entity_id: input_select.sleep_state
          option: awake

  ######################
  # ACTIONS START HERE #
  ######################

  - alias: bedtime_action
    initial_state: true
    trigger:
      platform: state
      entity_id: input_select.sleep_state
      to: 'bedtime'
    action:
      - service: input_select.select_option
        data_template:
          option: 'Ambient'
          entity_id: >
            {% if is_state('input_boolean.guests', 'on') %}
              input_select.bedroom_light_profile
            {% else %}
              input_select.light_profile
            {% endif %}
      - delay: 00:30:00
      - condition: state
        entity_id: input_select.sleep_state
        state: 'bedtime'
      - service: input_select.select_option
        data_template:
          option: 'Night'
          entity_id: >
            {% if is_state('input_boolean.guests', 'on') %}
              input_select.bedroom_light_profile
            {% else %}
              input_select.light_profile
            {% endif %}

  - alias: in_bed_action
    initial_state: true
    trigger:
      platform: state
      entity_id: input_select.sleep_state
      to: 'in bed'
    action:
      - service: input_select.select_option
        data_template:
          option: 'Night'
          entity_id: >
            {% if is_state('input_boolean.guests', 'on') %}
              input_select.bedroom_light_profile
            {% else %}
              input_select.light_profile
            {% endif %}
      - delay:
          seconds: 3
      - service: light.turn_on
        data:
          brightness: 32
          color_temp: 500
          entity_id: light.bedside

  - alias: sleeping_action
    initial_state: true
    trigger:
      platform: state
      entity_id: input_select.sleep_state
      to: 'sleeping'
      from: 'in bed'
      for:
        seconds: 10
    action:
      - service: input_select.select_option
        data_template:
          option: 'Off'
          entity_id: >
            {% if is_state('input_boolean.guests', 'on') %}
              input_select.bedroom_light_profile
            {% else %}
              input_select.light_profile
            {% endif %}

  - alias: sleep_paused_action
    initial_state: true
    trigger:
      platform: state
      entity_id: input_select.sleep_state
      to: 'paused'
    action:
      - service: input_select.select_option
        data_template:
          option: 'Night'
          entity_id: >
            {% if is_state('input_boolean.guests', 'on') %}
              input_select.bedroom_light_profile
            {% else %}
              input_select.light_profile
            {% endif %}

  - alias: resume_sleep_action
    initial_state: true
    trigger:
      platform: state
      entity_id: input_select.sleep_state
      to: 'sleeping'
      from: 'paused'
    action:
      - service: input_select.select_option
        data_template:
          option: 'Off'
          entity_id: >
            {% if is_state('input_boolean.guests', 'on') %}
              input_select.bedroom_light_profile
            {% else %}
              input_select.light_profile
            {% endif %}

  - alias: alarm_action
    initial_state: true
    trigger:
      platform: state
      entity_id: input_select.sleep_state
      to: 'alarm'
    action:
      - service: input_select.select_option
        data_template:
          option: 'Ambient'
          entity_id: >
            {% if is_state('input_boolean.guests', 'on') %}
              input_select.bedroom_light_profile
            {% else %}
              input_select.light_profile
            {% endif %}
      - service: input_select.select_option
        data:
          entity_id: input_select.playlist_player
          option: 'media_player.bedroom_speaker'
      - service: input_select.set_options
        data_template:
          entity_id: input_select.playlist
          options:
            - "http://ice1.somafm.com/poptron-128-aac"
            - "==END=="
      - delay:
          seconds: 2
      - service: media_player.volume_set
        data_template:
          entity_id: 'media_player.bedroom_speaker'
          volume_level: 0.25

  - alias: snoozing_action
    initial_state: true
    trigger:
      platform: state
      entity_id: input_select.sleep_state
      to: 'snoozing'
      from: 'alarm'
    action:
      - service: input_select.select_option
        data_template:
          option: 'Ambient'
          entity_id: >
            {% if is_state('input_boolean.guests', 'on') %}
              input_select.bedroom_light_profile
            {% else %}
              input_select.light_profile
            {% endif %}

  - alias: waking_action
    initial_state: true
    trigger:
      platform: state
      entity_id: input_select.sleep_state
      to: 'waking'
    action:
      - service: input_select.select_option
        data_template:
          option: 'Dimmed'
          entity_id: >
            {% if is_state('input_boolean.guests', 'on') %}
              input_select.bedroom_light_profile
            {% else %}
              input_select.light_profile
            {% endif %}
      - service: input_select.select_option
        data:
          entity_id: input_select.playlist_player
          option: 'media_player.bedroom_speaker'
      - service: input_select.set_options
        data_template:
          entity_id: input_select.playlist
          options:
            - "==SCRIPT==morning_briefing"
            - "{{ states.sensor.podcast_bbc_minute.state }}"
            - "{{ states.sensor.podcast_24syv_nyheder.state }}"
            - "http://ice1.somafm.com/poptron-128-aac"
            - "==END=="
      - delay:
          seconds: 2
      - service: media_player.volume_set
        data_template:
          entity_id: 'media_player.bedroom_speaker'
          volume_level: 0.25

  - alias: slow_waking_action
    initial_state: true
    trigger:
      platform: state
      entity_id: input_select.sleep_state
      to: 'waking'
      for:
        minutes: 15
    action:
      - service: input_select.select_option
        data_template:
          option: 'Default'
          entity_id: >
            {% if is_state('input_boolean.guests', 'on') %}
              input_select.bedroom_light_profile
            {% else %}
              input_select.light_profile
            {% endif %}

  - alias: awake_activity
    initial_state: true
    trigger:
      platform: state
      entity_id: input_select.sleep_state
      to: 'awake'
      from: 'waking'
    action:
      - service: input_select.select_option
        data_template:
          option: 'Default'
          entity_id: >
            {% if is_state('input_boolean.guests', 'on') %}
              input_select.bedroom_light_profile
            {% else %}
              input_select.light_profile
            {% endif %}
      - service: joaoapps_join.phone_send_tasker
        data:
          command: "sleep_tracking_stop"
      - service: input_select.select_option
        data:
          entity_id: input_select.playlist_player
          option: 'media_player.east_side_speakers'
      - delay:
          seconds: 1
      - service: input_select.set_options
        data_template:
          entity_id: input_select.playlist
          options:
            - "==SCRIPT==morning_briefing"
            - "{{ states.sensor.podcast_bbc_minute.state }}"
            - "{{ states.sensor.podcast_daily_tech_news_show.state }}"
            - "http://ice1.somafm.com/poptron-128-aac"
            - "==END=="
      - delay:
          seconds: 2
      - service: media_player.volume_set
        data_template:
          entity_id: 'media_player.east_side_speakers'
          volume_level: 0.5
