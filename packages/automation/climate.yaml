binary_sensor:
  - platform: template
    sensors:
      thermostats_night_mode:
        friendly_name: "Termostater Nattilstand"
        entity_id: input_boolean.bedtime
        value_template: >
          {{ is_state('input_boolean.bedtime', 'on') }}

      thermostats_on:
        friendly_name: "Termostater Tændt"
        entity_id: 
          - binary_sensor.martin_presence_delayed
          - binary_sensor.martin_home_soon
        value_template: >
          {{ (is_state('binary_sensor.martin_presence_delayed', 'on') or is_state('binary_sensor.martin_home_soon', 'on')) }}

automation:
  - alias: Termostat Badeværelse
    trigger:
      - platform: state
        entity_id:
          - binary_sensor.thermostats_on
          - binary_sensor.thermostats_night_mode
          - binary_sensor.badevaerelse_vindue
          - binary_sensor.bathroom_activity
      - platform: state
        entity_id: binary_sensor.home_assistant_loaded
        to: 'on'
    action:
      - service_template: |
          {%- if is_state('binary_sensor.badevaerelse_vindue', 'off') -%}
            climate.turn_on
          {%- else -%}
            climate.turn_off
          {%- endif -%}
        data:
          entity_id: climate.badevaerelse
      - service: climate.set_temperature
        data_template:
          entity_id: climate.badevaerelse
          temperature: |
            {%- set on = is_state('binary_sensor.thermostats_on', 'on') -%}
            {%- set night = is_state('binary_sensor.thermostats_night_mode', 'on') -%}
            {%- set extended = is_state('binary_sensor.martin_presence_extended', 'on') -%}
            {%- set active = is_state('binary_sensor.bathroom_activity', 'on') -%}

            {% if on %}
              {% if active %}
                23
              {% elif night %}
                19
              {% else %}
                21
              {% endif %}
            {% elif extended %}
              18
            {% else %}
              15
            {% endif %}

  - alias: Termostat Kontor
    trigger:
      - platform: state
        entity_id:
          - binary_sensor.thermostats_on
          - binary_sensor.thermostats_night_mode
          - binary_sensor.martin_pc
          - binary_sensor.working_from_home
      - platform: state
        entity_id: binary_sensor.home_assistant_loaded
        to: 'on'
    action:
      - service: climate.turn_on
        data:
          entity_id: climate.kontor
      - service: climate.set_temperature
        data_template:
          entity_id: climate.kontor
          temperature: |
            {%- set on = is_state('binary_sensor.thermostats_on', 'on') -%}
            {%- set night = is_state('binary_sensor.thermostats_night_mode', 'on') -%}
            {%- set extended = is_state('binary_sensor.martin_presence_extended', 'on') -%}
            {%- set active = is_state('binary_sensor.martin_pc', 'on') or is_state('binary_sensor.working_from_home', 'on') -%}

            {% if on %}
              {% if night %}
                19
              {% elif active %}
                23
              {% else %}
                21
              {% endif %}
            {% elif extended %}
              18
            {% else %}
              15
            {% endif %}

  - alias: Termostat Stue
    trigger:
      - platform: state
        entity_id:
          - binary_sensor.thermostats_on
          - binary_sensor.thermostats_night_mode
          - device_tracker.sony_stue_tv
      - platform: state
        entity_id: binary_sensor.home_assistant_loaded
        to: 'on'
    action:
      - service: climate.turn_on
        data:
          entity_id: climate.stue
      - service: climate.set_temperature
        data_template:
          entity_id: climate.stue
          temperature: |
            {%- set on = is_state('binary_sensor.thermostats_on', 'on') -%}
            {%- set night = is_state('binary_sensor.thermostats_night_mode', 'on') -%}
            {%- set extended = is_state('binary_sensor.martin_presence_extended', 'on') -%}
            {%- set active = is_state('device_tracker.sony_stue_tv', 'home') -%}

            {% if on %}
              {% if night %}
                19
              {% elif active %}
                23
              {% else %}
                21
              {% endif %}
            {% elif extended %}
              18
            {% else %}
              15
            {% endif %}

  - alias: Termostat Køkken
    trigger:
      - platform: state
        entity_id:
          - binary_sensor.thermostats_on
          - binary_sensor.thermostats_night_mode
      - platform: state
        entity_id: binary_sensor.home_assistant_loaded
        to: 'on'
    action:
      - service: climate.turn_on
        data:
          entity_id: climate.kokken
      - service: climate.set_temperature
        data_template:
          entity_id: climate.kokken
          temperature: |
            {%- set on = is_state('binary_sensor.thermostats_on', 'on') -%}
            {%- set night = is_state('binary_sensor.thermostats_night_mode', 'on') -%}
            {%- set extended = is_state('binary_sensor.martin_presence_extended', 'on') -%}

            {% if on %}
              {% if night %}
                19
              {% else %}
                21
              {% endif %}
            {% elif extended %}
              18
            {% else %}
              15
            {% endif %}

  - alias: Termostat Soveværelse
    trigger:
      - platform: state
        entity_id:
          - binary_sensor.thermostats_on
          - binary_sensor.thermostats_night_mode
      - platform: state
        entity_id: binary_sensor.home_assistant_loaded
        to: 'on'
    action:
      - service: climate.turn_on
        data:
          entity_id: climate.sovevaerelse
      - service: climate.set_temperature
        data_template:
          entity_id: climate.sovevaerelse
          temperature: |
            {%- set on = is_state('binary_sensor.thermostats_on', 'on') -%}
            {%- set night = is_state('binary_sensor.thermostats_night_mode', 'on') -%}
            {%- set extended = is_state('binary_sensor.martin_presence_extended', 'on') -%}

            {% if on %}
              {% if night %}
                22
              {% else %}
                21
              {% endif %}
            {% elif extended %}
              18
            {% else %}
              15
            {% endif %}
