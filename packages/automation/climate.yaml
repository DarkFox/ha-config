binary_sensor:
  - platform: template
    sensors:
      thermostats_night_mode:
        friendly_name: "Termostater Nattilstand"
        entity_id: input_select.sleep_state
        value_template: >
          {{
            is_state('input_select.sleep_state', 'bedtime')
            or is_state('input_select.sleep_state', 'in bed')
            or is_state('input_select.sleep_state', 'sleeping')
            or is_state('input_select.sleep_state', 'paused')
          }}

      thermostats_on:
        friendly_name: "Termostater Tændt"
        entity_id: 
          - binary_sensor.martin_presence_delayed
          - binary_sensor.martin_home_soon
        value_template: >
          {{ (is_state('binary_sensor.martin_presence_delayed', 'on') or is_state('binary_sensor.martin_home_soon', 'on')) }}

automation:
  - alias: Termostat Badeværelse
    trigger:
      - platform: state
        entity_id:
          - binary_sensor.thermostats_on
          - binary_sensor.thermostats_night_mode
          - binary_sensor.badevaerelse_vindue
          - binary_sensor.bathroom_activity
          # - sensor.toilet_mold_indicator
          - binary_sensor.martin_presence_extended
      - platform: state
        entity_id: binary_sensor.home_assistant_loaded
        to: 'on'
    action:
      - service_template: |
          {%- if is_state('binary_sensor.badevaerelse_vindue', 'off') -%}
            climate.turn_on
          {%- else -%}
            climate.turn_off
          {%- endif -%}
        data:
          entity_id: climate.badevaerelse
      - service: climate.set_temperature
        data_template:
          entity_id: climate.badevaerelse
          temperature: |
            {%- set on = is_state('binary_sensor.thermostats_on', 'on') -%}
            {%- set night = is_state('binary_sensor.thermostats_night_mode', 'on') -%}
            {%- set extended = is_state('binary_sensor.martin_presence_extended', 'on') -%}
            {%- set active = is_state('binary_sensor.bathroom_activity', 'on') -%}
            
            {%- set critical_temp = state_attr('sensor.toilet_mold_indicator','estimated_critical_temp')|float|round(0, "ceil") -%}
            {%- set target_temp = 15 -%}
            
            {%- if on -%}
              {%- if active -%}
                {%- set target_temp = 23 -%}
              {%- elif night -%}
                {%- set target_temp = 19 -%}
              {%- else -%}
                {%- set target_temp = 21 -%}
              {%- endif -%}
            {%- elif extended -%}
              {%- set target_temp = 18 -%}
            {%- else -%}
              {%- set target_temp = 15 -%}
            {%- endif -%}            
            {#%- if target_temp < (critical_temp) -%#}
              {#{ set target_temp = critical_temp }#}
            {#%- endif -%#}
            {{ target_temp }}


  - alias: Termostat Kontor
    trigger:
      - platform: state
        entity_id:
          - binary_sensor.thermostats_on
          - binary_sensor.thermostats_night_mode
          - binary_sensor.martin_pc
          - binary_sensor.working_from_home
          - binary_sensor.martin_presence_extended
          - sensor.season
      - platform: state
        entity_id: binary_sensor.home_assistant_loaded
        to: 'on'
    action:
      - service: climate.turn_on
        data:
          entity_id: climate.kontor
      - service: climate.set_temperature
        data_template:
          entity_id: climate.kontor
          temperature: |
            {%- set on = is_state('binary_sensor.thermostats_on', 'on') -%}
            {%- set night = is_state('binary_sensor.thermostats_night_mode', 'on') -%}
            {%- set summer = is_state('sensor.season', 'summer') -%}
            {%- set extended = is_state('binary_sensor.martin_presence_extended', 'on') -%}
            {%- set active = is_state('binary_sensor.martin_pc', 'on') or is_state('binary_sensor.working_from_home', 'on') -%}

            {% if on %}
              {% if night or summer %}
                18
              {% elif active %}
                22
              {% else %}
                20
              {% endif %}
            {% elif extended %}
              18
            {% else %}
              15
            {% endif %}

  - alias: Termostat Stue
    trigger:
      - platform: state
        entity_id:
          - binary_sensor.thermostats_on
          - binary_sensor.thermostats_night_mode
          - device_tracker.sony_tv
          - binary_sensor.martin_presence_extended
          - sensor.season
      - platform: state
        entity_id: binary_sensor.home_assistant_loaded
        to: 'on'
    action:
      - service: climate.turn_on
        data:
          entity_id: climate.stue
      - service: climate.set_temperature
        data_template:
          entity_id: climate.stue
          temperature: |
            {%- set on = is_state('binary_sensor.thermostats_on', 'on') -%}
            {%- set night = is_state('binary_sensor.thermostats_night_mode', 'on') -%}
            {%- set summer = is_state('sensor.season', 'summer') -%}
            {%- set extended = is_state('binary_sensor.martin_presence_extended', 'on') -%}
            {%- set active = is_state('device_tracker.sony_tv', 'home') -%}

            {% if on %}
              {% if night or summer %}
                18
              {% elif active %}
                22
              {% else %}
                20
              {% endif %}
            {% elif extended %}
              18
            {% else %}
              15
            {% endif %}

  - alias: Termostat Køkken
    trigger:
      - platform: state
        entity_id:
          - binary_sensor.thermostats_on
          - binary_sensor.thermostats_night_mode
          - binary_sensor.martin_presence_extended
          - binary_sensor.kitchen_activity
          - sensor.season
      - platform: state
        entity_id: binary_sensor.home_assistant_loaded
        to: 'on'
    action:
      - service: climate.turn_on
        data:
          entity_id: climate.kokken
      - service: climate.set_temperature
        data_template:
          entity_id: climate.kokken
          temperature: |
            {%- set on = is_state('binary_sensor.thermostats_on', 'on') -%}
            {%- set night = is_state('binary_sensor.thermostats_night_mode', 'on') -%}
            {%- set summer = is_state('sensor.season', 'summer') -%}
            {%- set extended = is_state('binary_sensor.martin_presence_extended', 'on') -%}
            {%- set active = is_state('binary_sensor.kitchen_activity', 'on') -%}

            {% if on %}
              {% if night or summer %}
                18
              {% elif active %}
                22
              {% else %}
                20
              {% endif %}
            {% elif extended %}
              18
            {% else %}
              15
            {% endif %}

  - alias: Termostat Soveværelse
    trigger:
      - platform: state
        entity_id:
          - binary_sensor.thermostats_on
          - binary_sensor.thermostats_night_mode
          - input_select.sleep_state
          - binary_sensor.martin_presence_extended
          - sensor.season
      - platform: state
        entity_id: binary_sensor.home_assistant_loaded
        to: 'on'
    action:
      - service: climate.turn_on
        data:
          entity_id: climate.sovevaerelse
      - service: climate.set_temperature
        data_template:
          entity_id: climate.sovevaerelse
          temperature: |
            {%- set on = is_state('binary_sensor.thermostats_on', 'on') -%}
            {%- set night = is_state('binary_sensor.thermostats_night_mode', 'on') -%}
            {%- set summer = is_state('sensor.season', 'summer') -%}
            {%- set extended = is_state('binary_sensor.martin_presence_extended', 'on') -%}
            {%- set sleeping = is_state('input_select.sleep_state', 'sleeping') -%}

            {% if on %}
              {% if sleeping or summer %}
                18
              {% elif night %}
                22
              {% else %}
                20
              {% endif %}
            {% elif extended %}
              18
            {% else %}
              15
            {% endif %}
