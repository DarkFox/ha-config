binary_sensor:
  - platform: template
    sensors:
      thermostats_night_mode:
        friendly_name: "Termostater Nattilstand"
        entity_id: sensor.time
        value_template: >
          {% if now().hour >= 21 and is_state('binary_sensor.workday_tomorrow', 'on') -%}
            True
          {% elif now().hour >= 23 and is_state('binary_sensor.workday_tomorrow', 'off') -%}
            True
          {% elif now().hour <= 7 -%}
            True
          {% else %}
            False
          {% endif %}

      thermostats_on:
        friendly_name: "Termostater TÃ¦ndt"
        entity_id: 
          - binary_sensor.martin_presence_delayed
        value_template: >
          {% if is_state('binary_sensor.martin_presence_delayed', 'on') or is_state('binary_sensor.martin_home_soon', 'on') -%}
            True
          {% else %}
            False
          {% endif %}

automation:
  - alias: Thermostat Night Mode
    trigger:
      - platform: event
        event_type: sleep_as_android
        event_data:
          value: time_to_bed_alarm_alert
    #   - platform: state
    #     entity_id: binary_sensor.thermostats_night_mode
    #     to: 'on'
    #   - platform: state
    #     entity_id: binary_sensor.home_assistant_loaded
    #     to: 'on'
    # condition:
    #   condition: state
    #   entity_id: binary_sensor.thermostats_night_mode
    #   state: 'on'
    action:
      - service: climate.set_temperature
        data:
          entity_id: climate.badevaerelse
          temperature: 21
      - service: climate.set_temperature
        data:
          entity_id: climate.kontor
          temperature: 15
      - service: climate.set_temperature
        data:
          entity_id: climate.stue
          temperature: 15
      - service: climate.set_temperature
        data:
          entity_id: climate.kokken
          temperature: 19
      - service: climate.set_temperature
        data:
          entity_id: climate.sovevaerelse
          temperature: 19

  - alias: Thermostat Day Mode
    trigger:
      - platform: event
        event_type: sleep_as_android
        event_data:
          value: smart_period
    #   - platform: state
    #     entity_id: binary_sensor.thermostats_night_mode
    #     to: 'off'
    #   - platform: state
    #     entity_id: binary_sensor.home_assistant_loaded
    #     to: 'on'
    # condition:
    #   condition: state
    #   entity_id: binary_sensor.thermostats_night_mode
    #   state: 'off'
    action:
      - service: climate.set_temperature
        data:
          entity_id: climate.badevaerelse
          temperature: 23
      - service: climate.set_temperature
        data:
          entity_id: climate.kontor
          temperature: 21
      - service: climate.set_temperature
        data:
          entity_id: climate.stue
          temperature: 21
      - service: climate.set_temperature
        data:
          entity_id: climate.kokken
          temperature: 21
      - service: climate.set_temperature
        data:
          entity_id: climate.sovevaerelse
          temperature: 21

  - alias: Turn off heating when away
    initial_state: true
    trigger:
      - platform: state
        entity_id: binary_sensor.thermostats_on
        from: 'on'
        to: 'off'
    action:
      - service: homeassistant.turn_off
        data_template:
          entity_id: group.thermostats

  - alias: Turn on heating when back
    initial_state: true
    trigger:
      - platform: state
        entity_id: binary_sensor.thermostats_on
        from: 'off'
        to: 'on'
    action:
      - service: homeassistant.turn_on
        data_template:
          entity_id: group.thermostats

  - alias: turn_off_bathroom_heating_with_window_open
    initial_state: true
    trigger:
      - platform: state
        entity_id: binary_sensor.badevaerelse_vindue
        from: 'off'
        to: 'on'
    action:
      - service: climate.turn_off
        data:
          entity_id: climate.badevaerelse

  - alias: turn_on_bathroom_heating_with_window_closed
    initial_state: true
    trigger:
      - platform: state
        entity_id: binary_sensor.badevaerelse_vindue
        from: 'on'
        to: 'off'
    action:
      - service: climate.turn_on
        data:
          entity_id: climate.badevaerelse
