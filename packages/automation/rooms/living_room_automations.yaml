input_boolean:
  living_room_door_activity:
    initial: off
    name: Stue Dør Aktivitet
  bar_open:
    name: Bar Åben

switch:
  - platform: template
    switches:
      living_room_curtain_automations:
        friendly_name: Stue Gardiner Automatisering
        icon_template: mdi:curtains
        value_template: "{{ is_state('automation.living_room_curtains_open_at_sunup', 'on') or is_state('automation.living_room_curtains_close_at_sundown', 'on') }}"
        turn_on:
          service: automation.turn_on
          target:
            entity_id:
              - automation.living_room_curtains_open_at_sunup
              - automation.living_room_curtains_close_at_sundown
        turn_off:
          service: automation.turn_off
          target:
            entity_id:
              - automation.living_room_curtains_open_at_sunup
              - automation.living_room_curtains_close_at_sundown

binary_sensor:
  - platform: template
    sensors:
      living_room_door_activity:
        friendly_name: Stue Dør Aktivitet
        device_class: motion
        value_template: "{{ is_state('input_boolean.living_room_door_activity', 'on') }}"
      living_room_occupied:
        friendly_name: Stue Optaget
        device_class: occupancy
        value_template: "{{ is_state('input_boolean.living_room_occupied', 'on') }}"

script:
  stue_gardin_aabn_dor:
    alias: "Åbn stue gardin ved dør"
    sequence:
      - service: cover.set_cover_position
        target:
          entity_id: cover.stue_gardin_venstre
        data:
          position: 55

automation:
  - id: living_room_curtains_open_at_sunup
    alias: living_room_curtains_open_at_sunup
    trigger:
      - platform: state
        entity_id: sun.sun
        to: above_horizon
      - platform: state
        entity_id: binary_sensor.martin_presence
        to: "on"
    condition:
      - condition: state
        entity_id: sun.sun
        state: above_horizon
      - condition: state
        entity_id: binary_sensor.martin_presence
        state: "on"
    action:
      - service: cover.open_cover
        entity_id: cover.stue_gardin

  - id: living_room_curtains_close_at_sundown
    alias: living_room_curtains_close_at_sundown
    trigger:
      - platform: state
        entity_id: sun.sun
        to: below_horizon
      - platform: numeric_state
        entity_id: sensor.altan_lysstyrke
        below: 3
    condition:
      - condition: state
        entity_id: sun.sun
        state: below_horizon
      - condition: numeric_state
        entity_id: sensor.altan_lysstyrke
        below: 3
    action:
      - alias: "Don't close curtain on open balcony door"
        choose:
          - conditions:
              - alias: "Balcony Door Open"
                condition: state
                entity_id: binary_sensor.stue_altandor
                state: "on"
            sequence:
              - service: cover.close_cover
                entity_id: cover.stue_gardin_hojre
              - service: cover.set_cover_position
                target:
                  entity_id: cover.stue_gardin_venstre
                data:
                  position: 55
        default:
          - service: cover.close_cover
            entity_id: cover.stue_gardin

  - alias: bar_switch_on
    initial_state: true
    trigger:
      - platform: event
        event_type: deconz_event
        event_data:
          id: bar_fjernbetjening
          event: 1002
    action:
      - service: input_boolean.turn_on
        target:
          entity_id: input_boolean.bar_open

  - alias: bar_switch_off
    initial_state: true
    trigger:
      - platform: event
        event_type: deconz_event
        event_data:
          id: bar_fjernbetjening
          event: 2002
    action:
      - service: input_boolean.turn_off
        target:
          entity_id: input_boolean.bar_open

  - alias: Bar åbnet
    initial_state: true
    trigger:
      - platform: state
        entity_id: input_boolean.bar_open
        to: "on"
    action:
      - event: refresh_light_profile
      - service: input_boolean.turn_on
        target:
          entity_id: input_boolean.ismaskine

  - alias: Bar lukket
    initial_state: true
    trigger:
      - platform: state
        entity_id: input_boolean.bar_open
        to: "off"
    action:
      - event: refresh_light_profile
      - service: input_boolean.turn_off
        target:
          entity_id: input_boolean.ismaskine

  - id: bar_close_timeout
    alias: "Bar luk ved idle"
    trigger:
      - platform: state
        entity_id: binary_sensor.living_room_activity
        to: "off"
        for:
          hours: 4
    action:
      - service: input_boolean.turn_off
        target:
          entity_id: input_boolean.bar_open

  - id: living_room_balcony_door_open_reminder
    alias: living_room_balcony_door_open_reminder
    trigger:
      - platform: state
        entity_id: sensor.living_room_activity_state
        to: "off"
        for:
          minutes: 15
    condition:
      - alias: "Balcony door open"
        condition: state
        entity_id: binary_sensor.stue_altandor
        state: "on"
      - alias: "Outside temp below 18"
        condition: numeric_state
        entity_id: sensor.altan_temperatur
        below: 18
    action:
      - service: script.notify_everywhere
        data:
          message: Stue altandør står åben!
