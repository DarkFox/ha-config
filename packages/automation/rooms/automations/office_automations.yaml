input_boolean:
  office_door_activity:
    initial: off
    name: Kontor Dør Aktivitet

switch:
  - platform: template
    switches:
      office_curtain_automations:
        friendly_name: Kontor Gardiner Automatisering
        icon_template: "{{ state_attr('binary_sensor.office_blinds_auto_open', 'icon') | default('mdi:curtains-closed') }}"
        value_template: "{{ is_state('automation.kontor_gardiner_automatisering', 'on') }}"
        turn_on:
          - action: automation.turn_on
            target:
              entity_id:
                - automation.kontor_gardiner_automatisering
          - action: automation.trigger
            target:
              entity_id:
                - automation.kontor_gardiner_automatisering
        turn_off:
          action: automation.turn_off
          target:
            entity_id:
              - automation.kontor_gardiner_automatisering

binary_sensor:
  - platform: template
    sensors:
      office_door_activity:
        friendly_name: Kontor Dør Aktivitet
        device_class: motion
        delay_off:
          seconds: 30
        value_template: "{{ is_state('input_boolean.office_door_activity', 'on') }}"

template:
  - binary_sensor:
      - name: "Office Blinds Open Time Window"
        unique_id: a2df346f-583a-4acf-aa75-f7baf45daf3a
        icon: mdi:window-open-variant
        state: >-
          {% set BRIGHT_PREOPEN = 50 %}
          {% set daylight = is_state('binary_sensor.daylight','on') %}
          {% set sun_up   = is_state('sun.sun','above_horizon') %}
          {% set bright   = states('sensor.average_office_balcony_brightness')|float(0) > BRIGHT_PREOPEN %}
          {{ daylight or (not sun_up and bright) }}

      - name: "Office Glare Now"
        unique_id: 0a1dfb48-9cc5-40b8-9054-00c1b551571e
        icon: mdi:weather-sunny-alert
        device_class: problem
        state: >-
          {% set daylight   = is_state('binary_sensor.daylight','on') %}
          {% set elevation  = states('sensor.sun_elevation')|float(0) %}
          {% set bright     = states('sensor.average_office_balcony_brightness')|float(0) %}
          {% set was_on     = is_state('binary_sensor.office_glare_now','on') %}

          {# Treat low sun as more likely to cause reflections #}
          {% set LOW_ELEV = -3 %}
          {% set HIGH_ELEV = 25 %}
          {% set low_angle = LOW_ELEV <= elevation <= HIGH_ELEV %}

          {# Slightly easier to trigger within evening hours #}
          {% set hhmm = now().strftime('%H:%M') %}
          {% set evening = '16:00' <= hhmm <= '20:30' %}

          {# Hysteresis thresholds (lux) #}
          {% set ON_MAIN  = 4200 %}
          {% set OFF_MAIN = 3600 %}
          {% set ON_EVE   = 3800 %}
          {% set OFF_EVE  = 3300 %}
          {% set on_th  = ON_EVE  if evening else ON_MAIN %}
          {% set off_th = OFF_EVE if evening else OFF_MAIN %}

          {% set bright_trigger = (bright > on_th) or (was_on and bright > off_th) %}

          {{ daylight and low_angle and bright_trigger }}

      - name: "Office Blinds Auto Open"
        unique_id: 254b3f93-7c22-46b6-973b-3e73ba5ba953
        device_class: opening
        state: >-
          {% set windowok = is_state('binary_sensor.office_blinds_open_time_window','on') %}
          {% set glare    = is_state('binary_sensor.office_glare_now','on') %}
          {{ windowok and (not glare) }}
        attributes:
          icon: >-
            {{
              'mdi:blinds' if is_state('binary_sensor.office_blinds_auto_open', 'on')
              else 'mdi:roller-shade-closed'
            }}

automation:
  - alias: Kontor Gardiner Automatisering
    id: 202e827a-1c17-4941-b4ea-86598ef1a8d0
    mode: single
    triggers:
      - trigger: state
        entity_id: binary_sensor.office_blinds_auto_open
        to: "on"
        for: "00:02:00"
      - trigger: state
        entity_id: binary_sensor.office_blinds_auto_open
        to: "off"
        for: "00:03:00"
    actions:
      - action: >-
          {% set open = states('binary_sensor.office_blinds_auto_open') %}
          {% if open == 'on' %}
            cover.open_cover
          {% elif open == 'off' %}
            cover.close_cover
          {% endif %}
        target:
          entity_id:
            - cover.kontor_rullegardin
            - cover.kontor_altandor_gardin
      - delay: "00:03:00"

  - id: office_balcony_door_open_reminder
    alias: office_balcony_door_open_reminder
    triggers:
      - trigger: state
        entity_id: sensor.office_activity_state
        to: "off"
        for:
          minutes: 15
    conditions:
      - alias: "Balcony door open"
        condition: state
        entity_id: binary_sensor.kontor_altandor
        state: "on"
      - alias: "Outside temp below 18"
        condition: numeric_state
        entity_id: sensor.kontor_altan_temperatur
        below: 18
    actions:
      - action: script.notify_everywhere
        data:
          message: Kontor altandør står åben!
