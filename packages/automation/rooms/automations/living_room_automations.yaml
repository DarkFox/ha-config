input_boolean:
  living_room_door_activity:
    initial: off
    name: Stue Dør Aktivitet
  bar_open:
    name: Bar Åben

switch:
  - platform: template
    switches:
      living_room_curtain_automations:
        friendly_name: Stue Gardiner Automatisering
        icon_template: "{{ state_attr('binary_sensor.living_room_curtains_auto_open', 'icon') | default('mdi:curtains-closed') }}"
        value_template: "{{ is_state('automation.stue_gardiner_automatisering', 'on') }}"
        turn_on:
          - action: automation.turn_on
            target:
              entity_id:
                - automation.stue_gardiner_automatisering
          - action: automation.trigger
            target:
              entity_id:
                - automation.stue_gardiner_automatisering
        turn_off:
          action: automation.turn_off
          target:
            entity_id:
              - automation.stue_gardiner_automatisering

binary_sensor:
  - platform: template
    sensors:
      living_room_door_activity:
        friendly_name: Stue Dør Aktivitet
        device_class: motion
        delay_off:
          seconds: 30
        value_template: "{{ is_state('input_boolean.living_room_door_activity', 'on') }}"

template:
  - binary_sensor:
      - name: "Living Room Curtain Open Time Window"
        unique_id: 6ab0a5c6-9c71-4d3f-8d7e-8a8f83c5df10
        icon: mdi:window-open-variant
        state: >-
          {{ is_state('binary_sensor.daylight','on') or is_state('binary_sensor.sunset_grace_active','on') }}

      - name: "Sun Angle Hitting Living Room Windows"
        unique_id: 91863ab7-b365-41ca-9d7e-edccccd2cc2f
        icon: >-
          {% if is_state('binary_sensor.sun_angle_hitting_living_room_windows', 'on') %}
            mdi:sun-angle
          {% else %}
            mdi:sun-angle-outline
          {% endif %}
        device_class: problem
        state: >-
          {% set HIT_START   = 160  %}   {# ≈ 10° east of due south #}
          {% set HIT_END     = 320  %}   {# ≈ north-north-west     #}
          {% set ELEV_ABOVE  = 30   %}   {# Balcony shades above this elevation #}
          {% set azimuth  = states('sensor.sun_azimuth')|float(0) %}
          {% set elevation = states('sensor.sun_elevation')|float(0) %}
          {% set sun_hits_by_azimuth   = HIT_START <= azimuth <= HIT_END %}
          {% set sun_hits_by_elevation = elevation <= ELEV_ABOVE %}
          {{ sun_hits_by_azimuth and sun_hits_by_elevation }}

      - name: "Sun Brightness Hitting Living Room Windows"
        unique_id: 707d20a6-653f-466e-ac9e-2e1715eb297a
        icon: >-
          {% if is_state('binary_sensor.sun_brightness_hitting_living_room_windows', 'on') %}
            mdi:brightness-7
          {% else %}
            mdi:brightness-5
          {% endif %}
        device_class: problem
        state: >-
          {% set BRIGHT_CLOSE = 4500 %}  {# go ON above this #}
          {% set BRIGHT_OPEN  = 3800 %}  {# go OFF below this (hysteresis) #}
          {% set bright = states('sensor.average_living_room_balcony_brightness')|float(0) %}
          {% set angle_on = is_state('binary_sensor.sun_angle_hitting_living_room_windows', 'on') %}

          {% set was_on = is_state('binary_sensor.sun_brightness_hitting_living_room_windows', 'on') %}
          {% if angle_on %}
            {% if was_on %}
              {{ bright > BRIGHT_OPEN }}     {# stay ON until we drop below OPEN threshold #}
            {% else %}
              {{ bright > BRIGHT_CLOSE }}    {# turn ON only above CLOSE threshold #}
            {% endif %}
          {% else %}
            false
          {% endif %}

      - name: "Living Room Night"
        unique_id: bd5d0692-7039-48e3-bd44-79c9361331d3
        icon: mdi:weather-night
        device_class: problem
        state: >-
          {% set BRIGHT_MIN = 30 %}
          {% set bright = states('sensor.average_living_room_balcony_brightness')|float(0) %}
          {% set daylight = is_state('binary_sensor.daylight','on') %}
          {{ (not daylight) and (bright < BRIGHT_MIN) }}

      - name: "Living Room Curtains Auto Open"
        unique_id: a2adc8ab-a57b-4efb-86cf-25129566fd00
        device_class: opening
        state: >-
          {% set head_avoidance = is_state('binary_sensor.heat_avoidance_season', 'on') %}
          {% set open_window = is_state('binary_sensor.living_room_curtain_open_time_window','on') %}
          {% set bright_sun_hits = is_state('binary_sensor.sun_brightness_hitting_living_room_windows', 'on') %}
          {% set night = is_state('binary_sensor.living_room_night', 'on') %}

          {# Policy:
              - In late spring, summer, and early autumn: CLOSE when the bright sun is hitting; otherwise OPEN.
              - In other seasons: OPEN when allowed by open_window (daylight/grace), CLOSE at night.
              - Never OPEN if open_window is false (prevents post-grace reopening at night).
          #}

          {% if not open_window %}
            false
          {% else %}
            {% if head_avoidance %}
              {{ not bright_sun_hits and not night }}
            {% else %}
              {{ not night }}
            {% endif %}
          {% endif %}
        attributes:
          icon: >-
            {{ 
              'mdi:curtains' if is_state('binary_sensor.living_room_curtains_auto_open', 'on')
              else 'mdi:curtains-closed'
            }}

automation:
  - id: close_bar_after_no_activity
    alias: Close bar after 4 hours with no activity
    triggers:
      - trigger: state
        entity_id: binary_sensor.stue_tilstedevarelse_bar
        to: "off"
        for:
          hours: 4
    conditions:
      - condition: state
        entity_id: input_boolean.bar_open
        state: "on"
    actions:
      - action: input_boolean.turn_off
        target:
          entity_id: input_boolean.bar_open

  - alias: Stue Gardiner Automatisering
    id: 22f774d8-6463-4115-84b0-2f5529326a79
    mode: single
    triggers:
      - trigger: state
        entity_id: binary_sensor.living_room_curtains_auto_open
        to: "on"
        for: "00:03:00"
      - trigger: state
        entity_id: binary_sensor.living_room_curtains_auto_open
        to: "off"
        for: "00:05:00"
    actions:
      - action: >-
          {% set open = states('binary_sensor.living_room_curtains_auto_open') %}
          {% if open == 'on' %}
            cover.open_cover
          {% elif open == 'off' %}
            cover.close_cover
          {% endif %}
        target:
          entity_id:
            - cover.stue_gardin
      - delay: "00:05:00"

  - alias: living_room_curtains_open_balcony_door
    id: 2c0834d8-a4b9-43b3-b085-05565890e98f
    initial_state: true
    triggers:
      - trigger: state
        entity_id: binary_sensor.stue_altandor
        to: "on"
    conditions:
      - condition: state
        entity_id: cover.stue_gardin_venstre
        state: "closed"
    actions:
      - action: script.turn_on
        target:
          entity_id: script.stue_gardin_aabn_dor

  - alias: living_room_curtains_close_balcony_door
    id: fe60b467-8c49-43e1-a4c7-39b69daeaf0d
    initial_state: true
    triggers:
      - trigger: state
        entity_id: binary_sensor.stue_altandor
        to: "off"
        for:
          minutes: 1
    conditions:
      - condition: state
        entity_id: cover.stue_gardin_venstre
        state: "open"
      - condition: state
        entity_id: cover.stue_gardin_hojre
        state: "closed"
    actions:
      - action: cover.close_cover
        target:
          entity_id: cover.stue_gardin_venstre

  - alias: Bar åbnet
    id: d7ce60c1-c867-4ff0-b24b-ee3b2d4500e9
    initial_state: true
    triggers:
      - trigger: state
        entity_id: input_boolean.bar_open
        to: "on"
    actions:
      - event: refresh_light_profile

  - alias: Bar lukket
    id: 909a3888-901a-47fd-9def-fe843c52e610
    initial_state: true
    triggers:
      - trigger: state
        entity_id: input_boolean.bar_open
        to: "off"
    actions:
      - event: refresh_light_profile

  - id: bar_close_timeout
    alias: "Bar luk ved idle"
    triggers:
      - trigger: state
        entity_id: binary_sensor.living_room_activity
        to: "off"
        for:
          hours: 4
    actions:
      - action: input_boolean.turn_off
        target:
          entity_id: input_boolean.bar_open

  - id: living_room_balcony_door_open_reminder
    alias: living_room_balcony_door_open_reminder
    triggers:
      - trigger: state
        entity_id: sensor.living_room_activity_state
        to: "off"
        for:
          minutes: 15
    conditions:
      - alias: "Balcony door open"
        condition: state
        entity_id: binary_sensor.stue_altandor
        state: "on"
      - alias: "Outside temp below 18"
        condition: numeric_state
        entity_id: sensor.altan_temperatur
        below: 18
    actions:
      - action: script.notify_everywhere
        data:
          message: Stue altandør står åben!
