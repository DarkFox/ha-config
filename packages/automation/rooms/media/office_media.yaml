template:
  - switch:
      - default_entity_id: switch.rook_pc
        unique_id: 019b042a-3b15-7221-a014-a981b05a83bc
        name: Rook PC
        icon: mdi:desktop-classic
        state: "{{ states('sensor.pc_afbryder_forbrug') | float(0.0) > 5.0 }}"
        turn_on:
          - choose:
              - conditions:
                  - condition: state
                    entity_id: switch.pc_afbryder
                    state: "on"
                  - condition: state
                    entity_id: switch.rook_pc
                    state: "off"
                sequence:
                  - action: switch.turn_off
                    target:
                      entity_id: switch.pc_afbryder
                  - delay:
                      seconds: 2
          - action: switch.turn_on
            target:
              entity_id: switch.pc_afbryder
        turn_off:
          action: button.press
          target:
            entity_id: button.rook_pc_shutdown

      - default_entity_id: switch.kontor_soundbar_pc_output
        unique_id: 019b042a-3b26-7414-93fe-fb3154dad3f5
        name: Kontor Soundbar PC Output
        icon: mdi:soundbar
        state: "{{ is_state('media_player.kontor', 'on') and state_attr('media_player.kontor', 'source') == 'TV' }}"
        turn_on:
          - choose:
              - conditions:
                  - condition: state
                    entity_id: media_player.kontor
                    state: "off"
                sequence:
                  - action: media_player.turn_on
                    target:
                      entity_id: media_player.kontor
                  - wait_for_trigger:
                      - trigger: state
                        entity_id: media_player.kontor
                        to: "idle"
          - action: media_player.select_source
            target:
              entity_id: media_player.kontor
            data:
              source: TV
          - action: script.set_volume_preset
            data:
              room: "kontor"
              preset: high
        turn_off:
          - action: script.set_volume_preset
            data:
              room: "kontor"
              preset: medium
          - action: media_player.media_stop
            target:
              entity_id: media_player.kontor

      - default_entity_id: switch.kontor_shield_previous
        unique_id: 019b042a-3b41-71da-9044-d8d6e8bb17f2
        name: Kontor Shield Previous
        turn_off:
          - delay:
              seconds: 0
        turn_on:
          - action: media_player.media_previous_track
            target:
              entity_id: media_player.kontor_shield_remote

      - default_entity_id: switch.kontor_shield_next
        unique_id: 019b042a-3b5d-7350-8f6f-388c8a7797be
        name: Kontor Shield Next
        turn_off:
          - delay:
              seconds: 0
        turn_on:
          - action: media_player.media_next_track
            target:
              entity_id: media_player.kontor_shield_remote

      - default_entity_id: switch.kontor_shield_stop
        unique_id: 019b042a-3b87-73cc-8888-95c135f9effc
        name: Kontor Shield Stop
        turn_off:
          - delay:
              seconds: 0
        turn_on:
          - action: remote.send_command
            data:
              command: DPAD_CENTER
            target:
              entity_id: remote.kontor_shield

      - default_entity_id: switch.kontor_shield_play_pause
        unique_id: 019b042a-3bb6-711b-a5c8-39c6338a4bb7
        name: Kontor Shield Play/Pause
        turn_off:
          - delay:
              seconds: 0
        turn_on:
          - action: media_player.media_play_pause
            target:
              entity_id: media_player.kontor_shield_remote

      - default_entity_id: switch.kontor_tv_dark_mode
        unique_id: 019b042a-3bc9-72e2-8645-49c7e3ed551b
        name: "Kontor TV Dark Mode"
        icon: mdi:weather-night
        turn_on:
          - action: script.lg_tv_dark_mode
            data:
              darkMode: true
              entity_id: media_player.kontor_tv
        turn_off:
          - action: script.lg_tv_dark_mode
            data:
              darkMode: false
              entity_id: media_player.kontor_tv

input_select:
  kontor_volume_remote_state:
    initial: "off"
    options:
      - "off"
      - up
      - down

script:
  start_pc_for_remote:
    alias: Start PC for Remote
    sequence:
      - condition: state
        entity_id: switch.rook_pc
        state: "off"
      - action: switch.turn_on
        target:
          entity_id: switch.rook_pc
      - wait_template: "{{ is_state('switch.pc_tilbehor_afbryder', 'on') }}"
        timeout: "00:05:00"
      - action: switch.turn_off
        target:
          entity_id: switch.pc_tilbehor_afbryder

automation:
  - alias: Office PC inactive trigger
    id: 1baf4ea3-3efd-4f60-90dc-50d2f65b24a9
    initial_state: true
    triggers:
      - trigger: template
        value_template: >-
          {{
            is_state('sensor.office_room_state', 'off') 
            and is_state('binary_sensor.rook_pc_activity', 'off')
            and is_state('switch.rook_pc', 'off')
          }}
        for:
          minutes: 5
    conditions:
      - alias: "Quest not in use"
        condition: state
        entity_id: binary_sensor.quest_in_use_delayed
        state: "off"
    actions:
      action: switch.turn_off
      data:
        entity_id: switch.pc_afbryder

  - alias: Office Speaker/PC Accessories active trigger
    id: 25fc64ea-5663-4be4-aa3a-08fb6caf6c6a
    initial_state: true
    triggers:
      trigger: template
      value_template: >-
        {{
          is_state('switch.rook_pc', 'on')
          or is_state('binary_sensor.rook_pc_activity', 'on')
          or is_state('binary_sensor.vagtskema_wfh', 'on')
        }}
    actions:
      action: switch.turn_on
      data:
        entity_id: switch.pc_tilbehor_afbryder

  - alias: Office Speaker/PC Accessories inactive trigger
    id: 79c485f8-79de-47b2-9169-884bc6e020bc
    initial_state: true
    triggers:
      - trigger: template
        value_template: >-
          {{
            is_state('switch.pc_afbryder', 'off')
            and is_state('binary_sensor.rook_pc_activity', 'off')
            and is_state('binary_sensor.vagtskema_wfh', 'off')
            and is_state('binary_sensor.quest_in_use_delayed', 'off')
          }}
    actions:
      action: switch.turn_off
      data:
        entity_id:
          - switch.pc_tilbehor_afbryder
          - switch.printer_afbryder

  - alias: Turn PC Printer on when print queue not empty
    id: e5d8426d-2ded-49af-adf8-6f39e98a9bc2
    initial_state: true
    triggers:
      - trigger: numeric_state
        entity_id: sensor.rook_pc_printers_npid634ed_hpcolorlaserjetm255dw
        above: 0
    conditions:
      - condition: state
        entity_id: switch.printer_afbryder
        state: "off"
    actions:
      - action: switch.turn_on
        target:
          entity_id: switch.printer_afbryder

  - alias: Mute PC TV line in on Office TV off
    id: mute_pc_tv_line_in_on_office_tv_off
    initial_state: true
    triggers:
      - trigger: state
        entity_id:
          - media_player.kontor_tv
          - media_player.kontor_shield_remote
        to: "off"
    actions:
      - action: button.press
        target:
          entity_id: button.rook_pc_mute_tv

  - alias: Unute PC TV line in on Office TV on
    id: unute_pc_tv_line_in_on_office_tv_on
    initial_state: true
    triggers:
      - trigger: state
        entity_id: media_player.kontor_tv
        to: "on"
    actions:
      - action: button.press
        target:
          entity_id: button.rook_pc_unmute_tv

  - alias: Switch Office TV speaker output to internal when PC off
    id: switch_office_tv_speaker_output_to_internal_when_pc_off
    initial_state: true
    triggers:
      - trigger: state
        entity_id: switch.rook_pc
        to: "off"
      - trigger: state
        entity_id: media_player.kontor_tv
        to: "on"
    conditions:
      - condition: state
        entity_id: media_player.kontor_tv
        state: "on"
      - condition: state
        entity_id: switch.rook_pc
        state: "off"
    actions:
      - action: webostv.select_sound_output
        data:
          entity_id: media_player.kontor_tv
          sound_output: "tv_speaker"

  - alias: Switch Office TV Speaker Output to optical when PC on
    id: switch_office_tv_speaker_output_to_optical_when_pc_on
    initial_state: true
    triggers:
      - trigger: state
        entity_id: switch.rook_pc
        to: "on"
      - trigger: state
        entity_id: media_player.kontor_tv
        to: "on"
    conditions:
      - condition: state
        entity_id: media_player.kontor_tv
        state: "on"
      - condition: state
        entity_id: switch.rook_pc
        state: "on"
    actions:
      - action: webostv.select_sound_output
        data:
          entity_id: media_player.kontor_tv
          sound_output: "external_optical"
