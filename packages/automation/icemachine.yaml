sensor:
  - platform: template
    sensors:
      icemachine_state:
        friendly_name: "Ismaskine Status"
        value_template: >-
          {% set watts = states('sensor.ismaskine_afbryder_forbrug')|int %}
          {% if is_state('sensor.ismaskine_afbryder_forbrug', 'unavailable') %}
            unavailable
          {% elif watts > 0.002 and watts < 0.01 %}
            startup
          {% elif watts > 0.07 and watts < 0.1 %}
            freezing
          {% elif watts > 0.099 and watts < 0.2 %}
            batch_done
          {% elif watts > 0.2 %}
            startup
          {% elif is_state('switch.ismaskine_afbryder', 'off') %}
            off
          {% else %}
            idle
          {% endif %}

input_boolean:
  ismaskine:

automation:
  - alias: TÃ¦nd/Sluk ismaskine
    mode: queued
    trigger:
      - platform: state
        entity_id: input_boolean.ismaskine
        to:
          - "on"
          - "off"
    action:
      - choose:
          - conditions:
              - condition: state
                entity_id: input_boolean.ismaskine
                state: "on"
            sequence:
              - service: switch.turn_on
                data:
                  entity_id: switch.ismaskine_afbryder
              - wait_template: "{{ not is_state('switch.ismaskine', 'unavailable') }}"
                timeout: 60
                continue_on_timeout: false
              - service: switch.turn_on
                data:
                  entity_id: switch.ismaskine
          - conditions:
              - condition: state
                entity_id: input_boolean.ismaskine
                state: "off"
            sequence:
              - service: switch.turn_on
                data:
                  entity_id: switch.ismaskine
              - delay:
                  seconds: 15
              - service: switch.turn_off
                data:
                  entity_id: switch.ismaskine_afbryder

  - alias: Ismaskine Fuld
    mode: single
    trigger:
      - platform: state
        entity_id: sensor.icemachine_state
        to: "idle"
        for:
          seconds: 30
    condition:
      - condition: state
        entity_id: binary_sensor.barskab
        state: "on"
    action:
      - service: notify.telegram_darkfox
        data:
          message: "Isterningmaskinen er fuld."
