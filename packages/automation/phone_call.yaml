input_text:
  active_media_player:
  active_media_type:
  work_phone_caller:
    initial: ""

input_boolean:
  work_phone_ringing:

template:
  - trigger:
      platform: event
      event_type:
        - work_call_received
        - work_call_ended
    sensor:
      - name: "Current Work Call"
        state: "{{ trigger.event.data.phone_number if trigger.event.event_type == 'work_call_received' }}"
        attributes:
          phone_number: "{{ trigger.event.data.phone_number if trigger.event.event_type == 'work_call_received' }}"
          formatted_phone: "{{ trigger.event.data.phone_number | string | regex_findall(find='..') | join(' ') if trigger.event.event_type == 'work_call_received' }}"
          caller_info: "{{ trigger.event.data.caller_info if trigger.event.event_type == 'work_call_received' }}"
          start: "{{ as_timestamp(now()) | timestamp_custom('%Y-%m-%d %H:%M:%S', true) if trigger.event.event_type == 'work_call_received' }}"

  - trigger:
      platform: event
      event_type:
        - work_call_ended
        - clear_work_call_log
    sensor:
      - name: "Work Call Log"
        state: "{{ as_timestamp(now()) | timestamp_custom('%Y-%m-%d %H:%M:%S', true) }}"
        attributes:
          call_log: |
            {% if trigger.event.event_type == 'clear_work_call_log' %}
              {}
            {% else %}
              {% set old_call_log = state_attr('sensor.work_call_log', 'call_log') or {} %}
              {% set current_call = trigger.event.data.call_info %}
              {% set caller_info = current_call['caller_info'] or {} %}
              {% set new_caller = {
                'phone_number': current_call['phone_number'],
                'formatted_phone': current_call['formatted_phone'],
                'name': caller_info.get('name', ''),
                'title': caller_info.get('title', ''),
                'organization': caller_info.get('organization', ''),
                'email': caller_info.get('email', ''),
                'start': current_call['start'],
                'end': as_timestamp(now()) | timestamp_custom('%Y-%m-%d %H:%M:%S', true)
              } %}
              {
                {% for key, value in old_call_log.items() %}
                  "{{key}}": {{ value | tojson }},
                {% endfor %}
                "{{ new_caller['start'] }}": {{ new_caller | tojson }}
              }
            {% endif %}

  - sensor:
      - name: "Reverse Work Call Log"
        state: "{{ states('sensor.work_call_log') }}"
        attributes:
          call_log: |
            {% set call_log = state_attr('sensor.work_call_log', 'call_log') or {} %}
            {% set call_log_keys = call_log.keys() | list %}
            {
              {% for key in call_log_keys | reverse %}
                "{{ key }}": {{ call_log[key] | tojson }},
              {% endfor %}
            }

automation:
  - alias: Pause Media On Phone Call
    id: pause_media_on_phone_call
    initial_state: true
    trigger:
      - platform: state
        entity_id:
          - sensor.arbejdstelefon_phone_state
          - sensor.darkphone_phone_state
        to:
          - ringing
          - offhook
        from: idle
    condition:
      - condition: state
        entity_id: binary_sensor.martin_presence
        state: "on"
    action:
      - service: script.turn_on
        entity_id: script.pause_all_media

  - alias: Unpause On Phone Call Finished
    id: unpause_media_on_phone_call_finished
    initial_state: true
    trigger:
      - platform: state
        entity_id:
          - sensor.arbejdstelefon_phone_state
          - sensor.darkphone_phone_state
        to: idle
    condition:
      - condition: state
        entity_id: binary_sensor.martin_presence
        state: "on"
    action:
      - service: script.turn_on
        entity_id: script.resume_all_media

  - alias: On Call Ringing While Sleeping
    id: on_call_ringing_while_sleeping
    initial_state: true
    trigger:
      - platform: state
        entity_id: sensor.arbejdstelefon_phone_state
        to: ringing
    condition:
      - condition: state
        entity_id: binary_sensor.martin_presence
        state: "on"
      - condition: state
        entity_id: binary_sensor.on_call
        state: "on"
    action:
      - choose:
          - conditions:
              - condition: state
                entity_id: input_select.sleep_state
                state:
                  - "sleeping"
                  - "smart wake"
            sequence:
              - service: input_select.select_option
                data:
                  entity_id: input_select.sleep_state
                  option: paused
              - event: set_light_profile
                event_data:
                  room: bedroom
                  profile: Night

  - alias: On Call Picked Up
    id: on_call_picked_up
    initial_state: true
    trigger:
      - platform: state
        entity_id: sensor.arbejdstelefon_phone_state
        to: offhook
    condition:
      - condition: state
        entity_id: binary_sensor.martin_presence
        state: "on"
      - condition: state
        entity_id: binary_sensor.on_call
        state: "on"
      - condition: state
        entity_id: input_select.sleep_state
        state:
          - "sleeping"
          - "smart wake"
          - "paused"
    action:
      - event: set_light_profile
        event_data:
          room: bedroom
          profile: Ambient
      - delay:
          seconds: 30
      - condition: state
        entity_id: sensor.arbejdstelefon_phone_state
        state: offhook
      - event: set_light_profile
        event_data:
          room: bedroom
          profile: Dimmed

  - alias: On Call Done
    id: on_call_done
    initial_state: true
    trigger:
      - platform: state
        entity_id: sensor.arbejdstelefon_phone_state
        from: "offhook"
        to: "idle"
        for:
          minutes: 2
      - platform: state
        entity_id: device_tracker.pc074805
        to: "not_home"
        for:
          seconds: 30
    condition:
      - condition: state
        entity_id: binary_sensor.martin_presence
        state: "on"
      - condition: state
        entity_id: binary_sensor.on_call
        state: "on"
      - condition: state
        entity_id: device_tracker.pc074805
        state: "not_home"
      - condition: state
        entity_id: sensor.arbejdstelefon_phone_state
        state: "idle"
    action:
      - choose:
          - conditions:
              - condition: state
                entity_id: input_select.sleep_state
                state:
                  - "paused"
            sequence:
              - event: set_light_profile
                event_data:
                  room: bedroom
                  profile: "Off"
              - service: input_select.select_option
                data:
                  entity_id: input_select.sleep_state
                  option: sleeping

  - alias: On Call Not Picked Up
    id: on_call_not_picked_up
    initial_state: true
    trigger:
      - platform: state
        entity_id: input_boolean.work_phone_ringing
        to: "off"
        for:
          seconds: 5
    condition:
      - condition: state
        entity_id: sensor.arbejdstelefon_phone_state
        state: "idle"
      - condition: state
        entity_id: binary_sensor.martin_presence
        state: "on"
      - condition: state
        entity_id: binary_sensor.on_call
        state: "on"
    action:
      - choose:
          - conditions:
              - condition: state
                entity_id: input_select.sleep_state
                state:
                  - "paused"
            sequence:
              - event: set_light_profile
                event_data:
                  room: bedroom
                  profile: "Off"
              - service: input_select.select_option
                data:
                  entity_id: input_select.sleep_state
                  option: sleeping

  - alias: Work phone caller lookup
    id: work_phone_caller_lookup
    initial_state: true
    trigger:
      - platform: state
        entity_id: input_text.work_phone_caller
    condition:
      - condition: template
        value_template: "{{ trigger.to_state.state not in ['', 'unavailable', 'unknown'] }}"
      - condition: state
        entity_id: sensor.arbejdstelefon_phone_state
        state:
          - "ringing"
          - "offhook"
    action:
      - variables:
          phone_number: "{{ states('input_text.work_phone_caller')[-8:] }}"
      - service: script.puzzel_lookup_caller
        response_variable: caller
        data:
          phone_number: "{{ phone_number }}"
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ caller is not none and caller != {} }}"
            sequence:
              - event: work_call_received
                event_data:
                  phone_number: "{{ phone_number }}"
                  caller_info:
                    name: "{{ caller.firstName|trim }} {{ caller.lastName|trim }}"
                    title: "{{ caller.title|trim }}"
                    organization: "{{ caller.organizationName|trim }}"
                    phone_number: "{{ caller.communicationPoints | selectattr('communicationType', 'equalto', 'Cell') | map(attribute='remoteAddress') | first }}"
                    email: "{{ caller.communicationPoints | selectattr('communicationType', 'equalto', 'EMail') | map(attribute='remoteAddress') | first }}"
        default:
          # If no caller is found, try looking up the number current puzzel caller
          - service: script.puzzel_get_current_request
            response_variable: current_request

          - choose:
              - conditions:
                  - condition: template
                    value_template: |
                      {{
                        current_request is not none
                        and current_request != {}
                        and current_request != ''
                      }}
                sequence:
                  - variables:
                      request_remote_address: "{{ current_request['requestRemoteAddress'][-8:] }}"
                  - choose:
                      - conditions:
                          - condition: template
                            value_template: "{{ request_remote_address != phone_number }}"
                        sequence:
                          - event: work_call_received
                            event_data:
                              phone_number: "{{ phone_number }}"
                              caller_info: {}
                    default:
                      - service: script.puzzel_lookup_caller
                        response_variable: puzzel_caller
                        data:
                          phone_number: "{{ request_remote_address }}"
                      - choose:
                          - conditions:
                              - condition: template
                                value_template: "{{ puzzel_caller is not none and puzzel_caller != {} }}"
                            sequence:
                              - event: work_call_received
                                event_data:
                                  phone_number: "{{ request_remote_address }}"
                                  caller_info:
                                    name: "{{ puzzel_caller.firstName|trim }} {{ puzzel_caller.lastName|trim }}"
                                    title: "{{ puzzel_caller.title|trim }}"
                                    organization: "{{ puzzel_caller.organizationName|trim }}"
                                    phone_number: "{{ puzzel_caller.communicationPoints | selectattr('communicationType', 'equalto', 'Cell') | map(attribute='remoteAddress') | first }}"
                                    email: "{{ puzzel_caller.communicationPoints | selectattr('communicationType', 'equalto', 'EMail') | map(attribute='remoteAddress') | first }}"

                        default:
                          - event: work_call_received
                            event_data:
                              phone_number: "{{ request_remote_address }}"
                              caller_info: {}
            default:
              - event: work_call_received
                event_data:
                  phone_number: "{{ phone_number }}"
                  caller_info: {}

  - alias: Work call ended
    id: work_call_ended
    initial_state: true
    trigger:
      - platform: state
        entity_id: sensor.arbejdstelefon_phone_state
        to: idle
        from:
          - ringing
          - offhook
    action:
      - event: work_call_ended
        event_data:
          call_info:
            phone_number: "{{ states('sensor.current_work_call') }}"
            caller_info: "{{ state_attr('sensor.current_work_call', 'caller_info') }}"
            start: "{{ state_attr('sensor.current_work_call', 'start') }}"
      - service: input_text.set_value
        data:
          entity_id: input_text.work_phone_caller
          value: ""

  - alias: Notify Work Call
    id: notify_work_call
    initial_state: true
    trigger:
      - platform: event
        event_type: work_call_received
    action:
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ trigger.event.data.caller_info is not none and trigger.event.data.caller_info != {} }}"
            sequence:
              - variables:
                  caller: "{{ trigger.event.data.caller_info }}"
                  name: "{{ caller.name }}"
                  title: "{{ caller.title }}"
                  email: "{{ caller.email }}"
                  organization: "{{ caller.organization }}"
                  formatted_phone: "{{ caller.phone_number | string | regex_findall(find='..') | join(' ') }}"

              - service: notify.mobile_app_arbejdstelefon
                data:
                  title: "{{ name }}"
                  message: |
                    {{ title }} hos {{ organization }}.
                    Tlf: {{ formatted_phone }}
                    Email: {{ email }}
                  data:
                    tag: "puzzel_caller"
                    channel: "Puzzel Caller"
                    importance: high
                    ttl: 0
                    priority: high
                    persistent: false
                    clickAction: noAction
                    notification_icon: mdi:phone-classic
              - service: notify.telegram_darkfox
                data:
                  message: |
                    Arbejdspkald fra {{ name }}
                    {{ title }} hos {{ organization }}.
                    Tlf: {{ formatted_phone }}
                    Email: {{ email }}

        default:
          - service: notify.telegram_darkfox
            data:
              message: >-
                Arbejdsopkald fra ukendt nummer: {{ trigger.event.data.phone_number | string | regex_findall(find='..') | join(' ') }}

script:
  notify_unknown_caller:
    alias: "Notify Unknown Caller"
    fields:
      phone_number:
        description: "The phone number of the unknown caller"
    sequence:
      - service: notify.telegram_darkfox
        data:
          message: >-
            Arbejdsopkald fra ukendt nummer: {{ phone_number | string | regex_findall(find='..') | join(' ') }}

  notify_caller_info:
    alias: "Notify Caller Info"
    fields:
      caller:
        description: "The caller object"
    sequence:
      - condition: template
        value_template: "{{ caller is not none and caller != {} }}"

      - variables:
          name: "{{ caller.firstName|trim }} {{ caller.lastName|trim }}"
          title: "{{ caller.title|trim }}"
          organization: "{{ caller.organizationName|trim }}"
          phone: "{{ caller.communicationPoints | selectattr('communicationType', 'equalto', 'Cell') | map(attribute='remoteAddress') | first }}"
          email: "{{ caller.communicationPoints | selectattr('communicationType', 'equalto', 'EMail') | map(attribute='remoteAddress') | first }}"

      - variables:
          formatted_phone: "{{ phone | string | regex_findall(find='..') | join(' ') }}"

      - service: notify.mobile_app_arbejdstelefon
        data:
          title: "{{ name }}"
          message: |
            {{ title }} hos {{ organization }}.
            Tlf: {{ formatted_phone }}
            Email: {{ email }}
          data:
            tag: "puzzel_caller"
            channel: "Puzzel Caller"
            importance: high
            ttl: 0
            priority: high
            persistent: false
            clickAction: noAction
            notification_icon: mdi:phone-classic
      - service: notify.telegram_darkfox
        data:
          message: |
            Arbejdspkald fra {{ name }}
            {{ title }} hos {{ organization }}.
            Tlf: {{ formatted_phone }}
            Email: {{ email }}

  clear_work_call_log:
    alias: "Clear Work Call Log"
    sequence:
      - alias: "Clears the work call log"
        event: clear_work_call_log

  pause_all_media:
    alias: "Sæt afspilning på pause"
    sequence:
      - service: input_text.set_value
        data:
          entity_id: input_text.active_media_player
          value: "{{ states('sensor.active_media_player') }}"
      - service: input_text.set_value
        data:
          entity_id: input_text.active_media_type
          value: "{{ 'file' if state_attr(states('sensor.active_media_player'), 'media_duration') else 'stream' }}"
      - choose:
          - conditions:
              - condition: state
                entity_id: input_text.active_media_type
                state: "file"
            sequence:
              - service: "media_player.media_pause"
                data:
                  entity_id: "{{ states('input_text.active_media_player') }}"
          - conditions:
              - condition: state
                entity_id: input_text.active_media_type
                state: "stream"
            sequence:
              - service: "media_player.volume_mute"
                data:
                  entity_id: "{{ states('input_text.active_media_player') }}"
                  is_volume_muted: true

  resume_all_media:
    alias: "Genoptag afspilning"
    sequence:
      - choose:
          - conditions:
              - condition: state
                entity_id: input_text.active_media_type
                state: "file"
            sequence:
              - service: "media_player.media_play"
                data:
                  entity_id: "{{ states('input_text.active_media_player') }}"
          - conditions:
              - condition: state
                entity_id: input_text.active_media_type
                state: "stream"
            sequence:
              - service: "media_player.volume_mute"
                data:
                  entity_id: "{{ states('input_text.active_media_player') }}"
                  is_volume_muted: false
