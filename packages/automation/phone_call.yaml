input_text:
  active_media_player:
  active_media_type:

automation:
  - alias: Pause Media On Phone Call
    id: pause_media_on_phone_call
    initial_state: true
    triggers:
      - trigger: state
        entity_id:
          - sensor.arbejdstelefon_phone_state
          - sensor.darkphone_phone_state
        to:
          - ringing
          - offhook
        from: idle
    conditions:
      - condition: state
        entity_id: binary_sensor.rook_presence
        state: "on"
      - condition: template
        value_template: >-
          {{
            trigger.to_state.entity_id == 'sensor.darkphone_phone_state'
            or is_state('binary_sensor.working', 'on')
          }}
    actions:
      - action: script.turn_on
        entity_id: script.pause_all_media

  - alias: Unpause On Phone Call Finished
    id: unpause_media_on_phone_call_finished
    initial_state: true
    triggers:
      - trigger: state
        entity_id:
          - sensor.arbejdstelefon_phone_state
          - sensor.darkphone_phone_state
        to: idle
    conditions:
      - condition: state
        entity_id: binary_sensor.rook_presence
        state: "on"
    actions:
      - action: script.turn_on
        entity_id: script.resume_all_media

script:
  pause_all_media:
    alias: "Sæt afspilning på pause"
    sequence:
      - action: input_text.set_value
        data:
          entity_id: input_text.active_media_player
          value: "{{ states('sensor.active_media_player') }}"
      - action: input_text.set_value
        data:
          entity_id: input_text.active_media_type
          value: "{{ 'file' if state_attr(states('sensor.active_media_player'), 'media_duration') else 'stream' }}"
      - choose:
          - conditions:
              - condition: state
                entity_id: input_text.active_media_type
                state: "file"
            sequence:
              - action: "media_player.media_pause"
                data:
                  entity_id: "{{ states('input_text.active_media_player') }}"
          - conditions:
              - condition: state
                entity_id: input_text.active_media_type
                state: "stream"
            sequence:
              - action: "media_player.volume_mute"
                data:
                  entity_id: "{{ states('input_text.active_media_player') }}"
                  is_volume_muted: true

  resume_all_media:
    alias: "Genoptag afspilning"
    sequence:
      - choose:
          - conditions:
              - condition: state
                entity_id: input_text.active_media_type
                state: "file"
            sequence:
              - action: "media_player.media_play"
                data:
                  entity_id: "{{ states('input_text.active_media_player') }}"
          - conditions:
              - condition: state
                entity_id: input_text.active_media_type
                state: "stream"
            sequence:
              - action: "media_player.volume_mute"
                data:
                  entity_id: "{{ states('input_text.active_media_player') }}"
                  is_volume_muted: false
