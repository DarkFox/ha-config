input_text:
  active_media_player:
  active_media_type:
  work_phone_caller:

input_boolean:
  work_phone_ringing:

automation:
  - alias: pause_media_on_phone_call
    initial_state: true
    trigger:
      - platform: state
        entity_id:
          - sensor.arbejdstelefon_phone_state
          - sensor.darkphone_phone_state
        to: offhook
    condition:
      - condition: state
        entity_id: binary_sensor.martin_presence
        state: "on"
    action:
      - service: script.turn_on
        entity_id: script.pause_all_media

  - alias: unpause_on_phone_call_finished
    initial_state: true
    trigger:
      - platform: state
        entity_id:
          - sensor.arbejdstelefon_phone_state
          - sensor.darkphone_phone_state
        from: offhook
    condition:
      - condition: state
        entity_id: binary_sensor.martin_presence
        state: "on"
    action:
      - service: script.turn_on
        entity_id: script.resume_all_media

  - alias: on_call_ringing
    initial_state: true
    trigger:
      - platform: state
        entity_id: input_boolean.work_phone_ringing
        to: "on"
    condition:
      - condition: state
        entity_id: binary_sensor.martin_presence
        state: "on"
      - condition: state
        entity_id: binary_sensor.on_call
        state: "on"
    action:
      - choose:
          - conditions:
              - condition: state
                entity_id: input_select.sleep_state
                state:
                  - "sleeping"
                  - "smart wake"
            sequence:
              - service: input_select.select_option
                data:
                  entity_id: input_select.sleep_state
                  option: paused
              - event: set_light_profile
                event_data:
                  room: bedroom
                  profile: Night

  - alias: on_call_picked_up
    initial_state: true
    trigger:
      - platform: state
        entity_id: sensor.arbejdstelefon_phone_state
        to: offhook
    condition:
      - condition: state
        entity_id: binary_sensor.martin_presence
        state: "on"
      - condition: state
        entity_id: binary_sensor.on_call
        state: "on"
    action:
      - choose:
          - conditions:
              - condition: state
                entity_id: input_select.sleep_state
                state:
                  - "sleeping"
                  - "smart wake"
                  - "paused"
            sequence:
              - event: set_light_profile
                event_data:
                  room: bedroom
                  profile: Ambient
              - delay:
                  seconds: 30
              - condition: state
                entity_id: sensor.arbejdstelefon_phone_state
                state: offhook
              - event: set_light_profile
                event_data:
                  room: bedroom
                  profile: Dimmed

  - alias: on_call_done
    initial_state: true
    trigger:
      - platform: state
        entity_id: sensor.arbejdstelefon_phone_state
        from: "offhook"
        to: "idle"
        for:
          minutes: 2
      - platform: state
        entity_id: device_tracker.pc074805
        to: "not_home"
        for:
          seconds: 30
    condition:
      - condition: state
        entity_id: binary_sensor.martin_presence
        state: "on"
      - condition: state
        entity_id: binary_sensor.on_call
        state: "on"
      - condition: state
        entity_id: device_tracker.pc074805
        state: "not_home"
      - condition: state
        entity_id: sensor.arbejdstelefon_phone_state
        state: "idle"
    action:
      - choose:
          - conditions:
              - condition: state
                entity_id: input_select.sleep_state
                state:
                  - "paused"
            sequence:
              - event: set_light_profile
                event_data:
                  room: bedroom
                  profile: "Off"
              - service: input_select.select_option
                data:
                  entity_id: input_select.sleep_state
                  option: sleeping

  - alias: on_call_not_picked_up
    initial_state: true
    trigger:
      - platform: state
        entity_id: input_boolean.work_phone_ringing
        to: "off"
        for:
          seconds: 5
    condition:
      - condition: state
        entity_id: sensor.arbejdstelefon_phone_state
        state: "idle"
      - condition: state
        entity_id: binary_sensor.martin_presence
        state: "on"
      - condition: state
        entity_id: binary_sensor.on_call
        state: "on"
    action:
      - choose:
          - conditions:
              - condition: state
                entity_id: input_select.sleep_state
                state:
                  - "paused"
            sequence:
              - event: set_light_profile
                event_data:
                  room: bedroom
                  profile: "Off"
              - service: input_select.select_option
                data:
                  entity_id: input_select.sleep_state
                  option: sleeping

  - alias: work_phone_ringing
    initial_state: true
    trigger:
      platform: webhook
      webhook_id: !secret work_phone_ringing_webhook
    action:
      - service: "input_boolean.turn_{{ 'on' if trigger.json.state else 'off' }}"
        data:
          entity_id: input_boolean.work_phone_ringing
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ trigger.json.state }}"
            sequence:
              - service: input_text.set_value
                data_template:
                  entity_id: input_text.work_phone_caller
                  value: "{{ trigger.json.caller }}"
        default:
          - service: input_text.set_value
            data_template:
              entity_id: input_text.work_phone_caller
              value: ""

script:
  pause_all_media:
    alias: "Sæt afspilning på pause"
    sequence:
      - service: input_text.set_value
        data_template:
          entity_id: input_text.active_media_player
          value: "{{ states('sensor.active_media_player') }}"
      - service: input_text.set_value
        data_template:
          entity_id: input_text.active_media_type
          value: "{{ 'file' if state_attr(states('sensor.active_media_player'), 'media_duration') else 'stream' }}"
      - choose:
          - conditions:
              - condition: state
                entity_id: input_text.active_media_type
                state: "file"
            sequence:
              - service: "media_player.media_pause"
                data_template:
                  entity_id: "{{ states('input_text.active_media_player') }}"
          - conditions:
              - condition: state
                entity_id: input_text.active_media_type
                state: "stream"
            sequence:
              - service: "media_player.volume_mute"
                data_template:
                  entity_id: "{{ states('input_text.active_media_player') }}"
                  is_volume_muted: true

  resume_all_media:
    alias: "Genoptag afspilning"
    sequence:
      - choose:
          - conditions:
              - condition: state
                entity_id: input_text.active_media_type
                state: "file"
            sequence:
              - service: "media_player.media_play"
                data_template:
                  entity_id: "{{ states('input_text.active_media_player') }}"
          - conditions:
              - condition: state
                entity_id: input_text.active_media_type
                state: "stream"
            sequence:
              - service: "media_player.volume_mute"
                data_template:
                  entity_id: "{{ states('input_text.active_media_player') }}"
                  is_volume_muted: false
