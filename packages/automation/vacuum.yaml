# 16: "Værksted",
# 17: "Kontor",
# 18: "Soveværelse",
# 19: "Gang",
# 21: "Køkken",
# 22: "Stue"

script:
  toggle_vacuum:
    alias: "Toggle Vacuum"
    sequence:
      - alias: "Start if docked, otherwise go back to dock"
        choose:
          - conditions:
              - alias: "Is vacuum docked"
                condition: state
                entity_id: vacuum.roborock_s5
                state: "docked"
            sequence:
              - alias: "Start cleaning"
                service: vacuum.start
                target:
                  entity_id: vacuum.roborock_s5
        default:
          - alias: "Back to dock"
            service: vacuum.return_to_base
            target:
              entity_id: vacuum.roborock_s5

automation:
  - id: vacuum_while_away
    alias: Vacuum While Away
    initial_state: true
    trigger:
      - platform: time_pattern
        hours: "11"
        minutes: "/5"
        seconds: "0"
      - platform: time_pattern
        hours: "15"
        minutes: "/5"
        seconds: "0"
    condition:
      - condition: state
        entity_id:
          - calendar.helligdage
          - input_boolean.guests
        state: "off"
      - condition: time
        weekday:
          - mon
          - tue
          - wed
          - thu
          - fri
      - condition: template
        value_template: >-
          {{
            is_state('vacuum.roborock_s5', 'docked')
            and is_state('binary_sensor.martin_presence_delayed', 'off')
            and states('sensor.roborock_s5_last_clean_start')|as_timestamp < now()|as_timestamp - 8*60*60
          }}
    action:
      - service: vacuum.start
        target:
          entity_id: vacuum.roborock_s5

  - id: vacuum_stop_before_coming_home
    alias: Vacuum Stop Before Coming Home
    initial_state: true
    trigger:
      - platform: state
        entity_id: binary_sensor.martin_home_soon
        from: "off"
        to: "on"
        for:
          minutes: 5
      - platform: state
        entity_id: binary_sensor.martin_presence
        from: "off"
        to: "on"
        for:
          minutes: 1
    action:
      - alias: "Go to empty position if more than 120m2 since last empty"
        choose:
          - conditions:
              - condition: template
                value_template: "{{ states('sensor.vacuum_area_cleaned_since_last_empty')|int > 120 }}"
            sequence:
              - service: script.send_vacuum_to_emptying_position
        default:
          # Go to dock if not going to empty, and not docked already
          - condition: template
            value_template: "{{ not is_state('vacuum.roborock_s5', 'docked') }}"
          - service: vacuum.return_to_base
