script:
  toggle_vacuum:
    alias: "Toggle Vacuum"
    sequence:
      - alias: "Start if docked, otherwise go back to dock"
        choose:
          - conditions:
              - alias: "Is vacuum docked"
                condition: state
                entity_id: vacuum.valetudo_roborocks5
                state: "docked"
            sequence:
              - alias: "Start cleaning"
                service: vacuum.start
                target:
                  entity_id: vacuum.valetudo_roborocks5
        default:
          - alias: "Back to dock"
            service: vacuum.return_to_base
            target:
              entity_id: vacuum.valetudo_roborocks5

  send_vacuum_to_emptying_position:
    alias: "Send støvsuger til tømmeposition"
    sequence:
      - service: script.valetudo_go_to_target
        data:
          x_coord: 2710
          y_coord: 2449
      - alias: "update last empty count"
        service: input_text.set_value
        data:
          entity_id: input_text.vacuum_last_empty
          value: "{{ states('sensor.valetudo_roborocks5_total_statistics_area') }}"

  valetudo_go_to_target:
    alias: "Valetudo go to target"
    fields:
      x_coord:
        name: X coordinate
      y_coord:
        name: Y coordinate
    sequence:
      service: script.valetudo_send_vacuum_command
      data:
        mqtt_payload: |-
          {
            "coordinates": {
              "x": {{ x_coord }},
              "y": {{ y_coord }}
            }
          }
        mqtt_topic: GoToLocationCapability/go/set

input_boolean:
  vacuum_show_card:
    name: Vis Støvsuger Menu
    icon: mdi:menu

input_text:
  vacuum_last_empty:
    name: Vacuum Last Empty
    icon: mdi:delete

sensor:
  - platform: template
    sensors:
      vacuum_area_cleaned_since_last_empty:
        friendly_name: "Areal støvsuget siden sidste tømning"
        value_template: "{{ ((states('sensor.valetudo_roborocks5_total_statistics_area')|float) - (states('input_text.vacuum_last_empty')|float)) | round(1) }}"
        unit_of_measurement: m2
      vacuum_current_room:
        friendly_name: "Støvsuger Rum"
        value_template: >-
          {{ state_attr('camera.valetudo_s5_camera', 'in_room') }}

template:
  - sensor:
      - name: "Valetudo segments mapping"
        unique_id: "valetudo_segments_mapping"
        state: "OK"
        attributes:
          segments: >-
            {% set rooms = state_attr('camera.valetudo_s5_camera', 'rooms') %}
            {% set icons = {
              "Værksted": "mdi:hand-saw",
              "Kontor": "mdi:desktop-tower-monitor",
              "Soveværelse": "mdi:bed",
              "Gang": "mdi:door",
              "Køkken": "mdi:food-fork-drink",
              "Stue": "mdi:sofa"
            } %}
            [
              {% for room_id in rooms %}
                {% set room = rooms[room_id] %}
                {
                  "id": {{ room_id }},
                  "outline": {{ room.outline }},
                  "label": {
                    "text": "{{ room.name }}",
                    "x": {{ room.x }},
                    "y": {{ room.y }},
                    "offset_y": 30
                  },
                  "icon": {
                    "name": "{{ icons[room.name] }}",
                    "x": {{ room.x }},
                    "y": {{ room.y }}
                  }
                },
              {% endfor %}
            ]

automation:
  - id: vacuum_show_menu_when_undocked
    alias: Vacuum Show Menu When Undocked
    initial_state: true
    trigger:
      - platform: state
        entity_id: vacuum.valetudo_roborocks5
        to:
          - cleaning
          - paused
          - idle
          - returning
          - error
    action:
      - service: input_boolean.turn_on
        target:
          entity_id: input_boolean.vacuum_show_card

  - id: vacuum_hide_menu_when_docked
    alias: Vacuum Hide Menu When Docked
    initial_state: true
    trigger:
      - platform: state
        entity_id: vacuum.valetudo_roborocks5
        to: "docked"
    action:
      - service: input_boolean.turn_off
        target:
          entity_id: input_boolean.vacuum_show_card

  - id: vacuum_while_away
    alias: Vacuum While Away
    initial_state: true
    trigger:
      - platform: time_pattern
        hours: "11"
        minutes: "/5"
        seconds: "0"
      - platform: time_pattern
        hours: "15"
        minutes: "/5"
        seconds: "0"
    condition:
      - condition: state
        entity_id:
          - calendar.helligdage
          - input_boolean.guests
        state: "off"
      - condition: time
        weekday:
          - mon
          - tue
          - wed
          - thu
          - fri
      - condition: template
        value_template: >-
          {{
            is_state('vacuum.valetudo_roborocks5', 'docked')
            and is_state('binary_sensor.martin_presence_delayed', 'off')
            and states('sensor.roborock_s5_last_clean_start')|as_timestamp < now()|as_timestamp - 8*60*60
          }}
    action:
      - service: vacuum.start
        target:
          entity_id: vacuum.valetudo_roborocks5

  - id: vacuum_stop_before_coming_home
    alias: Vacuum Stop Before Coming Home
    initial_state: true
    trigger:
      - platform: state
        entity_id: binary_sensor.martin_home_soon
        from: "off"
        to: "on"
        for:
          minutes: 5
      - platform: state
        entity_id: binary_sensor.martin_presence
        from: "off"
        to: "on"
        for:
          minutes: 1
    action:
      - alias: "Go to empty position if more than 120m2 since last empty"
        choose:
          - conditions:
              - condition: template
                value_template: "{{ states('sensor.vacuum_area_cleaned_since_last_empty')|int > 120 }}"
            sequence:
              - service: script.send_vacuum_to_emptying_position
        default:
          # Go to dock if not going to empty, and not docked already
          - condition: template
            value_template: "{{ not is_state('vacuum.valetudo_roborocks5', 'docked') }}"
          - service: vacuum.return_to_base
