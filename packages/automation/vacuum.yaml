# 16: "Værksted",
# 17: "Kontor",
# 18: "Soveværelse",
# 19: "Gang",
# 21: "Køkken",
# 22: "Stue"

automation:
  - id: vacuum_while_away
    alias: Vacuum While Away
    initial_state: true
    trigger:
      - platform: time_pattern
        hours: "11"
        minutes: "/5"
        seconds: "0"
      - platform: time_pattern
        hours: "15"
        minutes: "/5"
        seconds: "0"
    condition:
      - condition: state
        entity_id:
          - calendar.helligdage
          - binary_sensor.arbejdskalender_ferie
        state: "off"
      - condition: time
        weekday:
          - mon
          - tue
          - wed
          - thu
          - fri
      - condition: template
        value_template: >-
          {{
            is_state('vacuum.roborock_s5', 'docked')
            and is_state('binary_sensor.martin_presence_delayed', 'off')
            and states('sensor.roborock_s5_last_clean_start')|as_timestamp < now()|as_timestamp - 8*60*60
          }}
    action:
      - service: script.debug_notification
        data:
          message: "Vacuum all rooms"
          title: "Vacuum"
      - service: vacuum.start
        target:
          entity_id: vacuum.roborock_s5

  - id: vacuum_stop_before_coming_home
    alias: Vacuum Stop Before Coming Home
    initial_state: true
    trigger:
      - platform: state
        entity_id: binary_sensor.martin_home_soon
        from: "off"
        to: "on"
        for:
          minutes: 5
    action:
      - alias: "Go to empty position if more than 75m2 since last empty"
        choose:
          - conditions:
              - condition: template
                value_template: "{{ states('sensor.vacuum_area_cleaned_since_last_empty')|int > 75 }}"
            sequence:
              - service: script.send_vacuum_to_emptying_position
        default:
          # Go to dock if not going to empty, and not docked already
          - condition: template
            value_template: "{{ not is_state('vacuum.roborock_s5', 'docked') }}"
          - service: vacuum.return_to_base
