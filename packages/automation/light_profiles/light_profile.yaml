homeassistant:
  customize:
    script.dim_light_profile:
      icon: mdi:brightness-low

    script.brighten_light_profile:
      icon: mdi:brightness-high

input_number:
  scene_transition_time:
    name: Scene Transition Time
    initial: 0.5
    min: 0.0
    max: 1800
    step: 0.1

input_select:
  light_profile:
    name: Light Profile
    options:
      - Bright
      - Default
      - Dimmed
      - Ambient
      - Night
      - 'Off'

  inactive_light_profile:
    name: Inactive Light Profile
    options:
      - Default
      - Dimmed
      - Ambient
      - Night
      - 'Off'

  theme:
    name: Theme
    options:
      - Tron
      - Halloween
      - Christmas
      - Little
      - Portal
      - Portal Inverted
      - Dragon
      - Red and Blue
      - Yellow and Green
      - Screaming Pink
      - Red
      - Green
      - Blue
      - Yellow
      - Purple
      - Orange
      - Spring Blossom

light:
  - platform: mqtt
    schema: json
    name: apartment light level
    command_topic: "virtual/apartment-light-level/set"
    brightness: true
    retain: true

  - platform: template
    lights:
      light_profile_bright:
        friendly_name: Lyst
        icon_template: "mdi:brightness-7"
        value_template: "{{ is_state('input_select.light_profile', 'Bright') }}"
        turn_on:
          service: input_select.select_option
          data:
            entity_id: input_select.light_profile
            option: Bright
        turn_off:
          event: light_profile_off_null

      light_profile_default:
        friendly_name: Normal
        icon_template: "mdi:brightness-5"
        value_template: "{{ is_state('input_select.light_profile', 'Default') }}"
        turn_on:
          service: input_select.select_option
          data:
            entity_id: input_select.light_profile
            option: Default
        turn_off:
          event: light_profile_off_null

      light_profile_dimmed:
        friendly_name: DÃ¦mpet
        icon_template: "mdi:brightness-6"
        value_template: "{{ is_state('input_select.light_profile', 'Dimmed') }}"
        turn_on:
          service: input_select.select_option
          data:
            entity_id: input_select.light_profile
            option: Dimmed
        turn_off:
          event: light_profile_off_null

      light_profile_ambient:
        friendly_name: Baggrund
        icon_template: "mdi:brightness-4"
        value_template: "{{ is_state('input_select.light_profile', 'Ambient') }}"
        turn_on:
          service: input_select.select_option
          data:
            entity_id: input_select.light_profile
            option: Ambient
        turn_off:
          event: light_profile_off_null

      light_profile_night:
        friendly_name: Nat
        icon_template: "mdi:brightness-3"
        value_template: "{{ is_state('input_select.light_profile', 'Night') }}"
        turn_on:
          service: input_select.select_option
          data:
            entity_id: input_select.light_profile
            option: Night
        turn_off:
          event: light_profile_off_null

      light_profile_off:
        friendly_name: 'Slukket'
        icon_template: "mdi:power"
        value_template: "{{ is_state('input_select.light_profile', 'Off') }}"
        turn_on:
          service: input_select.select_option
          data:
            entity_id: input_select.light_profile
            option: 'Off'
        turn_off:
          event: light_profile_off_null

sensor:
  - platform: template
    sensors:
      theme_primary_color: # Usually the warmer color
        friendly_name: Primary Color
        entity_id: input_select.theme
        value_template: >
          {% if is_state('input_select.theme', 'Tron') -%}
            35,100
          {% elif is_state('input_select.theme', 'Halloween') -%}
            16,100
          {% elif is_state('input_select.theme', 'Christmas') -%}
            0,100
          {% elif is_state('input_select.theme', 'Little') -%}
            300,70
          {% elif is_state('input_select.theme', 'Portal') -%}
            16,100
          {% elif is_state('input_select.theme', 'Portal Inverted') -%}
            220,100
          {% elif is_state('input_select.theme', 'Dragon') -%}
            284,100
          {% elif is_state('input_select.theme', 'Red and Blue') -%}
            0,100
          {% elif is_state('input_select.theme', 'Yellow and Green') -%}
            35,100
          {% elif is_state('input_select.theme', 'Screaming Pink') -%}
            330,100
          {% elif is_state('input_select.theme', 'Red') -%}
            0,100
          {% elif is_state('input_select.theme', 'Green') -%}
            105,100
          {% elif is_state('input_select.theme', 'Blue') -%}
            240,100
          {% elif is_state('input_select.theme', 'Yellow') -%}
            30,100
          {% elif is_state('input_select.theme', 'Purple') -%}
            284,100
          {% elif is_state('input_select.theme', 'Orange') -%}
            14,100
          {% elif is_state('input_select.theme', 'Spring Blossom') -%}
            339,58
          {% endif -%}

      theme_primary_color_hue:
        friendly_name: Primary Color Hue
        entity_id: input_select.theme
        value_template: >
          {% if is_state('input_select.theme', 'Tron') -%}
            45,100
          {% elif is_state('input_select.theme', 'Halloween') -%}
            25,100
          {% elif is_state('input_select.theme', 'Christmas') -%}
            0,100
          {% elif is_state('input_select.theme', 'Little') -%}
            285,90
          {% elif is_state('input_select.theme', 'Portal') -%}
            26,100
          {% elif is_state('input_select.theme', 'Portal Inverted') -%}
            254,100
          {% elif is_state('input_select.theme', 'Dragon') -%}
            265,100
          {% elif is_state('input_select.theme', 'Red and Blue') -%}
            0,100
          {% elif is_state('input_select.theme', 'Yellow and Green') -%}
            45,100
          {% elif is_state('input_select.theme', 'Screaming Pink') -%}
            330,100
          {% elif is_state('input_select.theme', 'Red') -%}
            0,100
          {% elif is_state('input_select.theme', 'Green') -%}
            125,100
          {% elif is_state('input_select.theme', 'Blue') -%}
            255,100
          {% elif is_state('input_select.theme', 'Yellow') -%}
            45,100
          {% elif is_state('input_select.theme', 'Purple') -%}
            265,100
          {% elif is_state('input_select.theme', 'Orange') -%}
            24,100
          {% elif is_state('input_select.theme', 'Spring Blossom') -%}
            339,58
          {% endif -%}

      theme_secondary_color: # Usually the colder color
        friendly_name: Secondary Color
        entity_id: input_select.theme
        value_template: >
          {% if is_state('input_select.theme', 'Tron') -%}
            179,100
          {% elif is_state('input_select.theme', 'Halloween') -%}
            284,100
          {% elif is_state('input_select.theme', 'Christmas') -%}
            0,0
          {% elif is_state('input_select.theme', 'Little') -%}
            220,70
          {% elif is_state('input_select.theme', 'Portal') -%}
            220,100
          {% elif is_state('input_select.theme', 'Portal Inverted') -%}
            16,100
          {% elif is_state('input_select.theme', 'Dragon') -%}
            120,100
          {% elif is_state('input_select.theme', 'Red and Blue') -%}
            240,100
          {% elif is_state('input_select.theme', 'Yellow and Green') -%}
            120,100
          {% elif is_state('input_select.theme', 'Screaming Pink') -%}
            330,100
          {% elif is_state('input_select.theme', 'Red') -%}
            0,100
          {% elif is_state('input_select.theme', 'Green') -%}
            120,100
          {% elif is_state('input_select.theme', 'Blue') -%}
            220,100
          {% elif is_state('input_select.theme', 'Yellow') -%}
            30,100
          {% elif is_state('input_select.theme', 'Purple') -%}
            274,100
          {% elif is_state('input_select.theme', 'Orange') -%}
            20,100
          {% elif is_state('input_select.theme', 'Spring Blossom') -%}
            327,32
          {% endif -%}

      theme_secondary_color_hue:
        friendly_name: Secondary Color Hue
        entity_id: input_select.theme
        value_template: >
          {% if is_state('input_select.theme', 'Tron') -%}
            199,100
          {% elif is_state('input_select.theme', 'Halloween') -%}
            266,100
          {% elif is_state('input_select.theme', 'Christmas') -%}
            0,0
          {% elif is_state('input_select.theme', 'Little') -%}
            225,70
          {% elif is_state('input_select.theme', 'Portal') -%}
            254,100
          {% elif is_state('input_select.theme', 'Portal Inverted') -%}
            26,100
          {% elif is_state('input_select.theme', 'Dragon') -%}
            140,100
          {% elif is_state('input_select.theme', 'Red and Blue') -%}
            255,100
          {% elif is_state('input_select.theme', 'Yellow and Green') -%}
            140,100
          {% elif is_state('input_select.theme', 'Screaming Pink') -%}
            330,100
          {% elif is_state('input_select.theme', 'Red') -%}
            0,100
          {% elif is_state('input_select.theme', 'Green') -%}
            140,100
          {% elif is_state('input_select.theme', 'Blue') -%}
            220,100
          {% elif is_state('input_select.theme', 'Yellow') -%}
            44,81
          {% elif is_state('input_select.theme', 'Purple') -%}
            269,94
          {% elif is_state('input_select.theme', 'Orange') -%}
            16,100
          {% elif is_state('input_select.theme', 'Spring Blossom') -%}
            327,9
          {% endif -%}

scene:
  - name: Bright
    entities:
      input_select.light_profile:
        option: 'Bright'

  - name: Default
    entities:
      input_select.light_profile:
        option: 'Default'

  - name: Dimmed
    entities:
      input_select.light_profile:
        option: 'Dimmed'

  - name: Ambient
    entities:
      input_select.light_profile:
        option: 'Ambient'

  - name: Night
    entities:
      input_select.light_profile:
        option: 'Night'

  - name: 'Off'
    entities:
      input_select.light_profile:
        option: 'Off'

script:
  dim_light_profile:
    sequence:
      service: input_select.select_next
      entity_id: input_select.light_profile
  brighten_light_profile:
    sequence:
      service: input_select.select_previous
      entity_id: input_select.light_profile
  activate_bright_scene:
    sequence:
      service: input_select.select_option
      data:
        entity_id: input_select.light_profile
        option: Bright
  activate_default_scene:
    sequence:
      service: input_select.select_option
      data:
        entity_id: input_select.light_profile
        option: Default
  activate_dimmed_scene:
    sequence:
      service: input_select.select_option
      data:
        entity_id: input_select.light_profile
        option: Dimmed
  activate_ambient_scene:
    sequence:
      service: input_select.select_option
      data:
        entity_id: input_select.light_profile
        option: Ambient
  activate_night_scene:
    sequence:
      service: input_select.select_option
      data:
        entity_id: input_select.light_profile
        option: Night
  activate_off_scene:
    sequence:
      service: input_select.select_option
      data:
        entity_id: input_select.light_profile
        option: 'Off'

automation:
  - alias: Reset Scene Transition Time
    initial_state: true
    trigger:
      platform: template
      value_template: "{% if as_timestamp(states.sensor.date_time.last_updated) - as_timestamp(states.input_number.scene_transition_time.last_updated) > 60 %}true{% endif %}"
    action:
      - service: input_number.set_value
        data:
          entity_id: "input_number.scene_transition_time"
          value: 0.5

  - alias: Apartment light level initializer
    initial_state: true
    trigger:
      platform: homeassistant
      event: start
    action:
      - service: light.turn_on
        data:
          entity_id: light.apartment_light_level
          brightness: 127

  - alias: Apartment light level setter
    initial_state: true
    trigger:
      - platform: numeric_state
        entity_id: light.apartment_light_level
        value_template: '{{ state.attributes.brightness }}'
        below: 120
      - platform: numeric_state
        entity_id: light.apartment_light_level
        value_template: '{{ state.attributes.brightness }}'
        above: 135
    action:
      - service_template: "input_select.select_{%- if states.light.apartment_light_level.attributes.brightness | int < 120 -%}next{%- else -%}previous{%- endif -%}"
        data:
          entity_id: input_select.light_profile
      - service: light.turn_on
        data:
          entity_id: light.apartment_light_level
          brightness: 127

  - alias: Inactive Light Profile Setter
    initial_state: true
    trigger:
      platform: state
      entity_id: input_select.light_profile
    action:
      service: input_select.select_option
      data_template:
        entity_id: input_select.inactive_light_profile
        option: >
          {% if is_state('input_select.light_profile', 'Bright') %}
            Default
          {% elif is_state('input_select.light_profile', 'Default') %}
            Dimmed
          {% elif is_state('input_select.light_profile', 'Dimmed') %}
            Ambient
          {% elif is_state('input_select.light_profile', 'Ambient') %}
            Night
          {% else %}
            Off
          {% endif %}

  # Room States and light profile #
  # bathroom
  # bedroom
  # hallway
  # kitchen
  # living_room
  # office
  # storage_room

  - alias: rooms global profile change
    initial_state: true
    trigger:
      - platform: state
        entity_id:
          - input_select.light_profile
    action:
      - event: sync_room_light_profile
        event_data:
          room: bathroom
      - event: sync_room_light_profile
        event_data:
          room: bedroom
      - event: sync_room_light_profile
        event_data:
          room: hallway
      - event: sync_room_light_profile
        event_data:
          room: kitchen
      - event: sync_room_light_profile
        event_data:
          room: living_room
      - event: sync_room_light_profile
        event_data:
          room: office
      - event: sync_room_light_profile
        event_data:
          room: storage_room

  - alias: refresh_all_light_profiles
    initial_state: true
    trigger:
      - platform: state
        entity_id:
          - input_select.theme
          - input_boolean.party_mode
      - platform: event
        event_type: refresh_light_profile
    action:
      - event: activate_room_profile
        event_data:
          room: bathroom
      - event: activate_room_profile
        event_data:
          room: bedroom
      - event: activate_room_profile
        event_data:
          room: hallway
      - event: activate_room_profile
        event_data:
          room: kitchen
      - event: activate_room_profile
        event_data:
          room: living_room
      - event: activate_room_profile
        event_data:
          room: office
      - event: activate_room_profile
        event_data:
          room: storage_room

  - alias: Room Light Profile Changed
    initial_state: true
    trigger:
      platform: state
      entity_id:
        - input_select.bathroom_light_profile
        - input_select.bedroom_light_profile
        - input_select.hallway_light_profile
        - input_select.kitchen_light_profile
        - input_select.living_room_light_profile
        - input_select.office_light_profile
        - input_select.storage_room_light_profile
    action:
      - service: input_select.select_option
        data_template:
          entity_id: "input_select.{{ trigger.entity_id.replace('input_select.', '').replace('_light_profile', '') }}_inactive_light_profile"
          option: >
            {%- set entity_id = 'input_select.' + trigger.entity_id.replace('input_select.', '').replace('_light_profile', '') + '_light_profile' -%}
            {%- if is_state(entity_id, 'Bright') -%}
              Default
            {%- elif is_state(entity_id, 'Default') -%}
              Dimmed
            {%- elif is_state(entity_id, 'Dimmed') -%}
              Ambient
            {%- elif is_state(entity_id, 'Ambient') -%}
              Night
            {%- else -%}
              Off
            {%- endif -%}
      - event: activate_room_profile
        event_data_template:
          room: "{{ trigger.entity_id.replace('input_select.', '').replace('_light_profile', '') }}"
      - condition: and
        conditions:
          condition: template
          value_template: "{{ 'True' if is_state('input_boolean.' + trigger.entity_id.replace('input_select.', '').replace('_light_profile', '') + '_separate_light_profile', 'off') }}"
      - service: input_select.select_option
        data_template:
          entity_id: "input_select.light_profile"
          option: "{{ trigger.to_state.state }}"

  - alias: rooms state change
    initial_state: true
    trigger:
      - platform: state
        entity_id:
          - input_select.bathroom_room_state
          - input_select.bedroom_room_state
          - input_select.hallway_room_state
          - input_select.kitchen_room_state
          - input_select.living_room_room_state
          - input_select.office_room_state
          - input_select.storage_room_room_state
    action:
      event: activate_room_profile
      event_data_template:
        room: "{{ trigger.entity_id.replace('input_select.', '').replace('_room_state', '') }}"

  - alias: Room activity override on
    initial_state: true
    trigger:
      platform: state
      entity_id:
        - input_boolean.bathroom_activity_override
        - input_boolean.bedroom_activity_override
        - input_boolean.hallway_activity_override
        - input_boolean.kitchen_activity_override
        - input_boolean.living_room_activity_override
        - input_boolean.office_activity_override
        - input_boolean.storage_room_activity_override
      to: 'on'
    action:
      - service: input_select.select_option
        data_template:
          entity_id: "input_select.{{ trigger.entity_id.replace('input_boolean.', '').replace('_activity_override', '') }}_room_state"
          option: 'active'

  - alias: Room Separate Light Profile
    initial_state: true
    trigger:
      platform: state
      entity_id:
        - input_boolean.bathroom_separate_light_profile
        - input_boolean.bedroom_separate_light_profile
        - input_boolean.hallway_separate_light_profile
        - input_boolean.kitchen_separate_light_profile
        - input_boolean.living_room_separate_light_profile
        - input_boolean.office_separate_light_profile
        - input_boolean.storage_room_separate_light_profile
      to: 'off'
    action:
      - service: input_select.select_option
        data_template:
          entity_id: "input_select.{{ trigger.entity_id.replace('input_boolean.', '').replace('_separate_light_profile', '') }}_light_profile"
          option: "{{ states('input_select.light_profile') }}"

  - alias: Room State Active Trigger
    initial_state: true
    trigger:
      platform: state
      entity_id:
        - binary_sensor.bathroom_activity
        - binary_sensor.bedroom_activity
        - binary_sensor.hallway_activity
        - binary_sensor.kitchen_activity
        - binary_sensor.living_room_activity
        - binary_sensor.office_activity
        - binary_sensor.storage_room_activity
      to: 'on'
    condition:
      condition: template
      value_template: "{{ 'True' if is_state('input_boolean.' + trigger.entity_id.replace('binary_sensor.', '').replace('_activity', '') + '_activity_override', 'off') }}"
    action:
      service: input_select.select_option
      data_template:
        entity_id: "input_select.{{ trigger.entity_id.replace('binary_sensor.', '').replace('_activity', '') }}_room_state"
        option: 'active'

  - alias: Room State Inactive Trigger
    initial_state: true
    trigger:
      - platform: state
        entity_id: binary_sensor.bathroom_activity
        to: 'off'
        for:
          minutes: 3
      - platform: state
        entity_id: binary_sensor.bedroom_activity
        to: 'off'
        for:
          minutes: 3
      - platform: state
        entity_id: binary_sensor.hallway_activity
        to: 'off'
        for:
          minutes: 3
      - platform: state
        entity_id: binary_sensor.kitchen_activity
        to: 'off'
        for:
          minutes: 3
      - platform: state
        entity_id: binary_sensor.living_room_activity
        to: 'off'
        for:
          minutes: 3
      - platform: state
        entity_id: binary_sensor.office_activity
        to: 'off'
        for:
          minutes: 3
      - platform: state
        entity_id: binary_sensor.storage_room_activity
        to: 'off'
        for:
          minutes: 3
    condition:
      condition: template
      value_template: "{{ 'True' if is_state('input_boolean.' + trigger.entity_id.replace('binary_sensor.', '').replace('_activity', '') + '_activity_override', 'off') }}"
    action:
      service: input_select.select_option
      data_template:
        entity_id: "input_select.{{ trigger.entity_id.replace('binary_sensor.', '').replace('_activity', '') }}_room_state"
        option: 'inactive'

  - alias: Room State Off Trigger
    initial_state: true
    trigger:
      - platform: state
        entity_id: binary_sensor.bathroom_activity
        to: 'off'
        for:
          minutes: 5
      - platform: state
        entity_id: binary_sensor.bedroom_activity
        to: 'off'
        for:
          minutes: 5
      - platform: state
        entity_id: binary_sensor.hallway_activity
        to: 'off'
        for:
          minutes: 5
      - platform: state
        entity_id: binary_sensor.kitchen_activity
        to: 'off'
        for:
          minutes: 5
      - platform: state
        entity_id: binary_sensor.living_room_activity
        to: 'off'
        for:
          minutes: 5
      - platform: state
        entity_id: binary_sensor.office_activity
        to: 'off'
        for:
          minutes: 5
      - platform: state
        entity_id: binary_sensor.storage_room_activity
        to: 'off'
        for:
          minutes: 5
    condition:
      condition: template
      value_template: "{{ 'True' if is_state('input_boolean.' + trigger.entity_id.replace('binary_sensor.', '').replace('_activity', '') + '_activity_override', 'off') }}"
    action:
      service: input_select.select_option
      data_template:
        entity_id: "input_select.{{ trigger.entity_id.replace('binary_sensor.', '').replace('_activity', '') }}_room_state"
        option: 'off'

  - alias: sync_room_light_profile_from_global
    initial_state: true
    trigger:
      platform: event
      event_type: sync_room_light_profile
    action:
      - condition: and
        conditions:
          condition: template
          value_template: "{{ 'True' if is_state('input_boolean.' + trigger.event.data.room + '_separate_light_profile', 'off') }}"
      - service: input_select.select_option
        data_template:
          entity_id: "input_select.{{ trigger.event.data.room }}_light_profile"
          option: "{{ states('input_select.light_profile') }}"

  - alias: activate_room_light_profile
    initial_state: true
    trigger:
      platform: event
      event_type: activate_room_profile
    action:
      - service: script.turn_on
        data_template:
          variables:
            transition_time: "{{ states.input_number.scene_transition_time.state | float }}"
          entity_id: >
            {%- if is_state('input_select.' + trigger.event.data.room + '_room_state', 'active') -%}
              {%- if is_state('input_boolean.party_mode', 'on') -%}
                script.light_profile_{{ trigger.event.data.room }}_party
              {%- else -%}
                script.light_profile_{{ trigger.event.data.room }}_{{ states('input_select.' + trigger.event.data.room + '_light_profile') | lower }}
              {%- endif -%}
            {%- elif is_state('input_select.' + trigger.event.data.room + '_room_state', 'active') -%}
              script.light_profile_{{ trigger.event.data.room }}_{{ states('input_select.' + trigger.event.data.room + '_inactive_light_profile') | lower }}
            {%- else %}
              script.light_profile_{{ trigger.event.data.room }}_off
            {%- endif -%}
