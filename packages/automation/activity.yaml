input_select:
  # TODO: Hide this in the UI.
  martin_previous_activity:
    name: Martin Previous Activity
    options:
      - Unknown

  latest_motion:
    name: Latest Motion
    options:
      - Unknown
      - Away
      - Hallway
      - Kitchen
      - Bathroom
      - Bedroom
      - Living Room
      - Office
      - Balcony

binary_sensor:
  - platform: template
    sensors:
      activity:
        value_template: >-
          {{
            is_state('binary_sensor.living_room_activity', 'on')
            or is_state('binary_sensor.bedroom_activity', 'on')
            or is_state('binary_sensor.bathroom_activity', 'on')
            or is_state('binary_sensor.kitchen_activity', 'on')
            or is_state('binary_sensor.office_activity', 'on')
            or is_state('binary_sensor.hallway_activity', 'on')
          }}
        friendly_name: Activity
        device_class: motion

      activity_last10:
        value_template: "{{ is_state('binary_sensor.activity', 'on') }}"
        friendly_name: Activity in Last 10 min
        device_class: motion
        delay_off:
          minutes: 10

      activity_last30:
        value_template: "{{ is_state('binary_sensor.activity', 'on') }}"
        friendly_name: Activity in Last 30 min
        device_class: motion
        delay_off:
          minutes: 30

automation:
  - alias: latest_motion_rooms
    initial_state: true
    trigger:
      - platform: state
        variables:
          room: "Kitchen"
        entity_id:
          - binary_sensor.kokken_any
          - binary_sensor.kokken_motion
        to: "on"

      - platform: state
        variables:
          room: "Bathroom"
        entity_id:
          - binary_sensor.badevaerelse_any
          - binary_sensor.badevaerelse_motion
        to: "on"

      - platform: state
        variables:
          room: "Bedroom"
        entity_id:
          - binary_sensor.sovevaerelse_any
          - binary_sensor.sovevaerelse_motion
          - binary_sensor.seng_bevaegelse
        to: "on"

      - platform: state
        variables:
          room: "Hallway"
        entity_id:
          - binary_sensor.gang_entre_bevaegelse
          - binary_sensor.gang_badevaerelse_bevaegelse
          - binary_sensor.hoveddor_access_control_window_door_is_open
        to: "on"

      - platform: state
        variables:
          room: "Hallway"
        entity_id:
          - lock.hoveddor_las
        to: "unlocked"

      - platform: state
        variables:
          room: "Living Room"
        entity_id:
          - binary_sensor.stue_any
          - binary_sensor.stue_motion
          - binary_sensor.sofagruppe_bevaegelse
          - binary_sensor.spisebord_bevaegelse
        to: "on"

      - platform: state
        variables:
          room: "Office"
        entity_id:
          - binary_sensor.kontor_any
          - binary_sensor.kontor_motion
        to: "on"

      - platform: template
        variables:
          room: "Balcony"
        value_template: "{{ is_state('binary_sensor.stue_altandor', 'on') and is_state('binary_sensor.altan_bevaegelse', 'on') }}"
    condition:
      - condition: state
        entity_id: binary_sensor.wasp_sensor_apartment
        state: "on"
      - condition: template
        value_template: "{{ room != 'Balcony' or is_state('binary_sensor.stue_altandor', 'on') }}"
    action:
      service: input_select.select_option
      data:
        entity_id: input_select.latest_motion
        option: "{{ room }}"

  - alias: latest_motion_away
    initial_state: true
    trigger:
      - platform: state
        entity_id:
          - binary_sensor.activity
          - binary_sensor.wasp_sensor_apartment
        to: "off"
    condition:
      - condition: state
        entity_id:
          - binary_sensor.activity
          - binary_sensor.wasp_sensor_apartment
        state: "off"
    action:
      service: input_select.select_option
      data:
        entity_id: input_select.latest_motion
        option: "Away"
