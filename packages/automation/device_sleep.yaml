automation:
  # Whole Apartment #
  - alias: Away
    initial_state: true
    trigger:
      platform: state
      entity_id: binary_sensor.martin_presence_delayed
      to: 'off'
    action:
      - service: script.playlist_end
      - service: switch.turn_off
        data:
          entity_id: switch.space_heater

  # Bathroom #
  - alias: Bathroom Speaker active trigger
    initial_state: true
    trigger:
      platform: state
      entity_id: input_select.bathroom_room_state
      to: 'active'
    action:
      service: media_player.volume_mute
      data:
        entity_id: media_player.bathroom_speaker
        is_volume_muted: false

  - alias: Bathroom Speaker inactive trigger
    initial_state: true
    trigger:
      platform: state
      entity_id: input_select.bathroom_room_state
      to: 'off'
    action:
      service: media_player.volume_mute
      data:
        entity_id: media_player.bathroom_speaker
        is_volume_muted: true

  - alias: Bathroom Speaker play inactive
    initial_state: true
    trigger:
      platform: state
      entity_id: media_player.bathroom_speaker
      to: 'playing'
    condition:
      condition: state
      entity_id: input_select.bathroom_room_state
      state: 'off'
    action:
      - delay:
          seconds: 1
      - service: media_player.volume_mute
        data:
          entity_id: media_player.bathroom_speaker
          is_volume_muted: true

  # Bedroom #
  - alias: Bedroom Speaker active trigger
    initial_state: true
    trigger:
      platform: state
      entity_id: input_select.bedroom_room_state
      to: 'active'
    action:
      service: switch.turn_on
      data:
        entity_id: switch.bedroom_speaker_switch

  - alias: Bedroom Speaker inactive trigger
    initial_state: true
    trigger:
      platform: state
      entity_id: input_select.bedroom_room_state
      to: 'off'
    action:
      service: switch.turn_off
      data:
        entity_id: switch.bedroom_speaker_switch


  # Kitchen #
  - alias: Kitchen Speaker active trigger
    initial_state: true
    trigger:
      platform: state
      entity_id: input_select.kitchen_room_state
      to: 'active'
    action:
      service: media_player.volume_mute
      data:
        entity_id: media_player.kitchen_speaker
        is_volume_muted: false

  - alias: Kitchen Speaker inactive trigger
    initial_state: true
    trigger:
      platform: state
      entity_id: input_select.kitchen_room_state
      to: 'off'
    action:
      service: media_player.volume_mute
      data:
        entity_id: media_player.kitchen_speaker
        is_volume_muted: true

  - alias: Kitchen Speaker play inactive
    initial_state: true
    trigger:
      platform: state
      entity_id: media_player.kitchen_speaker
      to: 'playing'
    condition:
      condition: state
      entity_id: input_select.kitchen_room_state
      state: 'off'
    action:
      - delay:
          seconds: 5
      - service: media_player.volume_mute
        data:
          entity_id: media_player.kitchen_speaker
          is_volume_muted: true

  - alias: kitchen_tv_chromecast
    initial_state: true
    trigger:
      platform: template
      value_template: >
        {% if is_state('media_player.kitchen_chromecast', 'off')
        or is_state('media_player.kitchen_chromecast', 'unavailable')
        or states.media_player.kitchen_chromecast == 'unknown' %}
          false
        {% else %}
          true
        {% endif %}
    condition:
      condition: state
      entity_id: input_select.kitchen_room_state
      state: 'on'
    action:
      service: switch.turn_on
      data:
        entity_id: switch.kitchen_tv_switch

  - alias: kitchen_tv_chromecast_off
    initial_state: true
    trigger:
      platform: state
      entity_id: media_player.kitchen_chromecast
      to: 'off'
      for:
        seconds: 30
    action:
      service: switch.turn_off
      data:
        entity_id: switch.kitchen_tv_switch

  - alias: Kitchen TV active trigger
    initial_state: true
    trigger:
      platform: state
      entity_id: input_select.kitchen_room_state
      to: 'active'
    condition:
      condition: template
      value_template: >
        {% if is_state('media_player.kitchen_chromecast', 'off')
        or is_state('media_player.kitchen_chromecast', 'unavailable')
        or states.media_player.kitchen_chromecast == 'unknown' %}
          false
        {% else %}
          true
        {% endif %}
    action:
      service: switch.turn_on
      data:
        entity_id: switch.kitchen_tv_switch

  - alias: Kitchen TV inactive trigger
    initial_state: true
    trigger:
      - platform: state
        entity_id: input_select.kitchen_room_state
        to: 'inactive'
      - platform: state
        entity_id: input_select.kitchen_room_state
        to: 'off'
    action:
      service: switch.turn_off
      data:
        entity_id: switch.kitchen_tv_switch

  # Office #
  - alias: Office Speaker active trigger
    initial_state: true
    trigger:
      platform: state
      entity_id: input_select.office_room_state
      to: 'active'
    action:
      service: switch.turn_on
      data:
        entity_id: switch.office_speaker_switch

  - alias: Office Speaker inactive trigger
    initial_state: true
    trigger:
      platform: state
      entity_id: input_select.office_room_state
      to: 'off'
    action:
      service: switch.turn_off
      data:
        entity_id: switch.office_speaker_switch

  # - alias: Projector Soundbar inactive trigger
  # initial_state: true
  # trigger:
  #     platform: state
  #     entity_id: input_select.office_room_state
  #     to: 'off'
  #   action:
  #     service: switch.turn_off
  #     data:
  #       entity_id: switch.projector_soundbar_power

  # - alias: Office space heater turn on
  # initial_state: true
  # trigger:
  #     platform: state
  #     entity_id: input_select.office_room_state
  #     to: 'active'
  #   condition:
  #     condition: numeric_state
  #     entity_id: 'sensor.office_temperature'
  #     below: '21'
  #   action:
  #     service: switch.turn_on
  #     data:
  #       entity_id: switch.space_heater

  # Livingroom #
  - alias: Livingroom Speaker trigger
    initial_state: true
    trigger:
      platform: state
      entity_id: input_select.livingroom_room_state
      to: 'active'
    action:
      service: media_player.volume_mute
      data:
        entity_id: media_player.tv_soundbar_songpal
        is_volume_muted: false

  - alias: Livingroom inactive trigger
    initial_state: true
    trigger:
      platform: state
      entity_id: input_select.livingroom_room_state
      to: 'off'
    action:
      - service: switch.turn_off
        data:
          entity_id: switch.living_room_tv_power
      - service: media_player.volume_mute
        data:
          entity_id: media_player.tv_soundbar_songpal
          is_volume_muted: true

  - alias: Livingroom Speaker play inactive
    initial_state: true
    trigger:
      platform: state
      entity_id: media_player.living_room_soundbar
      to: 'playing'
    condition:
      condition: state
      entity_id: input_select.livingroom_room_state
      state: 'off'
    action:
      - delay:
          seconds: 5
      - service: media_player.volume_mute
        data:
          entity_id: media_player.tv_soundbar_songpal
          is_volume_muted: true

  # Turn off soundbar if unused for 1 minute.
  # - alias: Livingroom Soundbar inactive
  # initial_state: true#   
  # trigger:
  #     - platform: state
  #       entity_id: media_player.living_room_soundbar
  #       to: 'off'
  #       for:
  #         minutes: 1
  #     - platform: state
  #       entity_id: device_tracker.ping_tv
  #       to: 'off'
  #       for:
  #         minutes: 1
  #   condition:
  #     condition: and
  #     conditions:
  #       - condition: state
  #         entity_id: input_boolean.home_assistant_started
  #         state: 'on'
  #       - condition: state
  #         entity_id: media_player.living_room_soundbar
  #         state: 'off'
  #       - condition: state
  #         entity_id: device_tracker.ping_tv
  #         state: 'off'
  #   action:
  #     - service: media_player.turn_off
  #       data:
  #         entity_id: media_player.tv_soundbar_songpal


  # Home #
  - alias: Home inactive trigger
    initial_state: true
    trigger:
      platform: state
      entity_id: binary_sensor.martin_presence
      to: 'off'
    action:
      service: switch.turn_off
      data:
        entity_id:
          - switch.living_room_tv_power
          - switch.tv_soundbar_soundpal
          - switch.space_heater
