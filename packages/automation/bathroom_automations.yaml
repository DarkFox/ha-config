input_boolean:
  bathroom_door_activity:
    initial: off
    name: Badeværelse Dør Aktivitet
  bathroom_occupied:
    name: Badeværelse Optaget

binary_sensor:
  - platform: template
    sensors:
      bathroom_door_activity:
        friendly_name: Badeværelse Dør Aktivitet
        device_class: motion
        entity_id: input_boolean.bathroom_door_activity
        value_template: "{{ is_state('input_boolean.bathroom_door_activity', 'on') }}"
      bathroom_occupied:
        friendly_name: Badeværelse Optaget
        device_class: occupancy
        entity_id: input_boolean.bathroom_occupied
        value_template: "{{ is_state('input_boolean.bathroom_occupied', 'on') }}"

input_number:
  handwash_timer:
    name: Håndvask Timer
    icon: mdi:water-pump
    min: 0
    max: 20
    step: 1

script:
  handwash_timer_start:
    sequence:
      - service: input_number.set_value
        data:
          entity_id: input_number.handwash_timer
          value: 0
      - event: handwash_timer_tick
        event_data:
          type: start

automation:
  - alias: handwash_timer_loop
    trigger:
      - platform: event
        event_type: handwash_timer_tick
    condition:
      - condition: numeric_state
        entity_id: input_number.handwash_timer
        below: 20
    action:
      - delay:
          seconds: 0.9
      - service: input_number.increment
        data:
          entity_id: input_number.handwash_timer
      - event: handwash_timer_tick
        event_data:
          type: tick

  - alias: handwash_timer_light_progress
    trigger:
      - platform: state
        entity_id: input_number.handwash_timer
    condition:
      - condition: numeric_state
        entity_id: input_number.handwash_timer
        below: 18
    action:
      - service: wled.effect
        data_template:
          entity_id: light.badevaerelse_skab
          effect: Solid Pattern
          intensity: 17
          speed: "{{ 11 + (states('input_number.handwash_timer')|int) }}"

  - alias: handwash_timer_light
    trigger:
      - platform: template
        value_template: "{{ states('input_number.handwash_timer')|int == 18 }}"
    action:
      - service: wled.effect
        data_template:
          entity_id: light.badevaerelse_skab
          effect: Blink
          intensity: 127
          speed: 196

  - alias: handwash_timer_light
    trigger:
      - platform: template
        value_template: "{{ states('input_number.handwash_timer')|int == 20 }}"
    action:
      - service: wled.effect
        data_template:
          entity_id: light.badevaerelse_skab
          effect: Solid
          intensity: 127
          speed: 32

  - alias: bathroom_door_activity_on
    initial_state: true
    trigger:
      - platform: state
        entity_id: binary_sensor.badevaerelse_dor
    action:
      - service: input_boolean.turn_on
        data:
          entity_id: input_boolean.bathroom_door_activity

  - alias: bathroom_door_activity_off
    initial_state: true
    trigger:
      - platform: state
        entity_id: input_boolean.bathroom_door_activity
        to: 'on'
        for:
          seconds: 5
    action:
      - service: input_boolean.turn_off
        data:
          entity_id: input_boolean.bathroom_door_activity

  - alias: bathroom_occupied
    initial_state: true
    trigger:
      platform: state
      entity_id: binary_sensor.badevaerelse_dor
      to: 'off'
      for:
        seconds: 10
    condition:
      condition: state
      entity_id: binary_sensor.toilet_sensor
      state: 'on'
    action:
      - service: input_boolean.turn_on
        data:
          entity_id: input_boolean.bathroom_occupied
  
  - alias: bathroom_door_opened_after_occupied
    initial_state: true
    trigger:
      platform: state
      entity_id: binary_sensor.badevaerelse_dor
      to: 'on'
    condition:
      condition: state
      entity_id: input_boolean.bathroom_occupied
      state: 'on'
    action:
      - service: input_boolean.turn_off
        data:
          entity_id: input_boolean.bathroom_occupied

  - alias: bathroom_reset
    initial_state: true
    trigger:
      - platform: state
        entity_id:
          - binary_sensor.toilet_sensor
          - binary_sensor.bruseniche_vand
        to: 'off'
        for:
          minutes: 10
    condition:
      condition: and
      conditions:
        - condition: state
          entity_id: input_boolean.bathroom_occupied
          state: 'on'
        - condition: state
          entity_id: binary_sensor.toilet_sensor
          state: 'off'
        - condition: state
          entity_id: binary_sensor.bruseniche_vand
          state: 'off'
    action:
      - service: input_boolean.turn_off
        data:
          entity_id: input_boolean.bathroom_occupied
