input_boolean:
  force_on_call:

template:
  - binary_sensor:
      - name: Working From Home
        state: "{{ is_state('calendar.arbejde_arbejder_hjemmefra', 'on') }}"
      - name: On Call
        state: >-
          {{
            is_state('calendar.vagtplan_vagt', 'on')
            or (
              is_state('binary_sensor.puzzel_status', 'on')
              and 'vagt' in (state_attr('binary_sensor.puzzel_status', 'profil')|lower)
            )
            or is_state('input_boolean.force_on_call', 'on')
          }}
      - name: Scheduled On Call
        state: >-
          {{
            is_state('input_boolean.force_on_call', 'on')
            or (
              is_state('calendar.vagtplan_vagt', 'on')
              and is_state('binary_sensor.scheduled_at_work', 'off')
            )
          }}
      - name: Scheduled At Work
        state: >
          {{
            is_state('calendar.vagtplan_arbejde', 'on') and
            (states('sensor.at_work_end_time')|as_timestamp) > (now()|as_timestamp)
          }}
      - name: Location At Work
        state: >
          {{
            is_state('device_tracker.arbejdstelefon', 'RSR')
            or is_state('device_tracker.arbejdstelefon', 'RSH')
          }}
      - name: Working
        state: >
          {{
            is_state('binary_sensor.scheduled_at_work', 'on')
            or is_state('binary_sensor.scheduled_on_call', 'on')
            or is_state('binary_sensor.location_at_work', 'on')
            or is_state('binary_sensor.working_from_home', 'on')
          }}
  - sensor:
      - name: At work end time
        state: >-
          {% set hours = (state_attr('calendar.vagtplan_arbejde', 'message') | regex_findall(find='^(\d+)-(\d+).+'))[0] %}
          {% set start_time = state_attr('calendar.vagtplan_arbejde', 'start_time')|as_timestamp %}
          {% set end_time = (start_time) + (((hours[1]|int)-(hours[0]|int))*3600) %}
          {{ end_time|as_datetime|as_local }}

automation:
  - id: puzzel_menu
    initial_state: true
    alias: Puzzel menu
    trigger:
      - platform: event
        event_type: telegram_callback
        event_data:
          command: "/puzzel"
      - platform: event
        event_type: telegram_command
        event_data:
          command: "/puzzel"
    action:
      - service: automation.trigger
        target:
          entity_id: automation.puzzel_state_confirmation
      - service: notify.telegram_darkfox
        data:
          message: "Menu:"
          data:
            inline_keyboard:
              - "Log af:/puzzel_log_off, Log på:/puzzel_login"

  - id: puzzel_state_confirmation
    alias: Puzzel state confirmation
    trigger:
      - platform: state
        entity_id: sensor.puzzel_profil
    condition:
      - condition: template
        value_template: "{{ trigger.from_state.state != 'unknown' }}"
      - condition: not
        conditions:
          - condition: state
            entity_id: sensor.puzzel_profil
            state: "unknown"
    action:
      - service: notify.telegram_darkfox
        data:
          message: >-
            {% if is_state('sensor.puzzel_profil', 'Logget af') %}
              Logget af Puzzel
            {% else %}
              Logget på Puzzel - {{ states('sensor.puzzel_profil') }}
            {% endif %}

  - id: puzzel_log_on_menu
    initial_state: true
    alias: Puzzel log on menu
    trigger:
      - platform: state
        entity_id: binary_sensor.working
        to: "on"
        for:
          minutes: 5
    condition:
      - alias: "Not logged into an on call queue"
        condition: template
        value_template: "{{ is_state('sensor.puzzel_profil', 'Logget af') }}"
    action:
      - service: notify.telegram_darkfox
        data:
          message: "Log på Puzzel?"
          data:
            inline_keyboard: >-
              {{ state_attr('sensor.puzzel_status', 'result').profiles | map(attribute='name') | map('regex_replace', '\A(.*)\Z', '\\1:/puzzel_login \\1') | list }}

  - id: puzzel_remind_on_call
    initial_state: true
    alias: Remind me to log into on call queue
    trigger:
      - platform: state
        entity_id: binary_sensor.scheduled_on_call
        to: "on"
    condition:
      - alias: "Not logged into an on call queue"
        condition: template
        value_template: "{{ not is_state('sensor.puzzel_profil', 'Vagt') }}"
    action:
      - service: notify.telegram_darkfox
        data:
          message: "Skift til vagt køen?"
          data:
            inline_keyboard:
              - "Log på Vagt:/puzzel_login Vagt"

  - id: puzzel_remind_log_off
    initial_state: true
    alias: Remind me to log off Puzzel
    trigger:
      - platform: state
        entity_id:
          - binary_sensor.working
          - binary_sensor.scheduled_on_call
    condition:
      - condition: and
        conditions:
          - condition: state
            entity_id: binary_sensor.working
            state: "off"
          - condition: state
            entity_id: binary_sensor.scheduled_on_call
            state: "off"
          - condition: state
            entity_id: binary_sensor.puzzel_status
            state: "on"
    action:
      - service: notify.telegram_darkfox
        data:
          message: "Du er stadig logget på Puzzel!"
          data:
            inline_keyboard:
              - "Log af:/puzzel_log_off"

  - id: telegram_bot_log_off_puzzel
    alias: "Telegram bot log off puzzel"
    initial_state: true
    trigger:
      - platform: event
        event_type: telegram_callback
        event_data:
          command: "/puzzel_log_off"
      - platform: event
        event_type: telegram_command
        event_data:
          command: "/puzzel_log_off"
    action:
      - service: telegram_bot.answer_callback_query
        data:
          callback_query_id: "{{ trigger.event.data.id }}"
          message: "Logger af Puzzel..."
      - service: script.puzzel_log_off

  - id: telegram_bot_log_on_puzzel
    alias: "Telegram bot log on Puzzel"
    initial_state: true
    trigger:
      - platform: event
        event_type: telegram_callback
        event_data:
          command: "/puzzel_login"
      - platform: event
        event_type: telegram_command
        event_data:
          command: "/puzzel_login"
    action:
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ not trigger.event.data['args'] }}"
            sequence:
              - service: automation.trigger
                target:
                  entity_id: automation.puzzel_log_on_menu
        default:
          - service: telegram_bot.answer_callback_query
            data:
              callback_query_id: "{{ trigger.event.data.id }}"
              message: "Logger på {{ trigger.event.data['args'] | join(' ') }}..."
          - service: script.puzzel_log_on
            data:
              queue: "{{ trigger.event.data['args'] | join(' ') }}"

  - id: set_work_phone_modes
    initial_state: true
    alias: Set Work Phone Modes
    trigger:
      - platform: state
        entity_id:
          - binary_sensor.working
          - sensor.arbejdstelefon_do_not_disturb_sensor
          - sensor.arbejdstelefon_ringer_mode
    action:
      - choose:
          - conditions:
              - alias: "Prevent silencing phone when on call or at work"
                condition: template
                value_template: >-
                  {{
                    is_state('binary_sensor.working', 'on')
                  }}
            sequence:
              - service: notify.mobile_app_arbejdstelefon
                data:
                  message: "command_ringer_mode"
                  data:
                    command: normal
              - service: notify.mobile_app_arbejdstelefon
                data:
                  message: "command_dnd"
                  data:
                    command: "off"
          - conditions:
              - alias: "Silence phone when going off call/work"
                condition: template
                value_template: >-
                  {{
                    is_state('binary_sensor.working', 'off')
                  }}
            sequence:
              - service: notify.mobile_app_arbejdstelefon
                data:
                  message: "command_ringer_mode"
                  data:
                    command: "vibrate"
              - service: notify.mobile_app_arbejdstelefon
                data:
                  message: "command_dnd"
                  data:
                    command: "priority_only"
