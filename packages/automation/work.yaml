template:
  - binary_sensor:
      - name: Working today
        unique_id: 809cc454-99f8-42e3-ad24-1604a8b00485
        state: >-
          {% from 'easy_time.jinja' import count_the_days %}
          {% if is_state('binary_sensor.vagtskema', 'on') %}
            true
          {% elif has_value('binary_sensor.vagtskema') and 'next' in states.binary_sensor.vagtskema.attributes %}
            {% set next = state_attr('binary_sensor.vagtskema', 'next') %}
            {% if next %}
              {% set start_time = next.start | as_datetime | as_local %}
              {{ count_the_days(start_time)|int < 1 }}
            {% else %}
              false
            {% endif %}
          {% else %}
            false
          {% endif %}

      - name: Location At Work
        unique_id: f01e9654-79b3-49e9-a513-40f9b6b7551c
        state: >
          {{
            'RSR' in states('device_tracker.arbejdstelefon')
            or 'RSH' in states('device_tracker.arbejdstelefon')
          }}

      - name: Working
        unique_id: 63182272-ecd8-4a8e-90a2-f7731abb9459
        state: >
          {{
            is_state('binary_sensor.vagtskema_on_site', 'on')
            or is_state('binary_sensor.location_at_work', 'on')
            or is_state('binary_sensor.vagtskema_wfh', 'on')
          }}

script:
  leave_work_early:
    alias: Tag hjem tidligt
    sequence:
      - action: switch.turn_on
        target:
          entity_id: switch.id_3_pro_climatisation

automation:
  - id: set_work_phone_modes
    initial_state: true
    alias: Set Work Phone Modes
    mode: queued
    triggers:
      - trigger: state
        entity_id: sensor.arbejdstelefon_phone_state
        to:
          - ringing
          - offhook
      - trigger: state
        entity_id:
          - binary_sensor.working
          - sensor.arbejdstelefon_do_not_disturb_sensor
          - sensor.arbejdstelefon_ringer_mode
    actions:
      - choose:
          - conditions:
              - alias: "Prevent silencing phone when on call or at work"
                condition: template
                value_template: >-
                  {{
                    is_state('binary_sensor.working', 'on')
                  }}
            sequence:
              - action: notify.mobile_app_arbejdstelefon
                data:
                  message: "command_ringer_mode"
                  data:
                    command: normal
                    ttl: 0
                    priority: high
              - action: notify.mobile_app_arbejdstelefon
                data:
                  message: "command_dnd"
                  data:
                    command: "off"
                    ttl: 0
                    priority: high
          - conditions:
              - alias: "Silence phone when going off call/work"
                condition: template
                value_template: >-
                  {{
                    is_state('binary_sensor.working', 'off')
                  }}
            sequence:
              - action: notify.mobile_app_arbejdstelefon
                data:
                  message: "command_ringer_mode"
                  data:
                    command: "vibrate"
                    ttl: 0
                    priority: high
              - action: notify.mobile_app_arbejdstelefon
                data:
                  message: "command_dnd"
                  data:
                    command: "priority_only"
                    ttl: 0
                    priority: high
