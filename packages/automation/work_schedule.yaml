automation:
  - alias: Sync Work Schedule to Personal Calendar
    description: "Automatically sync work schedule from work calendar to personal calendar every sunday evening."
    id: 150c1ace-7884-4f82-a3ca-71bdf2b1011c
    initial_state: true
    triggers:
      - trigger: time
        at: "20:00:00"
        weekday:
          - sun
    actions:
      - action: script.add_work_schedule_to_personal_calendar

script:
  add_work_schedule_to_personal_calendar:
    alias: "Sync Work Schedule to Personal Calendar"
    description: "Fetch work schedule from work calendar and add to personal calendar, avoiding duplicates."
    fields:
      from_date:
        description: "Start date for the work schedule sync (YYYY-MM-DD) - Defaults to start of next week"
        example: "2024-07-01"
      to_date:
        description: "End date for the work schedule sync (YYYY-MM-DD) - Defaults to 4 weeks from start date"
        example: "2024-07-31"
    variables:
      work_schedule_entity: "calendar.vagtplan"
      personal_calendar_entity: "calendar.calendar"
      # Default to start of next week and 4 weeks later if not provided
      from_date: >-
        {{ 
          from_date if from_date else
          (now().date() + timedelta(days=(7 - now().weekday()))).strftime('%Y-%m-%d')
        }}
      to_date: >-
        {{ 
          to_date if to_date else
          (from_date|as_datetime + timedelta(days=27)).strftime('%Y-%m-%d')
        }}
      work_schedule: []
    sequence:
      - action: calendar.get_events
        target:
          entity_id: "{{ personal_calendar_entity }}"
        data:
          start_date_time: "{{ from_date }}T00:00:00"
          end_date_time: "{{ to_date }}T23:59:59"
        response_variable: personal_calendar_response
      - variables:
          personal_calendar_events: >-
            {{
              personal_calendar_response.get(personal_calendar_entity, {}).get('events', [])
            }}
          personal_calendar_personal_events: >-
            {{
              personal_calendar_events
              | rejectattr('description', 'search', '#autoWorkEvent')
              | list
            }}
          personal_calendar_work_events: >-
            {{
              personal_calendar_events
              | selectattr('description', 'search', '#autoWorkEvent')
              | list
            }}

      - action: calendar.get_events
        target:
          entity_id: "{{ work_schedule_entity }}"
        data:
          start_date_time: "{{ from_date }}T00:00:00"
          end_date_time: "{{ to_date }}T23:59:59"
        response_variable: work_calendar_response

      - variables:
          schedule_calendar_events: >-
            {{
              work_calendar_response.get(work_schedule_entity, {}).get('events', [])
              | rejectattr('summary', 'match', '(.*)(Fravær|fravær|FRI|Fri|Ferie|Afspadsering|Sygdom)(.*)')
              | list
            }}
          work_schedule: >-
            {% set ns = namespace(events=[]) %}
            {% for event in schedule_calendar_events %}
              {% set start = as_datetime(event.start) %}
              {% set end = as_datetime(event.end) %}
              {% if '+RV' in event.summary %}
                {% set shift_end_time = event.summary.split('+RV')[0].strip().split('-')[1].strip() %}
                {% set split_datetime = start.replace(hour=shift_end_time|int(0)) %}
                {% set ns.events = ns.events + [{
                  'summary': 'Arbejde: Herlev',
                  'location': 'Borgmester Ib Juuls Vej 56, 2730 Herlev, Denmark',
                  'description': (event.description|default('')) ~ '\n\n#bil  #onsite #dfsh #vagtskema #autoWorkEvent',
                  'start': (start | string),
                  'end': (split_datetime | string)
                }] %}
                {% set ns.events = ns.events + [{
                  'summary': 'Arbejde: Rådighedsvagt',
                  'description': (event.description|default('')) ~ '\n\n#oncall #nowake #vagtskema #autoWorkEvent',
                  'start': (split_datetime | string),
                  'end': (end | string)
                }] %}
              {% elif event.summary | regex_match('RVDøgn|RV\d{1,2}-\d{1,2} - IT') %}
                {% set ns.events = ns.events + [{
                  'summary': 'Arbejde: Rådighedsvagt',
                  'description': (event.description|default('')) ~ '\n\n#oncall #nowake #vagtskema #autoWorkEvent',
                  'start': (start | string),
                  'end': (end | string)
                }] %}
              {% elif event.summary | regex_match('\d{1,2}-\d{1,2} - IT') %}
                {% set ns.events = ns.events + [{
                  'summary': 'Arbejde: Herlev',
                  'location': 'Borgmester Ib Juuls Vej 56, 2730 Herlev, Denmark',
                  'description': (event.description|default('')) ~ '\n\n#bil #onsite #dfsh #vagtskema #autoWorkEvent',
                  'start': (start | string),
                  'end': (end | string)
                }] %}
              {% else %}
                {% set ns.events = ns.events + [{
                  'summary': 'Arbejde: ' ~ event.summary,
                  'description': (event.description|default('')) ~ '\n\n#vagtskema #autoWorkEvent',
                  'start': (start | string),
                  'end': (end | string)
                }] %}
              {% endif %}
            {% endfor %}

            {% for event in ns.events | selectattr('description', 'search', '#onsite') %}
              {% set start_dt = as_datetime(event.start) - timedelta(minutes=30) %}
              {% set end_dt = as_datetime(event.start) %}
              {% set ns.events = ns.events + [{
                'summary': 'Arbejde: Kørsel til arbejde',
                'description': '#routine #commute #autoWorkEvent',
                'start': (start_dt | string),
                'end': (end_dt | string)
              }] %}
            {% endfor %}

            {{ ns.events | sort(attribute='start') }}

      - repeat:
          for_each: "{{ work_schedule }}"
          sequence:
            - variables:
                conflicting_work_events: >-
                  {% set s = repeat.item.start | as_datetime | as_local %}
                  {% set e = repeat.item.end   | as_datetime | as_local %}
                  {% set ns = namespace(conflicts = []) %}

                  {% for ev in personal_calendar_work_events %}
                    {% set evs = ev.start | as_datetime | as_local %}
                    {% set eve = ev.end   | as_datetime | as_local %}
                    {% if evs < e and eve > s %}
                      {% set ns.conflicts = ns.conflicts + [ev] %}
                    {% endif %}
                  {% endfor %}

                  {{ ns.conflicts }}

            - choose:
                - alias: Conflicting work event found, but times are different
                  conditions:
                    - condition: template
                      value_template: >
                        {{
                          conflicting_work_events | length > 0
                          and
                          conflicting_work_events |
                          selectattr('summary', 'equalto', repeat.item.summary) |
                          selectattr('start', 'equalto', repeat.item.start | replace(' ', 'T')) |
                          selectattr('end', 'equalto', repeat.item.end | replace(' ', 'T')) |
                          list | length == 0
                        }}
                  sequence:
                    - action: persistent_notification.create
                      data:
                        title: "Work Schedule Update Detected"
                        message: >-
                          An existing work schedule event "{{ repeat.item.summary }}"
                          on {{ (repeat.item.start | as_datetime | as_local).strftime('%Y-%m-%d %H:%M') }}
                          to {{ (repeat.item.end | as_datetime | as_local).strftime('%Y-%m-%d %H:%M') }}
                          has been updated in shift schedule. Please review your calendar.
                - alias: No conflicting events, proceed to add
                  conditions:
                    - condition: template
                      value_template: "{{ conflicting_work_events | length < 1 }}"
                  sequence:
                    - action: calendar.create_event
                      target:
                        entity_id: "{{ personal_calendar_entity }}"
                      data:
                        summary: "{{ repeat.item.summary }}"
                        location: "{{ repeat.item.location | default('') }}"
                        description: "{{ repeat.item.description }}"
                        start_date_time: "{{ repeat.item.start }}"
                        end_date_time: "{{ repeat.item.end }}"

                    - variables:
                        conflicting_personal_events: >-
                          {% set s = repeat.item.start | as_datetime | as_local %}
                          {% set e = repeat.item.end   | as_datetime | as_local %}
                          {% set ns = namespace(conflicts = []) %}

                          {% for ev in personal_calendar_personal_events %}
                            {% set evs = ev.start | as_datetime | as_local %}
                            {% set eve = ev.end   | as_datetime | as_local %}
                            {% if evs < e and eve > s %}
                              {% set ns.conflicts = ns.conflicts + [ev] %}
                            {% endif %}
                          {% endfor %}

                          {{ ns.conflicts }}

                    - condition: template
                      value_template: "{{ conflicting_personal_events | length > 0 }}"

                    - action: persistent_notification.create
                      data:
                        title: "Work Schedule Conflict Detected"
                        message: >-
                          A work schedule event "{{ repeat.item.summary }}" from
                          {{ (repeat.item.start | as_datetime | as_local).strftime('%Y-%m-%d %H:%M') }} to {{ (repeat.item.end | as_datetime | as_local).strftime('%Y-%m-%d %H:%M') }} conflicts with these personal events:
                          {% for event in conflicting_personal_events %}
                            - "{{ event.summary }}" from {{ (event.start | as_datetime | as_local).strftime('%Y-%m-%d %H:%M') }} to {{ (event.end | as_datetime | as_local).strftime('%Y-%m-%d %H:%M') }}
                          {% endfor %}
                          Please review your calendar.
