automation:
  - id: climatise_car_for_commute_to_work
    alias: climatise_car_for_commute_to_work
    trigger:
      - platform: state
        entity_id: binary_sensor.commute_soon
        to: "on"
    condition:
      - alias: "If at home"
        condition: state
        entity_id: person.martin
        state: "home"
    action:
      - alias: "Climatise car"
        service: switch.turn_on
        target:
          entity_id: switch.vw_connect_climatisation

  - id: climatise_car_for_commute_from_work
    alias: climatise_car_for_commute_from_work
    trigger:
      - platform: state
        entity_id: binary_sensor.going_home_soon
        to: "on"
    condition:
      - alias: "If at work"
        condition: state
        entity_id: person.martin
        state:
          - RSR
          - RSH
    action:
      - alias: "Climatise car"
        service: switch.turn_on
        target:
          entity_id: switch.vw_connect_climatisation

  - id: charge_car_to_90_pct_before_going_home
    alias: charge_car_to_90_pct_before_going_home
    trigger:
      - platform: state
        entity_id: binary_sensor.going_home_early_trigger
        to: "on"
    condition:
      - alias: "If at work"
        condition: state
        entity_id: person.martin
        state:
          - RSR
          - RSH
      - alias: "Car plugged in"
        condition: state
        entity_id: binary_sensor.vw_connect_plug_connected
        state: "on"
    action:
      - alias: "Set car charge target to 90%"
        service: input_number.set_value
        target:
          entity_id: input_number.id_3_target_soc
        data:
          value: 90

  - id: reset_car_target_soc_when_unplugged
    alias: reset_car_target_soc_when_unplugged
    trigger:
      - platform: state
        entity_id: binary_sensor.vw_connect_plug_connected
        from: "on"
        to: "off"
    condition:
      - alias: "If at work"
        condition: state
        entity_id: person.martin
        state:
          - RSR
          - RSH
    action:
      - alias: "Set car charge target to 80%"
        service: input_number.set_value
        target:
          entity_id: input_number.id_3_target_soc
        data:
          value: 80

  - alias: notify_car_charging
    id: notify_car_charging
    initial_state: true
    trigger:
      - platform: state
        entity_id: sensor.vw_connect_charging_state
        to: "charging"
    action:
      - service: notify.telegram_darkfox
        data:
          message: >
            Opladning startet. Bilen lader op til {{ states('sensor.vw_connect_target_soc_pct') }}%.
            Færdig ca. {{ states('sensor.vw_connect_charging_complete_at') }}

  - alias: notify_15_minutes_till_car_charged
    id: notify_15_minutes_till_car_charged
    initial_state: true
    trigger:
      - platform: numeric_state
        entity_id: sensor.vw_connect_remaining_charging_time_to_complete_min
        below: 16
        for:
          minutes: 2
    condition:
      - condition: state
        entity_id: sensor.vw_connect_charging_state
        state: "charging"
    action:
      - service: notify.telegram_darkfox
        data:
          message: "Bilen er ladt op til {{ states('sensor.vw_connect_target_soc_pct') }}% om {{ states('sensor.vw_connect_remaining_charging_time_to_complete_min') }} minutter."

  - alias: notify_car_charged
    id: notify_car_charged
    initial_state: true
    trigger:
      - platform: state
        entity_id: sensor.vw_connect_charging_state
        from: "charging"
    action:
      - service: notify.telegram_darkfox
        data:
          message: "Oplading afsluttet. Bilen er ladt op til {{ states('sensor.vw_connect_current_soc_pct') }}%."

  - alias: notify_car_climatising
    id: notify_car_climatising
    trigger:
      - platform: state
        entity_id: binary_sensor.id_3_climatising
        to: "on"
    condition:
      - condition: numeric_state
        entity_id: sensor.vw_connect_remaining_climatisation_time_min
        above: 6
    action:
      - service: notify.telegram_darkfox
        data:
          message: "Klimatiserer bilen. {{ states('sensor.vw_connect_remaining_climatisation_time_min') }} minutter tilbage."

  - alias: notify_chargers_available_work
    id: notify_chargers_available_work
    trigger:
      - platform: state
        entity_id: binary_sensor.martin_at_work_soon
        to: "on"
    condition:
      - alias: "Car not plugged in"
        condition: state
        entity_id: binary_sensor.vw_connect_plug_connected
        state: "off"
      - alias: "Car needs charging"
        condition: numeric_state
        entity_id: sensor.id_3_battery
        below: 60
    action:
      - choose:
          - conditions:
              - condition: state
                entity_id: sensor.next_work_at
                state: "rsr"
            sequence:
              - choose:
                  - conditions:
                      - condition: numeric_state
                        entity_id: sensor.rsr_p_hus_spirii_ladere
                        above: 1 # One spot likely taken by car charging from Clever charger
                    sequence:
                      - service: notify.telegram_darkfox
                        data:
                          message: "Der er {{ states('sensor.rsr_p_hus_spirii_ladere') }} Spirii ladere ledige i P-Huset."
                  - conditions:
                      - condition: numeric_state
                        entity_id: sensor.rsr_p_hus_clever_ladere
                        above: 1 # One spot reserved for carshare
                    sequence:
                      - service: notify.telegram_darkfox
                        data:
                          message: "Der er {{ states('sensor.rsr_p_hus_clever_ladere') }} Clever ladere ledige i P-Huset."
                  - conditions:
                      - condition: numeric_state
                        entity_id: sensor.rsr_hovedindgang_spirii_ladere
                        above: 0
                    sequence:
                      - service: notify.telegram_darkfox
                        data:
                          message: "Der er {{ states('sensor.rsr_hovedindgang_spirii_ladere') }} Spirii ladere ledige ved hovedindgangen."
                  - conditions:
                      - condition: numeric_state
                        entity_id: sensor.rsr_patienthotel_clever_ladere
                        above: 0
                    sequence:
                      - service: notify.telegram_darkfox
                        data:
                          message: "Der er {{ states('sensor.rsr_patienthotel_clever_ladere') }} ladere ledige ved patienthotellet."
                  - conditions:
                      - condition: numeric_state
                        entity_id: sensor.rsr_hovedindgang_clever_ladere
                        above: 0
                    sequence:
                      - service: notify.telegram_darkfox
                        data:
                          message: "Der er {{ states('sensor.rsr_hovedindgang_clever_ladere') }} Clever ladere ledige ved hovedindgangen."
                  - conditions:
                      - condition: numeric_state
                        entity_id: sensor.rsr_hovedindgang_eon_ladere
                        above: 0
                    sequence:
                      - service: notify.telegram_darkfox
                        data:
                          message: "Der er {{ states('sensor.rsr_hovedindgang_eon_ladere') }} Eon ladere ledige ved hovedindgangen."
                  - conditions:
                      - condition: numeric_state
                        entity_id: sensor.rsr_nordflojen_eon_ladere
                        above: 0
                    sequence:
                      - service: notify.telegram_darkfox
                        data:
                          message: "Der er {{ states('sensor.rsr_nordflojen_eon_ladere') }} Eon ladere ledige ved nordfløjen."
                  - conditions:
                      - condition: numeric_state
                        entity_id: sensor.rsr_blegdamsvej_spirii_ladere
                        above: 0
                    sequence:
                      - service: notify.telegram_darkfox
                        data:
                          message: "Der er {{ states('sensor.rsr_blegdamsvej_spirii_ladere') }} Spirii ladere ledige på den anden side af Blegdamsvej."
          - conditions:
              - condition: state
                entity_id: sensor.next_work_at
                state: "rsh"
            sequence:
              - choose:
                  - conditions:
                      - condition: numeric_state
                        entity_id: sensor.rsh_p2_clever_ladere
                        above: 0
                    sequence:
                      - service: notify.telegram_darkfox
                        data:
                          message: "Der er {{ states('sensor.rsh_p2_clever_ladere') }} Clever ladere ledige i P2."
                  - conditions:
                      - condition: numeric_state
                        entity_id: sensor.rsh_p2_eon_ladere
                        above: 0
                    sequence:
                      - service: notify.telegram_darkfox
                        data:
                          message: "Der er {{ states('sensor.rsh_p2_eon_ladere') }} Eon ladere ledige i P2."
                  - conditions:
                      - condition: numeric_state
                        entity_id: sensor.rsh_p4_spirii_ladere
                        above: 0
                    sequence:
                      - service: notify.telegram_darkfox
                        data:
                          message: "Der er {{ states('sensor.rsh_p4_spirii_ladere') }} Spirii ladere ledige på P4."
                  - conditions:
                      - condition: numeric_state
                        entity_id: sensor.rsh_p7_spirii_ladere
                        above: 0
                    sequence:
                      - service: notify.telegram_darkfox
                        data:
                          message: "Der er {{ states('sensor.rsh_p7_spirii_ladere') }} Spirii ladere ledige på P7."

  - alias: notify_charger_available_rsr
    id: notify_charger_available_rsr
    trigger:
      - platform: state
        entity_id: sensor.rsr_p_hus_spirii_ladere
    condition:
      - alias: "Car not plugged in"
        condition: state
        entity_id: binary_sensor.vw_connect_plug_connected
        state: "off"
      - alias: "Car needs charging"
        condition: numeric_state
        entity_id: sensor.id_3_battery
        below: 50
      - alias: "Is at RSR"
        condition: state
        entity_id: device_tracker.arbejdstelefon
        state: "RSR"
      - alias: "Charger available"
        condition: numeric_state
        entity_id: sensor.rsr_p_hus_spirii_ladere
        above: 1
    action:
      - service: notify.telegram_darkfox
        data:
          message: "En ladeplads i P-Huset er lige blevet ledig."
