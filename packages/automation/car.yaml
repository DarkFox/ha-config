# proximity:
#   bil_to_home:
#     zone: home
#     devices: device_tracker.bil
#     unit_of_measurement: m
#     tolerance: 100

#   bil_to_rsr:
#     zone: rsr
#     devices: device_tracker.bil
#     unit_of_measurement: m
#     tolerance: 100

#   bil_to_rsh:
#     zone: rsh
#     devices: device_tracker.bil
#     unit_of_measurement: m
#     tolerance: 100

# sensor:
#   - platform: statistics
#     name: proximity_bil_to_rsr_stats
#     entity_id: proximity.bil_to_rsr
#     max_age:
#       minutes: 5

#   - platform: statistics
#     name: proximity_bil_to_rsh_stats
#     entity_id: proximity.bil_to_rsh
#     max_age:
#       minutes: 5

binary_sensor:
  - platform: template
    sensors:
      at_work_soon:
        friendly_name: "Snart På Arbejde"
        value_template: >
          {% if is_state('sensor.next_work_at', 'rsr') %}
            {{ states('proximity.martin_to_rsr')|float < 1500 }}
          {% else %}
            {{ states('proximity.martin_to_rsh')|float < 1500 }}
          {% endif %}

automation:
  - id: climatise_car_for_commute_to_work
    alias: climatise_car_for_commute_to_work
    trigger:
      - platform: state
        entity_id: binary_sensor.commute_soon
        from: "off"
        to: "on"
    condition:
      - alias: "If at home"
        condition: state
        entity_id: person.martin
        state: "home"
    action:
      - alias: "Climatise car"
        service: switch.turn_on
        target:
          entity_id: switch.vw_connect_climatisation

  - id: climatise_car_for_commute_from_work
    alias: climatise_car_for_commute_from_work
    trigger:
      - platform: state
        entity_id: binary_sensor.going_home_soon
        from: "off"
        to: "on"
    condition:
      - alias: "If at work"
        condition: state
        entity_id: person.martin
        state:
          - RSR
          - RSH
    action:
      - alias: "Climatise car"
        service: switch.turn_on
        target:
          entity_id: switch.vw_connect_climatisation

  # - id: charge_car_to_90_pct_before_going_home
  #   alias: charge_car_to_90_pct_before_going_home
  #   trigger:
  #     - platform: state
  #       entity_id: binary_sensor.going_home_early_trigger
  #       from: "off"
  #       to: "on"
  #   condition:
  #     - alias: "If at work"
  #       condition: state
  #       entity_id: person.martin
  #       state:
  #         - RSR
  #         - RSH
  #     - alias: "Car plugged in"
  #       condition: state
  #       entity_id: binary_sensor.vw_connect_plug_connected
  #       state: "on"
  #   action:
  #     - alias: "Turn off slow AC charging"
  #       service: switch.turn_off
  #       target:
  #         entity_id: switch.vw_connect_reduced_charge_current_ac
  #     - alias: "Set car charge target to 90%"
  #       service: input_number.set_value
  #       target:
  #         entity_id: input_number.id_3_target_soc
  #       data:
  #         value: 90

  # - id: reset_charge_target_after_90_pct
  #   alias: reset_charge_target_after_90_pct
  #   trigger:
  #     - platform: state
  #       entity_id: sensor.vw_connect_charging_state
  #       from: "charging"
  #   condition:
  #     - alias: "SoC target set to 90%"
  #       condition: state
  #       entity_id: input_number.id_3_target_soc
  #       state: "90"
  #   action:
  #     - alias: "Set car charge target to 80%"
  #       service: input_number.set_value
  #       target:
  #         entity_id: input_number.id_3_target_soc
  #       data:
  #         value: 80

  - alias: notify_car_charging
    id: notify_car_charging
    initial_state: true
    trigger:
      - platform: state
        entity_id: sensor.vw_connect_charging_state
        to: "charging"
    action:
      - service: notify.telegram_darkfox
        data:
          message: >
            Opladning startet. Bilen lader op til {{ states('sensor.vw_connect_target_soc_pct') }}%.
            Færdig ca. {{ states('sensor.vw_connect_charging_complete_at') }}

  - alias: notify_15_minutes_till_car_charged
    id: notify_15_minutes_till_car_charged
    initial_state: true
    trigger:
      - platform: numeric_state
        entity_id: sensor.vw_connect_remaining_charging_time_to_complete_min
        below: 16
        for:
          minutes: 2
    condition:
      - condition: state
        entity_id: sensor.vw_connect_charging_state
        state: "charging"
    action:
      - service: notify.telegram_darkfox
        data:
          message: "Bilen er ladt op til {{ states('sensor.vw_connect_target_soc_pct') }}% om {{ states('sensor.vw_connect_remaining_charging_time_to_complete_min') }} minutter."

  - alias: notify_car_charged
    id: notify_car_charged
    initial_state: true
    trigger:
      - platform: state
        entity_id: sensor.vw_connect_charging_state
        from: "charging"
    action:
      - service: notify.telegram_darkfox
        data:
          message: "Oplading afsluttet. Bilen er ladt op til {{ states('sensor.vw_connect_current_soc_pct') }}%."

  - alias: notify_car_climatising
    id: notify_car_climatising
    trigger:
      - platform: state
        entity_id: binary_sensor.id_3_climatising
        to: "on"
    condition:
      - condition: numeric_state
        entity_id: sensor.vw_connect_remaining_climatisation_time_min
        above: 6
    action:
      - service: notify.telegram_darkfox
        data:
          message: "Klimatiserer bilen til {{ state_attr('climate.id_3_klima', 'temperature') }}°. {{ states('sensor.vw_connect_remaining_climatisation_time_min') }} minutter tilbage."

  - alias: notify_chargers_available_work
    id: notify_chargers_available_work
    trigger:
      - platform: state
        entity_id: binary_sensor.at_work_soon
        to: "on"
    condition:
      - alias: "Car not plugged in"
        condition: state
        entity_id: binary_sensor.vw_connect_plug_connected
        state: "off"
      - alias: "Car needs charging"
        condition: numeric_state
        entity_id: sensor.id_3_battery
        below: 60
    action:
      - choose:
          - conditions:
              - condition: state
                entity_id: sensor.next_work_at
                state: "rsr"
            sequence:
              - service: automation.trigger
                target:
                  entity_id: automation.car_chargers_rsr
          - conditions:
              - condition: state
                entity_id: sensor.next_work_at
                state: "rsh"
            sequence:
              - service: automation.trigger
                target:
                  entity_id: automation.car_chargers_rsh

  - alias: notify_charger_available_rsr
    id: notify_charger_available_rsr
    trigger:
      - platform: state
        entity_id: sensor.rsr_p_hus_spirii_ladere
    condition:
      - alias: "Car not plugged in"
        condition: state
        entity_id: binary_sensor.vw_connect_plug_connected
        state: "off"
      - alias: "Car needs charging"
        condition: numeric_state
        entity_id: sensor.id_3_battery
        below: 50
      - alias: "Is at RSR"
        condition: state
        entity_id: person.martin
        state: "RSR"
      - alias: "Charger available"
        condition: numeric_state
        entity_id: sensor.rsr_p_hus_spirii_ladere
        above: 1
    action:
      - service: notify.telegram_darkfox
        data:
          message: "En ladeplads i P-Huset er lige blevet ledig."

  - id: car_menu
    initial_state: true
    alias: Bil Menu
    trigger:
      - platform: event
        event_type: telegram_callback
        event_data:
          command: "/bil"
      - platform: event
        event_type: telegram_command
        event_data:
          command: "/bil"
    action:
      - service: notify.telegram_darkfox
        data:
          message: >
            {% if is_state('sensor.vw_connect_charging_state', 'charging') -%}
              Opladning startet. Bilen lader op til {{ states('sensor.vw_connect_target_soc_pct') }}%.
              Færdig ca. {{ states('sensor.vw_connect_charging_complete_at') }}
            {%- else -%}
              Oplading afsluttet. Bilen er ladt op til {{ states('sensor.vw_connect_current_soc_pct') }}%.
            {%- endif %}
            {%- if states('sensor.vw_connect_remaining_climatisation_time_min')|int > 0 -%}
              Klimatiserer bilen til {{ state_attr('climate.id_3_klima', 'temperature') }}°. {{ states('sensor.vw_connect_remaining_climatisation_time_min') }} minutter tilbage.
            {%- else -%}
              Klimatisering afsluttet.
            {%- endif -%}
      - service: notify.telegram_darkfox
        data:
          message: "Menu:"
          data:
            inline_keyboard:
              - "Klimatisering:/car_climatisation, Opladning:/car_charging"

  - id: car_climatisation_menu
    initial_state: true
    alias: Bil Klimatisering Menu
    trigger:
      - platform: event
        event_type: telegram_callback
        event_data:
          command: "/car_climatisation"
      - platform: event
        event_type: telegram_command
        event_data:
          command: "/car_climatisation"
    variables:
      temp: "{{ state_attr('climate.id_3_klima', 'temperature')|int }}"
    action:
      - service: notify.telegram_darkfox
        data:
          message: "Klimatisering Menu"
          data:
            inline_keyboard:
              - "{{ 'Stop klimatisering:/car_climatisation_off' if states('sensor.vw_connect_remaining_climatisation_time_min')|int > 0 else 'Klimatiser nu:/car_climatisation_on' }}"
              - "{{ '[18°]' if temp == 18 else '18°' }}:/car_climatisation_set 18, {{ '[19°]' if temp == 19 else '19°' }}:/car_climatisation_set 19, {{ '[20°]' if temp == 20 else '20°' }}:/car_climatisation_set 20"
              - "{{ '[21°]' if temp == 21 else '21°' }}:/car_climatisation_set 21, {{ '[22°]' if temp == 22 else '22°' }}:/car_climatisation_set 22, {{ '[23°]' if temp == 23 else '23°' }}:/car_climatisation_set 23"

  - id: car_climatisation_set
    initial_state: true
    alias: Bil Klimatisering Sæt temperatur
    trigger:
      - platform: event
        event_type: telegram_callback
        event_data:
          command: "/car_climatisation_set"
      - platform: event
        event_type: telegram_command
        event_data:
          command: "/car_climatisation_set"
    action:
      - service: climate.set_temperature
        target:
          entity_id: climate.id_3_klima
        data:
          temperature: "{{ trigger.event.data['args'][0] }}"
      - service: notify.telegram_darkfox
        data:
          message: >-
            Temperatur sat til {{ trigger.event.data['args'][0] }}°.

  - id: car_climatisation_on
    initial_state: true
    alias: Bil Klimatisering Tænd
    trigger:
      - platform: event
        event_type: telegram_callback
        event_data:
          command: "/car_climatisation_on"
      - platform: event
        event_type: telegram_command
        event_data:
          command: "/car_climatisation_on"
    action:
      - service: climate.set_hvac_mode
        data:
          hvac_mode: auto
        target:
          entity_id: climate.id_3_klima

  - id: car_climatisation_off
    initial_state: true
    alias: Bil Klimatisering Stop
    trigger:
      - platform: event
        event_type: telegram_callback
        event_data:
          command: "/car_climatisation_off"
      - platform: event
        event_type: telegram_command
        event_data:
          command: "/car_climatisation_off"
    action:
      - service: climate.set_hvac_mode
        data:
          hvac_mode: "off"
        target:
          entity_id: climate.id_3_klima

  - id: car_charging_menu
    initial_state: true
    alias: Bil Opladning Menu
    trigger:
      - platform: event
        event_type: telegram_callback
        event_data:
          command: "/car_charging"
      - platform: event
        event_type: telegram_command
        event_data:
          command: "/car_charging"
    action:
      - service: notify.telegram_darkfox
        data:
          message: "Opladning Menu"
          data:
            inline_keyboard:
              - "{{ 'Stop opladning:/car_charging_off' if is_state('sensor.vw_connect_charging_state', 'charging') else 'Start opladning:/car_charging_on' }}"
              - "50%:/car_charging_set 50, 60%:/car_charging_set 60, 70%:/car_charging_set 70, 80%:/car_charging_set 80, 90%:/car_charging_set 90, 100%:/car_charging_set 100"
              - "Ladere RSH:/chargers_rsh, Ladere RSR:/chargers_rsr"

  - id: car_chargers_rsh
    initial_state: true
    alias: car_chargers_rsh
    trigger:
      - platform: event
        event_type: telegram_callback
        event_data:
          command: "/chargers_rsh"
      - platform: event
        event_type: telegram_command
        event_data:
          command: "/chargers_rsh"
    action:
      - choose:
          - conditions:
              - condition: numeric_state
                entity_id: sensor.rsh_p7_spirii_ladere
                above: 0
            sequence:
              - service: notify.telegram_darkfox
                data:
                  message: "Der er {{ states('sensor.rsh_p7_spirii_ladere') }} Spirii ladestationer ledige på P7."
          - conditions:
              - condition: numeric_state
                entity_id: sensor.rsh_p4_spirii_ladere
                above: 0
            sequence:
              - service: notify.telegram_darkfox
                data:
                  message: "Der er {{ states('sensor.rsh_p4_spirii_ladere') }} Spirii ladestationer ledige på P4."
          - conditions:
              - condition: numeric_state
                entity_id: sensor.rsh_p2_clever_ladere
                above: 0
            sequence:
              - service: notify.telegram_darkfox
                data:
                  message: "Der er {{ states('sensor.rsh_p2_clever_ladere') }} Clever ladestationer ledige i P2."
          - conditions:
              - condition: numeric_state
                entity_id: sensor.rsh_p2_eon_ladere
                above: 0
            sequence:
              - service: notify.telegram_darkfox
                data:
                  message: "Der er {{ states('sensor.rsh_p2_eon_ladere') }} Eon ladestationer ledige i P2."

  - id: car_chargers_rsr
    initial_state: true
    alias: car_chargers_rsr
    trigger:
      - platform: event
        event_type: telegram_callback
        event_data:
          command: "/chargers_rsr"
      - platform: event
        event_type: telegram_command
        event_data:
          command: "/chargers_rsr"
    action:
      - choose:
          - conditions:
              - condition: numeric_state
                entity_id: sensor.rsr_p_hus_spirii_ladere
                above: 1 # One spot likely taken by car charging from Clever charger
            sequence:
              - service: notify.telegram_darkfox
                data:
                  message: "Der er {{ states('sensor.rsr_p_hus_spirii_ladere') }} Spirii ladestationer ledige i P-Huset."
          - conditions:
              - condition: numeric_state
                entity_id: sensor.rsr_p_hus_clever_ladere
                above: 1 # One spot reserved for carshare
            sequence:
              - service: notify.telegram_darkfox
                data:
                  message: "Der er {{ states('sensor.rsr_p_hus_clever_ladere') }} Clever ladestationer ledige i P-Huset."
          - conditions:
              - condition: numeric_state
                entity_id: sensor.rsr_hovedindgang_spirii_ladere
                above: 0
            sequence:
              - service: notify.telegram_darkfox
                data:
                  message: "Der er {{ states('sensor.rsr_hovedindgang_spirii_ladere') }} Spirii ladestationer ledige ved hovedindgangen."
          - conditions:
              - condition: numeric_state
                entity_id: sensor.rsr_patienthotel_clever_ladere
                above: 0
            sequence:
              - service: notify.telegram_darkfox
                data:
                  message: "Der er {{ states('sensor.rsr_patienthotel_clever_ladere') }} ladestationer ledige ved patienthotellet."
          - conditions:
              - condition: numeric_state
                entity_id: sensor.rsr_hovedindgang_clever_ladere
                above: 0
            sequence:
              - service: notify.telegram_darkfox
                data:
                  message: "Der er {{ states('sensor.rsr_hovedindgang_clever_ladere') }} Clever ladestationer ledige ved hovedindgangen."
          - conditions:
              - condition: numeric_state
                entity_id: sensor.rsr_hovedindgang_eon_ladere
                above: 0
            sequence:
              - service: notify.telegram_darkfox
                data:
                  message: "Der er {{ states('sensor.rsr_hovedindgang_eon_ladere') }} Eon ladestationer ledige ved hovedindgangen."
          - conditions:
              - condition: numeric_state
                entity_id: sensor.rsr_nordflojen_eon_ladere
                above: 0
            sequence:
              - service: notify.telegram_darkfox
                data:
                  message: "Der er {{ states('sensor.rsr_nordflojen_eon_ladere') }} Eon ladestationer ledige ved nordfløjen."
          - conditions:
              - condition: numeric_state
                entity_id: sensor.rsr_blegdamsvej_spirii_ladere
                above: 0
            sequence:
              - service: notify.telegram_darkfox
                data:
                  message: "Der er {{ states('sensor.rsr_blegdamsvej_spirii_ladere') }} Spirii ladestationer ledige på den anden side af Blegdamsvej."
