homeassistant:
  customize:
    sensor.s_train_b_status:
      friendly_name: S-Tog Linje B Status
      entity_picture: http://www.dsb.dk/globalassets/s-tog-overblik/ikoner/b.png
    sensor.s_train_message:
      friendly_name: S-Tog Driftbesked
      icon: mdi:train
    sensor.citymapper_key:
      hidden: true
    sensor.home_latitude:
      hidden: true
    sensor.home_longitude:
      hidden: true
    sensor.work_latitude:
      hidden: true
    sensor.work_longitude:
      hidden: true

group:
  travel_time:
    name: Travel Time
    entities:
      - sensor.travel_time_to_work_driving
      - sensor.travel_time_to_work_public_transit
      - sensor.s_train_b_status
      - sensor.s_train_message

sensor:
  - platform: template
    sensors:
      work_arrival_time:
        value_template: >
          {% if now().hour > 9 %}
            {{ (as_timestamp(now()) + 86400) | timestamp_custom("%Y-%m-%d") }}T09%3A00%3A00%2B0100
          {% else %}
            {{ as_timestamp(now()) | timestamp_custom("%Y-%m-%d") }}T09%3A00%3A00%2B0100
          {% endif %}
      citymapper_key:
        value_template: !secret citymapper_key
      home_latitude:
        value_template: !secret home_latitude
      home_longitude:
        value_template: !secret home_longitude
      work_latitude:
        value_template: !secret work_latitude
      work_longitude:
        value_template: !secret work_longitude


  - platform: command_line
    command: >
     echo '"https://developer.citymapper.com/api/1/traveltime/?startcoord={{ states('sensor.home_latitude') }}%2C{{ states('sensor.home_longitude') }}&endcoord={{ states('sensor.work_latitude') }}%2C{{ states('sensor.work_longitude') }}&time_type=arrival&key={{ states('sensor.citymapper_key') }}&time={{ states('sensor.work_arrival_time') }}"' > /share/curlstring.txt;
     xargs -n 1 curl -X GET < /share/curlstring.txt
    name: Travel time to work (Public Transit)
    value_template: "{{ value_json.travel_time_minutes }}"
    unit_of_measurement: 'min'
    scan_interval: 300

  - platform: google_travel_time
    name: Travel time to work (Driving)
    api_key: !secret google_directions_secret
    origin: zone.home
    destination: !secret work_address
    options:
      mode: driving

  - platform: scrape
    resource: http://www.dsb.dk/trafikinformation/s-tog-overblik/
    name: s_train_message
    select: 'div.FooterFreeText'
    value_template: "{{ value | trim }}"
    scan_interval: 300

  - platform: scrape
    resource: http://www.dsb.dk/trafikinformation/s-tog-overblik/
    name: s_train_b_status
    select: 'table.RepeaterTable tr:nth-of-type(2) td.TDItemLabel div b'
    value_template: "{{ value | trim }}"
    scan_interval: 300
