homeassistant:
  customize:
    sensor.s_train_b_status:
      friendly_name: S-Tog Linje B Status
      entity_picture: http://www.dsb.dk/globalassets/s-tog-overblik/ikoner/b.png
    sensor.s_train_message:
      friendly_name: S-Tog Driftbesked
      icon: mdi:train
    sensor.work_arrival_time:
      hidden: true
    sensor.citymapper_key:
      hidden: true
    sensor.home_latitude:
      hidden: true
    sensor.home_longitude:
      hidden: true
    sensor.work_latitude:
      hidden: true
    sensor.work_longitude:
      hidden: true

group:
  travel_time:
    name: Travel Time
    entities:
      - sensor.travel_time_to_work_driving
      - sensor.travel_time_to_work_public_transit
      - sensor.s_train_b_status
      - sensor.s_train_message

automation:
  - alias: citymapper_updater
    trigger:
      platform: time
      minutes: '/5'
      seconds: 00
    condition:
      condition: time
      after: '7:00:00'
      before: '09:00:00'
      weekday:
        - mon
        - tue
        - wed
        - thu
        - fri
    action:
      - service: notify.citymapper_url
        data_template:
          message: 'https://developer.citymapper.com/api/1/traveltime/?startcoord={{ states("sensor.home_latitude") }}%2C{{ states("sensor.home_longitude") }}&endcoord={{ states("sensor.work_latitude") }}%2C{{ states("sensor.work_longitude") }}&time_type=arrival&key={{ states("sensor.citymapper_key") }}&time={{ states("sensor.work_arrival_time") }}'
      - service: shell_command.citymapper_get_data
      - delay:
          seconds: 5
      - service: shell_command.citymapper_cleanup

notify:
  - platform: file
    name: citymapper_url
    filename: /share/citymapper_url.txt
    timestamp: false

shell_command:
  citymapper_get_data: xargs -n 1 curl -o /share/citymapper_out.json -X GET < /share/citymapper_url.txt
  citymapper_cleanup: rm /share/citymapper_url.txt

sensor:
  - platform: template
    sensors:
      work_arrival_time:
        value_template: >
          {% if now().hour > 9 %}
            {{ (as_timestamp(now()) + 86400) | timestamp_custom("%Y-%m-%d") }}T09%3A00%3A00%2B0100
          {% else %}
            {{ as_timestamp(now()) | timestamp_custom("%Y-%m-%d") }}T09%3A00%3A00%2B0100
          {% endif %}
      citymapper_key:
        value_template: !secret citymapper_key
      home_latitude:
        value_template: !secret home_latitude
      home_longitude:
        value_template: !secret home_longitude
      work_latitude:
        value_template: !secret work_latitude
      work_longitude:
        value_template: !secret work_longitude

  - platform: file
    file_path: /share/citymapper_out.json
    name: Travel time to work (Public Transit)
    value_template: "{{ value_json.travel_time_minutes }}"
    unit_of_measurement: 'min'

  - platform: google_travel_time
    name: Travel time to work (Driving)
    api_key: !secret google_directions_secret
    origin: zone.home
    destination: !secret work_address
    options:
      mode: driving

  - platform: scrape
    resource: http://www.dsb.dk/trafikinformation/s-tog-overblik/
    name: s_train_message
    select: 'div.FooterFreeText'
    value_template: "{{ value | trim }}"
    scan_interval: 300

  - platform: scrape
    resource: http://www.dsb.dk/trafikinformation/s-tog-overblik/
    name: s_train_b_status
    select: 'table.RepeaterTable tr:nth-of-type(2) td.TDItemLabel div b'
    value_template: "{{ value | trim }}"
    scan_interval: 300
