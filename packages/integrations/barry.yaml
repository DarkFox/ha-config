sensor:
  - platform: template
    sensors:
      secret_barry_api_key:
        value_template: !secret barry_api_key
      secret_barry_mpid:
        value_template: !secret barry_mpid

  - platform: command_line
    name: Barry Elpris
    unit_of_measurement: "DKK/kWh"
    value_template: "{{ (value_json.result.value|float) | round(3) }}"
    scan_interval: 1800
    command: >-
      curl -X POST \
        'https://jsonrpc.barry.energy/json-rpc#Get%20Total%20KwH%20Price' \
        -H 'Authorization: Bearer {{states('sensor.secret_barry_api_key')}}' \
        -H 'Content-Type: application/json' \
        -d '{
          "method": "co.getbarry.api.v1.OpenApiController.getTotalKwHPrice",
          "id": 0,
          "jsonrpc": "2.0",
          "params": [
            "{{states('sensor.secret_barry_mpid')}}",
            "{{ utcnow() | as_timestamp() | timestamp_custom("%Y-%m-%dT%H:00:00Z", false) }}",
            "{{ utcnow() | as_timestamp() | timestamp_custom("%Y-%m-%dT%H:59:59Z", false) }}"
          ]
        }'

automation:
  - id: update_barry_price_at_top_of_hour
    alias: Update Barry price at top of hour
    trigger:
      - platform: time_pattern
        minutes: 0
        seconds: 1
      - platform: homeassistant
        event: start
    action:
      service: homeassistant.update_entity
      data:
        entity_id: sensor.barry_elpris
