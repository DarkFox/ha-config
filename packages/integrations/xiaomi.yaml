camera:
  - platform: xiaomi_cloud_map_extractor
    host: 192.168.42.196
    token: !secret xiaomi_token
    username: !secret xiaomi_cloud_username
    password: !secret xiaomi_cloud_password
    country: "de"
    colors:
      color_map_outside: [238, 238, 238]
      color_path: [64, 128, 255]
      color_goto_path: [255, 0, 0]
      color_predicted_path: [0, 172, 0]
    room_colors:
      "16": [52, 178, 224] # Værksted
      "17": [245, 217, 91] # Kontor
      "18": [255, 180, 117] # Soveværelse
      "19": [255, 176, 235] # Gang
      "21": [250, 126, 112] # Køkken
      "22": [184, 133, 204] # Stue
    map_transformation:
      trim:
        left: 16
        right: 16
        top: 23
        bottom: 30
    draw:
      - charger
      - path
      - goto_path
      - predicted_path
      - no_go_zones
      - no_mopping_zones
      - vacuum_position
      - virtual_walls
      # - zones
    attributes:
      - calibration_points
      - charger
      - goto
      - goto_path
      - goto_predicted_path
      - image
      - map_name
      - no_go_areas
      - no_mopping_areas
      - obstacles
      - path
      - room_numbers
      - rooms
      - vacuum_position
      - vacuum_room
      - walls
      - zones
    scan_interval:
      seconds: 10
    auto_update: true

script:
  vacuum_follow_path:
    mode: single
    alias: Vacuum follow path
    fields:
      path:
        name: Path
      entity_id:
        name: Vacuum entity
    sequence:
      - repeat:
          count: "{{ path | length }}"
          sequence:
            - service: vacuum.send_command
              data:
                entity_id: "{{ entity_id }}"
                command: app_goto_target
                params: "{{ path[repeat.index-1] }}"
            - wait_template: "{{ is_state(entity_id, 'cleaning') }}"
              timeout: 00:00:30
              continue_on_timeout: false
            - delay: 00:00:01
            - wait_template: "{{ is_state(entity_id, 'idle') or is_state(entity_id, 'paused') }}"
              timeout: 00:05:00
              continue_on_timeout: false

  send_vacuum_to_emptying_position:
    alias: "Send støvsuger til tømmeposition"
    sequence:
      - service: xiaomi_miio.vacuum_goto
        data:
          entity_id: vacuum.roborock_s5
          x_coord: 27550
          y_coord: 26450
      - alias: "update last empty count"
        service: input_text.set_value
        data:
          entity_id: input_text.vacuum_last_empty
          value: "{{ states('sensor.roborock_s5_total_clean_area') }}"

input_boolean:
  vacuum_show_card:
    name: Vis Støvsuger Menu
    icon: mdi:menu

input_text:
  vacuum_last_empty:
    name: Vacuum Last Empty
    icon: mdi:delete

sensor:
  - platform: template
    sensors:
      vacuum_area_cleaned_since_last_empty:
        friendly_name: "Areal støvsuget siden sidste tømning"
        value_template: "{{ ((states('sensor.roborock_s5_total_clean_area')|float) - (states('input_text.vacuum_last_empty')|float)) | round(2) }}"
        unit_of_measurement: m2
      vacuum_current_room:
        friendly_name: "Støvsuger Rum"
        value_template: >-
          {%- set rooms = {
            16: "Værksted",
            17: "Kontor",
            18: "Soveværelse",
            19: "Gang",
            21: "Køkken",
            22: "Stue"
          } -%}
          {{ rooms[state_attr('camera.xiaomi_cloud_map_extractor', 'vacuum_room')] }}

automation:
  - id: vacuum_show_menu_when_undocked
    alias: Vacuum Show Menu When Undocked
    initial_state: true
    trigger:
      - platform: state
        entity_id: vacuum.roborock_s5
        to:
          - cleaning
          - paused
          - idle
          - returning
          - error
    action:
      - service: input_boolean.turn_on
        target:
          entity_id: input_boolean.vacuum_show_card

  - id: vacuum_hide_menu_when_docked
    alias: Vacuum Hide Menu When Docked
    initial_state: true
    trigger:
      - platform: state
        entity_id: vacuum.roborock_s5
        to: "docked"
    action:
      - service: input_boolean.turn_off
        target:
          entity_id: input_boolean.vacuum_show_card
