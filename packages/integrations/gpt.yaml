intent_script:
  AskNabu:
    action:
      - service: conversation.process
        data:
          text: "{{query}}"
          language: "da"
          agent_id: 4e0a875b09f8a19a405e1bf3e5c4adac
        response_variable: agent
      - event: openai_response_received
        event_data:
          full_response: "{{ agent.response.speech.plain.speech }}"
    speech:
      text: "{{ states['sensor.openai_query_response'].attributes.full_response }}"

template:
  - trigger:
      platform: event
      event_type: openai_response_received
    sensor:
      - name: "OpenAI query response"
        state: "{{now()}}"
        attributes:
          full_response: "{{ trigger.event.data.full_response }}"

  - sensor:
      - name: GPT API Key
        state: !secret writesonic_api_key

      - name: GPT Prompt
        state: "{{ now() }}"
        attributes:
          prompt: >-
            {% from 'easy_time.jinja' import weekday, month %}
            Start med en venlig hilsen, informer mig om den aktuelle dag og tid, og gennemgå min daglige plan punkt for punkt. 

            {% if not is_state('sensor.vagtplan_agenda', '0') %}
            Min vagtplan er som følger: 
            {% for event in state_attr('sensor.vagtplan_agenda', 'agenda') %}
              {{event }}.
            {% endfor %}

            {% if not is_state('sensor.vagtplan_agenda', '0') %}
            Der er følgende aftaler i minarbejdskalender:
            {% for event in state_attr('sensor.arbejde_agenda', 'agenda') %}
              {{event }}.
            {% endfor %}
            {% endif %}
            {% else %}
            Jeg har fri i dag.
            {% endif %}

            {% if not is_state('sensor.personlig_agenda', '0') %}
            Min personlige kalender: 
            {% for event in state_attr('sensor.personlig_agenda', 'agenda') %}
              {{event }}.
            {% endfor %}
            {% endif %}

            {% if not is_state('sensor.tripit_agenda', '0') %}
            Mine rejseplaner: 
            {% for event in state_attr('sensor.tripit_agenda', 'agenda') %}
              {{event }}.
            {% endfor %}
            {% endif %}

            Gennemgå de seneste overskrifter fra DR nyheder.
            Kommenter på dagens vejr, og husk at inkludere temperaturen.
            Afslut med en anbefaling om hvilken påklædning der ville være passende i dag.

command_line:
  - sensor:
      name: GPT Briefing
      scan_interval: 2629743
      value_template: "{{ now() }}: {{ value | truncate(100) }}"
      json_attributes:
        - message
      command: >
        curl
        --request POST "https://api.writesonic.com/v2/business/content/chatsonic?engine=premium&language=da"
        --header "X-API-KEY: {{ states('sensor.gpt_api_key') }}"
        --header "accept: application/json"
        --header "content-type: application/json"
        --data '{
                  "enable_google_results": false,
                  "enable_memory": false,
                  "input_text": {{ state_attr('sensor.gpt_prompt', 'prompt') | replace("\n"," ") | regex_replace("  +", ' ') | tojson }}
                }'
