template:
  - sensor:
      - name: GPT API Key
        state: !secret writesonic_api_key
      - name: GPT Prompt
        state: "{{ now() }}"
        attributes:
          prompt: >-
            {% from 'easy_time.jinja' import weekday, month %}
            Funger som en personlig assistent for Martin. Du er vittig og taler samtaleagtigt.
            Hils på mig på en venlig måde, sig hvad klokken er, hvad mine planer er i dag,
            kommenter på vejret (husk at fortælle mig temperaturen), og giv en kort anbefaling om påklædning.

            Hold dig til oplysningerne i denne besked.

            Den aktuelle tid er {{ states('sensor.day_name') }} den {{ now().day }}.
            {{ states('sensor.month_name') }}, klokken {{ states('sensor.time') }}.

            {% if not is_state('sensor.vagtplan_agenda', '0') %}
            Her er min vagtplan:
            {{ state_attr('sensor.vagtplan_agenda', 'agenda') }}
            {% else %}
            Jeg har fri i dag
            {% endif %}
            {% if not is_state('sensor.personlig_agenda', '0') %}

            Her er min personlige kalender:
            {{ state_attr('sensor.personlig_agenda', 'agenda') }}
            {% endif %}
            {% if not is_state('sensor.tripit_agenda', '0') %}
            Mine rejseplaner fra tripit er:
            {{ state_attr('sensor.tripit_agenda', 'agenda') }}[
            {% endif %}

            Temperaturen udenfor lige nu er {{ states('sensor.weatherflow_air_temperature') }} °C.
            Her er dagens vejrudsigt: {{ states('sensor.dmi_vejr') }}.
            {{ state_attr('sensor.dmi_vejr_tts', 'text') }}

command_line:
  - sensor:
      name: GPT Briefing
      scan_interval: 2629743
      value_template: "{{ now() }}: {{ value | truncate(100) }}"
      json_attributes:
        - message
      command: >
        curl
        --request POST "https://api.writesonic.com/v2/business/content/chatsonic?engine=premium&language=da"
        --header "X-API-KEY: {{ states('sensor.gpt_api_key') }}"
        --header "accept: application/json"
        --header "content-type: application/json"
        --data '{
                  "enable_google_results": false,
                  "enable_memory": false,
                  "input_text": {{ state_attr('sensor.gpt_prompt', 'prompt') | replace("\n"," ") | regex_replace("  +", ' ') | tojson }}
                }'
