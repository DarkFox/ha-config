sun:

sensor:
  - platform: min_max
    name: Ude Temperatur
    type: min
    entity_ids:
      - sensor.altan_temperatur
      - sensor.lille_altan_temperatur

  - platform: thermal_comfort
    sensors:
      udenfor:
        friendly_name: Udenfor
        temperature_sensor: sensor.weatherflow_air_temperature
        humidity_sensor: sensor.weatherflow_absolute_humidity
        pressure_sensor: sensor.weatherflow_barometric_pressure

  - platform: template
    sensors:
      translated_weather_title:
        value_template: >-
          {% set translations = {
            "clear-night": "Klart, nat",
            "cloudy": "Overskyet",
            "exceptional": "Enest\u00e5ende",
            "fog": "T\u00e5ge",
            "hail": "Hagl",
            "lightning": "Lyn",
            "lightning-rainy": "Lyn, regnvejr",
            "partlycloudy": "Delvist overskyet",
            "pouring": "Regnvejr",
            "rainy": "Regnfuldt",
            "snowy": "Sne",
            "snowy-rainy": "Sne, regn",
            "sunny": "Solrig",
            "windy": "Bl\u00e6sende",
            "windy-variant": "Bl\u00e6sende"
          } %}
          {{ translations[states('weather.weatherflow_day_based_forecast')] }}

      weather_card_secondary_info:
        value_template: "({{ states('sensor.weatherflow_heat_index')|round(1) }}°) {{ state_attr('weather.weatherflow_day_based_forecast', 'forecast')[0].temperature|round }}°/{{ state_attr('weather.weatherflow_day_based_forecast', 'forecast')[0].templow|round }}°"
      weather_card_name_text:
        value_template: "{{ states('sensor.weatherflow_precipitation_today')+' mm. ' if states('sensor.weatherflow_precipitation_today') != 'None' }}{{ states('sensor.wind_text') }}"
      wind_text:
        friendly_name: Vind
        value_template: "{{ states('sensor.wind_speed_description') }}{{ ' fra '+states('sensor.weatherflow_wind_cardinal') if states('sensor.weatherflow_beaufort')|int > 1 }}"
      wind_speed_description:
        value_template: >-
          {% set translations = {
            "calm": "Stille",
            "light_air": "Næsten stille",
            "light_breeze": "Svag vind",
            "gentle_breeze": "Let vind",
            "moderate_breeze": "Jævn vind",
            "fresh_breeze": "Frisk vind",
            "strong_breeze": "Hård vind",
            "moderate_gale": "Stiv kuling",
            "fresh_gale": "Hård kuling",
            "strong_gale": "Stormende kuling",
            "storm": "Storm",
            "violent_storm": "Stærk storm",
            "hurricane": "Orkan"
          } %}
          {{ translations[states('sensor.weatherflow_beaufort_description')] }}
      precip_today:
        friendly_name: Nedbør
        value_template: "{{ state_attr('weather.weatherflow_day_based_forecast', 'forecast')[0].precipitation }}"
        unit_of_measurement: mm
      sun_elevation:
        friendly_name: "Sol Højde"
        value_template: "{{ state_attr('sun.sun', 'elevation') }}"
        unit_of_measurement: "°"
      sun_elevation_pct:
        # Between 0-58 (Max possible at home location) to 0-100 (Cuts out negative elevation)
        friendly_name: "Sol Elevation %"
        value_template: "{{ 0.0 if states('sensor.sun_elevation') | float < 0 else (states('sensor.sun_elevation') | float * 100 / 58.0) | round(2) }}"
        unit_of_measurement: "%"
      sun_azimuth:
        friendly_name: "Sol Retning"
        value_template: "{{ state_attr('sun.sun', 'azimuth') }}"
        unit_of_measurement: "°"
      sealevel_pressure:
        friendly_name: "Lufttryk (Havniveau)"
        # Calculated as 0.125 per meter above sea level
        value_template: "{{ states('sensor.weatherflow_barometric_pressure') | float + 6 }}"
        device_class: pressure
        unit_of_measurement: "hPa"

automation:
  - alias: lightning_warning
    initial_state: true
    trigger:
      platform: template
      value_template: >-
        {{
          not is_state('sensor.weatherflow_last_lightning_strike_distance', 'unknown')
          and not is_state('sensor.weatherflow_last_lightning_strike_distance', 'unavailable')
          and (states('sensor.weatherflow_last_lightning_strike_distance') | int) < 20
        }}

      for:
        minutes: 5
    action:
      - service: notify.telegram_darkfox
        data:
          title: "Vejr Varsel: Torden"
          message: "Lynnedslag {{ states('sensor.weatherflow_last_lightning_strike_distance') }} {{ state_attr('sensor.weatherflow_last_lightning_strike_distance', 'unit_of_measurement') }} væk."
