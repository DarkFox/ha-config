telegram_bot:
  - platform: webhooks
    api_key: !secret telegram_bot_key
    #parse_mode: html
    allowed_chat_ids:
      - !secret telegram_darkfox_id
    trusted_networks:
      - 149.154.167.197/32
      - 149.154.167.198/31
      - 149.154.167.200/29
      - 149.154.167.208/28
      - 149.154.167.224/29
      - 149.154.167.232/31
      - 149.154.160.0/20
      - 91.108.4.0/22
      - 127.0.0.1

notify:
  - name: telegram_darkfox
    platform: telegram
    chat_id: !secret telegram_darkfox_id

automation:
  - id: update_telegram_keyboard
    alias: Update Telegram Keyboard
    initial_state: true
    trigger:
      platform: homeassistant
      event: start
    action:
      - action: notify.telegram_darkfox
        data:
          message: "Home Assistant er genstartet!"
          data:
            keyboard:
              - "/puzzel" # work.yaml
              - "/bil" # car.yaml

  - alias: "Handle Telegram Message"
    id: handle_telegram_message
    initial_state: true
    trigger:
      - platform: event
        event_type: telegram_text
        event_data:
          chat_id: !secret telegram_darkfox_id
    action:
      - action: conversation.process
        data:
          text: "{{ trigger.event.data.text }}"
          language: "da"
          agent_id: 4e0a875b09f8a19a405e1bf3e5c4adac
        response_variable: agent
      - action: telegram_bot.send_message
        data:
          target: "{{ trigger.event.data.chat_id }}"
          message: "{{ agent.response.speech.plain.speech }}"
