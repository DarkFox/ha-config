# RIP Elli Search&Find API
template:
  - sensor:
      - name: TomTom API Key
        state: !secret tomtom_api_key

command_line:
  - sensor:
      name: RSH P2 Clever Ladere (TomTom)
      scan_interval: 120
      command: >-
        curl -X GET
        "https://api.tomtom.com/search/2/chargingAvailability.json?chargingAvailability=208009007218354&key={{ states('sensor.tomtom_api_key') }}"
      value_template: "{{ value_json.connectors[0].availability.current.available }}"
      json_attributes:
        - connectors

  - sensor:
      name: RSH P7 Spirii Ladere (TomTom)
      scan_interval: 120
      command: >-
        curl -X GET
        "https://api.tomtom.com/search/2/chargingAvailability.json?chargingAvailability=208009007228971&key={{ states('sensor.tomtom_api_key') }}"
      value_template: "{{ value_json.connectors[0].availability.current.available }}"
      json_attributes:
        - connectors

  # Spirii P4: 208009007229648

sensor:
  # RSR

  # Spirii
  - platform: rest
    scan_interval: 120
    name: RSR P-Hus Spirii Ladere
    resource: https://api.elli.eco/searchandfind/v3/locations?evse_id=DK*SPI*EZ416*1
    headers:
      X-apikey: !secret elli_api_key
    value_template: "{{ value_json[0].charging_spots | selectattr('status', 'equalto', 'AVAILABLE') | list | length }}"
    json_attributes_path: $[0]
    json_attributes:
      - charging_spots

  - platform: rest
    scan_interval: 120
    name: RSR Hovedindgang Spirii Ladere
    resource: https://api.elli.eco/searchandfind/v3/locations?evse_id=DK*SPI*EZ3208*1
    headers:
      X-apikey: !secret elli_api_key
    value_template: "{{ value_json[0].charging_spots | selectattr('status', 'equalto', 'AVAILABLE') | list | length }}"
    json_attributes_path: $[0]
    json_attributes:
      - charging_spots

  - platform: rest
    scan_interval: 120
    name: RSR Blegdamsvej Spirii Ladere
    resource: https://api.elli.eco/searchandfind/v3/locations?evse_id=DK*SPI*EZM0094*1
    headers:
      X-apikey: !secret elli_api_key
    value_template: "{{ value_json[0].charging_spots | selectattr('status', 'equalto', 'AVAILABLE') | list | length }}"
    json_attributes_path: $[0]
    json_attributes:
      - charging_spots

  # Clever
  - platform: rest
    scan_interval: 300
    name: Clever Availability
    resource: https://clever-app-prod.firebaseio.com/chargers/v2/availability.json
    value_template: "{{ value_json['1229'].available.iec_type_2.regular }}"
    json_attributes:
      - "1229"

  - platform: rest
    scan_interval: 120
    name: RSR P-Hus Clever Ladere
    resource: https://api.elli.eco/searchandfind/v3/locations?evse_id=DK*CLE*E11179*1
    headers:
      X-apikey: !secret elli_api_key
    value_template: "{{ value_json[0].charging_spots | selectattr('status', 'equalto', 'AVAILABLE') | list | length }}"
    json_attributes_path: $[0]
    json_attributes:
      - charging_spots

  - platform: rest
    scan_interval: 120
    name: RSR Patienthotel Clever Ladere
    resource: https://api.elli.eco/searchandfind/v3/locations?evse_id=DK*CLE*E11190*1
    headers:
      X-apikey: !secret elli_api_key
    value_template: "{{ value_json[0].charging_spots | selectattr('status', 'equalto', 'AVAILABLE') | list | length }}"
    json_attributes_path: $[0]
    json_attributes:
      - charging_spots

  - platform: rest
    scan_interval: 120
    name: RSR Hovedindgang Clever Ladere
    resource: https://api.elli.eco/searchandfind/v3/locations?evse_id=DK*CLE*E11106*1
    headers:
      X-apikey: !secret elli_api_key
    value_template: "{{ value_json[0].charging_spots | selectattr('status', 'equalto', 'AVAILABLE') | list | length }}"
    json_attributes_path: $[0]
    json_attributes:
      - charging_spots

  # E.on
  - platform: rest
    scan_interval: 120
    name: RSR Hovedindgang Eon Ladere
    resource: https://api.elli.eco/searchandfind/v3/locations?evse_id=DK*EDR*E12677
    headers:
      X-apikey: !secret elli_api_key
    value_template: "{{ value_json[0].charging_spots | selectattr('status', 'equalto', 'AVAILABLE') | list | length }}"
    json_attributes_path: $[0]
    json_attributes:
      - charging_spots

  - platform: rest
    scan_interval: 120
    name: RSR NordflÃ¸jen Eon Ladere
    resource: https://api.elli.eco/searchandfind/v3/locations?evse_id=DK*EDR*E12617
    headers:
      X-apikey: !secret elli_api_key
    value_template: "{{ value_json[0].charging_spots | selectattr('status', 'equalto', 'AVAILABLE') | list | length }}"
    json_attributes_path: $[0]
    json_attributes:
      - charging_spots

  # RSH

  # Spirii
  - platform: rest
    scan_interval: 120
    name: RSH P4 Spirii Ladere
    resource: https://api.elli.eco/searchandfind/v3/locations?evse_id=DK*SPI*EZ3253*1
    headers:
      X-apikey: !secret elli_api_key
    value_template: "{{ value_json[0].charging_spots | selectattr('status', 'equalto', 'AVAILABLE') | list | length }}"
    json_attributes_path: $[0]
    json_attributes:
      - charging_spots

  - platform: rest
    scan_interval: 120
    name: RSH P7 Spirii Ladere
    resource: https://api.elli.eco/searchandfind/v3/locations?evse_id=DK*SPI*EZ3144*1
    headers:
      X-apikey: !secret elli_api_key
    value_template: "{{ value_json[0].charging_spots | selectattr('status', 'equalto', 'AVAILABLE') | list | length }}"
    json_attributes_path: $[0]
    json_attributes:
      - charging_spots

  # Clever
  - platform: rest
    scan_interval: 120
    name: RSH P2 Clever Ladere
    resource: https://api.elli.eco/searchandfind/v3/locations?evse_id=DK*CLE*E11135*1
    headers:
      X-apikey: !secret elli_api_key
    value_template: "{{ value_json[0].charging_spots | selectattr('status', 'equalto', 'AVAILABLE') | list | length }}"
    json_attributes_path: $[0]
    json_attributes:
      - charging_spots

  - platform: rest
    scan_interval: 120
    name: RSH Turkisvej Clever Ladere
    resource: https://api.elli.eco/searchandfind/v3/locations?evse_id=DK*CLE*E17067*3
    headers:
      X-apikey: !secret elli_api_key
    value_template: "{{ value_json[0].charging_spots | selectattr('status', 'equalto', 'AVAILABLE') | list | length }}"
    json_attributes_path: $[0]
    json_attributes:
      - charging_spots

  # E.on
  - platform: rest
    scan_interval: 120
    name: RSH P2 Eon Ladere
    resource: https://api.elli.eco/searchandfind/v3/locations?evse_id=DK*EDR*E13641
    headers:
      X-apikey: !secret elli_api_key
    value_template: "{{ value_json[0].charging_spots | selectattr('status', 'equalto', 'AVAILABLE') | list | length }}"
    json_attributes_path: $[0]
    json_attributes:
      - charging_spots

  - platform: rest
    scan_interval: 120
    name: RSH P4 Eon Ladere
    resource: https://api.elli.eco/searchandfind/v3/locations?evse_id=DK*EDR*E12932
    headers:
      X-apikey: !secret elli_api_key
    value_template: "{{ value_json[0].charging_spots | selectattr('status', 'equalto', 'AVAILABLE') | list | length }}"
    json_attributes_path: $[0]
    json_attributes:
      - charging_spots

automation:
  - id: update_charging_spot_sensors
    alias: Update charging spot sensors
    trigger:
      - platform: state
        entity_id:
          - sensor.rsr_p_hus_spirii_ladere
          - sensor.rsr_hovedindgang_spirii_ladere
          - sensor.rsr_blegdamsvej_spirii_ladere
          - sensor.rsr_p_hus_clever_ladere
          - sensor.rsr_patienthotel_clever_ladere
          - sensor.rsr_hovedindgang_clever_ladere
          - sensor.rsr_hovedindgang_eon_ladere
          - sensor.rsr_nordflojen_eon_ladere
          - sensor.rsh_p4_spirii_ladere
          - sensor.rsh_p7_spirii_ladere
          - sensor.rsh_p2_clever_ladere
          - sensor.rsh_turkisvej_clever_ladere
          - sensor.rsh_p2_eon_ladere
          - sensor.rsh_p4_eon_ladere
    action:
      - service: script.publish_ev_charging_spots_mqtt
        data:
          entity: "{{ trigger.entity_id }}"

script:
  # Attributes: entity
  publish_ev_charging_spots_mqtt:
    alias: "Publish Ev Charging Spots Mqtt"
    sequence:
      - condition: template
        value_template: "{{ not not state_attr(entity, 'charging_spots') }}"
      - alias: "Set variables"
        variables:
          site: "{{ entity.split('.')[1] }}"
          count: "{{ state_attr(entity, 'charging_spots') | length }}"
          charging_spots: "{{ state_attr(entity, 'charging_spots') }}"
      - alias: "Iterate over count"
        repeat:
          count: "{{ count|int }}"
          sequence:
            - alias: "Set charger variable"
              variables:
                charging_spot: "{{ charging_spots[repeat.index-1] }}"
            - alias: "Publish autodiscovery config"
              service: mqtt.publish
              data:
                retain: true
                topic: "homeassistant/binary_sensor/{{ site }}_{{ charging_spot.evse_id | lower | replace('*', '_') }}/config"
                payload_template: >-
                  {
                    "uniq_id": "{{ charging_spot.charging_spot_id }}",
                    "object_id": "{{ site }}_{{ charging_spot.evse_id | lower | replace('*', '_') }}",
                    "name": "{{ charging_spot.evse_id }}",
                    "device_class": "occupancy",
                    "icon": "
                    {%- if (charging_spot.connectors[0].connector_type == 'IEC_62196_T2') -%}
                      mdi:ev-plug-type2
                    {%- elif (charging_spot.connectors[0].connector_type == 'IEC_62196_T2_COMBO') -%}
                      mdi:ev-plug-ccs2
                    {%- elif (charging_spot.connectors[0].connector_type == 'CHADEMO') -%}
                      mdi:ev-plug-chademo
                    {%- endif -%}
                    ",
                    "stat_t": "ev_charger_status/{{ site }}/{{ charging_spot.evse_id | lower | replace('*', '_') }}/state",
                    "pl_on": "True",
                    "pl_off": "False",
                    "json_attr_t": "ev_charger_status/{{ site }}/{{ charging_spot.evse_id | lower | replace('*', '_') }}/attributes",
                    "device": {
                      "ids": "{{ site }}",
                      "name": "{{ state_attr(entity, 'friendly_name') }}",
                      "mf": "Elli",
                      "mdl": "HomeAssistant Discovery for Elli",
                      "sw": "HomeAssistant Discovery for Elli 1.0.0"
                    }
                  }
            - alias: "Publish state"
              service: mqtt.publish
              data:
                topic: "ev_charger_status/{{ site }}/{{ charging_spot.evse_id | lower | replace('*', '_') }}/state"
                retain: true
                payload_template: "{{ charging_spot.status != 'AVAILABLE' }}"
            - alias: "Publish attributes"
              service: mqtt.publish
              data:
                topic: "ev_charger_status/{{ site }}/{{ charging_spot.evse_id | lower | replace('*', '_') }}/attributes"
                retain: true
                payload_template: >-
                  {
                    "status": "{{ charging_spot.status }}",
                    "last_changed": "{{ charging_spot.last_status_change | as_timestamp | int | timestamp_local }}",
                    "site": "{{ state_attr(entity, 'friendly_name') }}"
                  }

  update_all_charging_spots:
    alias: Update all charging spots
    variables:
      sensors:
        - sensor.rsr_p_hus_spirii_ladere
        - sensor.rsr_hovedindgang_spirii_ladere
        - sensor.rsr_blegdamsvej_spirii_ladere
        - sensor.rsr_p_hus_clever_ladere
        - sensor.rsr_patienthotel_clever_ladere
        - sensor.rsr_hovedindgang_clever_ladere
        - sensor.rsr_hovedindgang_eon_ladere
        - sensor.rsr_nordflojen_eon_ladere
        - sensor.rsh_p4_spirii_ladere
        - sensor.rsh_p7_spirii_ladere
        - sensor.rsh_p2_clever_ladere
        - sensor.rsh_turkisvej_clever_ladere
        - sensor.rsh_p2_eon_ladere
        - sensor.rsh_p4_eon_ladere
    sequence:
      - variables:
          count: "{{ sensors | count }}"
      - repeat:
          count: "{{ count|int }}"
          sequence:
            - service: script.publish_ev_charging_spots_mqtt
              data:
                entity: "{{ sensors[repeat.index-1] }}"
