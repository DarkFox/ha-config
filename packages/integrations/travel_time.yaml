homeassistant:
  customize:
    sensor.s_train_c_status:
      friendly_name: S-Tog Linje C Status
      entity_picture: !secret s_tog_icon_url
    sensor.s_train_message:
      friendly_name: S-Tog Driftbesked
      icon: mdi:train

template:
  - sensor:
      - name: Next Travel Event
        unique_id: 67af8e12-5d9a-4468-8840-616796b36e5b
        device_class: timestamp
        state: >-
          {% set event = state_attr('sensor.next_travel_event', 'event') or {} %}
          {% set start = event.get('start', None) %}
          {% if start %}
            {{ as_timestamp(start) | timestamp_local('unavailable') }}
          {% else %}
            unknown
          {% endif %}
        attributes:
          event: >-
            {% set next_travel_events = state_attr('sensor.upcoming_events', 'events')|selectattr('travel', 'eq', true)|list %}
            {{ next_travel_events|first if next_travel_events|length > 0 else {} }}
          calendar: >-
            {% set event = state_attr('sensor.next_travel_event', 'event') or {} %}
            {{ event.get('calendar', none) }}
          start: >-
            {% set event = state_attr('sensor.next_travel_event', 'event') or {} %}
            {{ event.get('start', none) }}
          end: >-
            {% set event = state_attr('sensor.next_travel_event', 'event') or {} %}
            {{ event.get('end', none) }}
          location: >-
            {% set event = state_attr('sensor.next_travel_event', 'event') or {} %}
            {{ event.get('location', none) }}
          description: >-
            {% set event = state_attr('sensor.next_travel_event', 'event') or {} %}
            {{ event.get('description', none) }}
          travel: >-
            {% set event = state_attr('sensor.next_travel_event', 'event') or {} %}
            {{ event.get('travel', none) }}
          bil: >-
            {% set event = state_attr('sensor.next_travel_event', 'event') or {} %}
            {{ event.get('bil', none) }}
          wake: >-
            {% set event = state_attr('sensor.next_travel_event', 'event') or {} %}
            {{ event.get('wake', none) }}
          summary: >-
            {% set event = state_attr('sensor.next_travel_event', 'event') or {} %}
            {{ event.get('summary', none) }}

      - name: Upcoming Travel Location
        unique_id: ae8f41c7-775d-4b95-bb88-ed7b2865b9fb
        state: >-
          {{ state_attr('sensor.next_travel_event', 'location') }}
        attributes:
          mode: >-
            {% if state_attr('sensor.next_travel_event', 'bil') %}
              driving
            {% elif state_attr('sensor.next_travel_event', 'transit') %}
              transit
            {% else %}
              unknown
            {% endif %}

      - name: Google Maps Embed Key
        unique_id: f740d25c-edb4-4414-8b24-68e86211d7b9
        state: !secret google_maps_embed_key

      - name: Martin Location URL Encoded
        unique_id: dba11ecf-6f4a-4859-8292-9a2e19d5f52a
        state: >-
          {% set person = 'person.martin' %}
          {{ state_attr(person, 'latitude') }}%2C{{ state_attr(person, 'longitude') }}

      - name: Destination URL Encoded
        unique_id: 7a840ea0-087e-4ed2-b2ae-b3377c807887
        state: >-
          {% set location = state_attr('sensor.next_travel_event', 'location') %}
          {{ location|urlencode }}

      - name: Commute Status Car
        unique_id: 5a3e3797-bbe0-4f6a-b5fa-54c452cafe32
        state: >-
          {%- if states('sensor.martin_til_destination_bil')|int(0) > 45 -%}
            bad
          {%- elif states('sensor.martin_til_destination_bil')|int(0) > 25 -%}
            ok
          {%- else -%}
            good
          {%- endif -%}

      - name: Commute Status Transit
        unique_id: 2a130ba4-a9cf-4912-befa-f493c66a8982
        state: >-
          {%- if states('sensor.precip_today')|int(0) > 5 or states('sensor.s_train_c_status') != 'Til tiden' -%}
            bad
          {%- elif states('sensor.precip_today')|int(0) > 1 or states('sensor.s_train_message') != '' -%}
            ok
          {%- else -%}
            good
          {%- endif -%}

      - name: Commute Status Car
        unique_id: 72860175-ac13-4b88-b22b-44fd47292175
        state: >-
          {%- set headwind = (state_attr('weather.forecast_home', 'wind_bearing')|int(0) > 35 and state_attr('weather.forecast_home', 'wind_bearing')|int(0) < 146) -%}
          {%- if states('sensor.temperature')|int(0) < 0
              or states('sensor.precip_today')|int(0) > 5
              or (headwind and states('sensor.beaufort')|int(0) > 6) -%}
            bad
          {%- elif states('sensor.temperature')|int(0) < 10
              or states('sensor.precip_today')|int(0) > 1
              or (headwind and states('sensor.beaufort')|int(0) > 5) -%}
            ok
          {%- else -%}
            good
          {%- endif -%}

      - name: Martin Next Scheduled At
        unique_id: bcfd62ed-d849-41ec-ad23-7506219345a6
        device_class: timestamp
        state: >-
          {{
            (strptime(state_attr('sensor.next_travel_event', 'start'), '%Y-%m-%d %H:%M:%S')|as_local).isoformat()
            if state_attr('sensor.next_travel_event', 'location') else ''
          }}
      - name: Next Scheduled Leave At
        unique_id: 7ce36e9c-2d32-49de-9ab7-d5df86b28aae
        device_class: timestamp
        state: >-
          {% set driving = is_state_attr('sensor.upcoming_travel_location', 'mode', 'driving') %}
          {% set travel_time_sensor = 'sensor.martin_til_destination_bil' if driving else 'sensor.martin_til_destination_transit' %}
          {% set padding = 15 if driving else 5 %}
          {{
            ((
              strptime(state_attr('sensor.next_travel_event', 'start'), '%Y-%m-%d %H:%M:%S')
              - timedelta(minutes=states(travel_time_sensor)|int+padding)
            )|as_local).isoformat()
            if state_attr('sensor.next_travel_event', 'location') else ''
          }}

      - name: Next Scheduled Leave In
        unique_id: 69be0bee-d24a-4be0-90f8-e66bc3006d78
        device_class: duration
        unit_of_measurement: min
        state: >-
          {%- set timestamp = states('sensor.next_scheduled_leave_at')|as_timestamp(-1) -%}
          {%- if timestamp != -1 -%}
            {{ (((states('sensor.next_scheduled_leave_at')|as_timestamp) - (now()|as_timestamp))/60)|int }}
          {% else %}
            -1
          {%- endif -%}

  - binary_sensor:
      - name: Martin Next Scheduled Destination Active
        unique_id: 78ffca90-7a32-4764-932a-46ff4fb01548
        state: >-
          {%- set martin_next_scheduled_at = strptime(states('sensor.next_travel_event'), '%Y-%m-%dT%H:%M:%S%z', '-1') -%}
          {%- if martin_next_scheduled_at != '-1' -%}
            {{ martin_next_scheduled_at - timedelta(hours=12) < now() }}
          {%- else -%}
            False
          {%- endif -%}
      - name: Martin Next Scheduled Destination Leave Soon
        unique_id: 9c450aa1-aaeb-49dd-9c2c-cb713fcb70b8
        state: >-
          {%- set time_to_leave_next_scheduled = strptime(states('sensor.next_scheduled_leave_at'), '%Y-%m-%dT%H:%M:%S%z', '-1') -%}
          {%- if time_to_leave_next_scheduled != '-1' -%}
            {{ time_to_leave_next_scheduled - timedelta(minutes=30) < now() }}
          {%- else -%}
            False
          {%- endif -%}
      - name: Martin Next Scheduled Destination Time To Leave
        unique_id: 54cf1638-433c-44a6-8319-dd77c3511071
        state: >-
          {%- set time_to_leave_next_scheduled = strptime(states('sensor.next_scheduled_leave_at'), '%Y-%m-%dT%H:%M:%S%z', '-1') -%}
          {%- if time_to_leave_next_scheduled != '-1' -%}
            {{ time_to_leave_next_scheduled < now() }}
          {%- else -%}
            False
          {%- endif -%}

      - name: S-Train Message Present
        unique_id: 7a00508c-c7f5-4877-9bc9-0565ea46f54c
        device_class: problem
        state: >-
          {{ (states('sensor.s_train_message') | regex_match('.*(\sC(\W|$)|alle|Alle).*')) or not is_state('sensor.s_train_c_status', 'Til tiden') }}
      - name: S-Train Message About C
        unique_id: 46ee6a50-42a1-464a-aee0-df42dbfcf983
        device_class: problem
        state: >-
          {{ (states('sensor.s_train_message') | regex_match('.*(\sC(\W|$)|alle|Alle).*')) }}

sensor:
  - platform: rejseplanen
    name: S-Tog Måløv
    stop_id: "8600709"
    route:
      - C
      - H
    departure_type: S

  - platform: rejseplanen
    name: S-Tog Nørreport Mod Frederikssund
    stop_id: "008600646"
    route:
      - C
      - H
    departure_type: S
    direction:
      - Frederikssund St.

  - platform: dsb_trafikinfo
    name: DSB Trafikinfo
    sender: S-tog

automation:
  - alias: "Next destination - Update sensors with high frequency when close to leave time"
    initial_state: true
    trigger:
      - platform: time_pattern
        minutes: "/5"
    condition:
      - condition: state
        entity_id: binary_sensor.martin_next_scheduled_destination_leave_soon
        state: "on"
    action:
      - choose:
          - conditions: |-
              {{ is_state_attr('sensor.upcoming_travel_location', 'mode', 'driving') }}
            sequence:
              - service: homeassistant.update_entity
                target:
                  entity_id: sensor.martin_til_destination_bil
          - conditions: |-
              {{ is_state_attr('sensor.upcoming_travel_location', 'mode', 'transit') }}
            sequence:
              - service: homeassistant.update_entity
                target:
                  entity_id: sensor.martin_til_destination_transit

  - alias: "Next destination - Update sensors slowly 12 hours before"
    initial_state: true
    trigger:
      - platform: time_pattern
        minutes: "/20"
    condition:
      - condition: state
        entity_id: binary_sensor.martin_next_scheduled_destination_active
        state: "on"
    action:
      - choose:
          - conditions: |-
              {{ is_state_attr('sensor.upcoming_travel_location', 'mode', 'driving') }}
            sequence:
              - service: homeassistant.update_entity
                target:
                  entity_id: sensor.martin_til_destination_bil
          - conditions: |-
              {{ is_state_attr('sensor.upcoming_travel_location', 'mode', 'transit') }}
            sequence:
              - service: homeassistant.update_entity
                target:
                  entity_id: sensor.martin_til_destination_transit

  - id: time_to_leave_notification
    alias: time_to_leave_notification
    initial_state: true
    mode: single
    trigger:
      - platform: numeric_state
        entity_id: sensor.next_scheduled_leave_in
        below: 46
      - platform: numeric_state
        entity_id: sensor.next_scheduled_leave_in
        below: 31
      - platform: numeric_state
        entity_id: sensor.next_scheduled_leave_in
        below: 21
      - platform: numeric_state
        entity_id: sensor.next_scheduled_leave_in
        below: 16
      - platform: numeric_state
        entity_id: sensor.next_scheduled_leave_in
        below: 11
      - platform: numeric_state
        entity_id: sensor.next_scheduled_leave_in
        below: 6
      - platform: numeric_state
        entity_id: sensor.next_scheduled_leave_in
        below: 1
    condition:
      - alias: "If at home"
        condition: state
        entity_id: person.martin
        state: "home"
      - alias: "Not from unavailable/unknown"
        condition: template
        value_template: "{{ not trigger.from_state.state in ['unavailable', 'unknown'] }}"
    action:
      - service: script.notify_everywhere
        data:
          message: >-
            {% if trigger.to_state.state|int(0) < 1 %}
              Tid til at tage afsted.
            {% else %}
              Tag afsted om {{ trigger.to_state.state|int(0) }} minutter.
            {% endif %}
