script:
  stue_gardin:
    sequence:
      - service: "cover.{{modus}}_cover"
        target:
          entity_id:
            - cover.stue_gardin_hojre
            - cover.stue_gardin_venstre
  stue_gardin_position:
    sequence:
      - service: cover.set_cover_position
        target:
          entity_id:
            - cover.stue_gardin_hojre
            - cover.stue_gardin_venstre
        data:
          position: "{{position}}"

  sovevaerelse_gardin:
    sequence:
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ modus == 'close' }}"
            sequence:
              - service: "cover.close_cover"
                target:
                  entity_id: cover.sovevaerelse_gardin_vindue
              - delay:
                  seconds: 25
              - service: cover.set_cover_position
                target:
                  entity_id: cover.sovevaerelse_gardin_vindue
                data:
                  position: 35
              - delay:
                  seconds: 5
              - service: "cover.close_cover"
                target:
                  entity_id: cover.sovevaerelse_gardin_dor
        default:
          - service: "cover.open_cover"
            target:
              entity_id:
                - cover.sovevaerelse_gardin_vindue
                - cover.sovevaerelse_gardin_dor

  sovevaerelse_gardin_position:
    sequence:
      - service: cover.set_cover_position
        target:
          entity_id: cover.sovevaerelse_gardin_vindue
        data:
          position: "{{position}}"
      - delay:
          seconds: 25
      - service: cover.set_cover_position
        target:
          entity_id: cover.sovevaerelse_gardin_vindue
        data:
          position: >-
            {% if position < 35 %}
              35
            {% else %}
              {{ position }}
            {% end %}
      - delay:
          seconds: 5
      - service: cover.set_cover_position
        target:
          entity_id: cover.sovevaerelse_gardin_dor
        data:
          position: "{{position}}"

cover:
  - platform: template
    covers:
      stue_gardin:
        friendly_name: "Stue Gardin"
        device_class: curtain
        position_template: "{{ states('sensor.stue_gardin_position') }}"
        open_cover:
          service: script.stue_gardin
          data:
            modus: "open"
        close_cover:
          service: script.stue_gardin
          data:
            modus: "close"
        stop_cover:
          service: script.stue_gardin
          data:
            modus: "stop"
        set_cover_position:
          service: script.stue_gardin_position
          data:
            position: "{{ position }}"

  - platform: template
    covers:
      sovevaerelse_gardin:
        friendly_name: "SovevÃ¦relse Gardin"
        device_class: curtain
        position_template: "{{ states('sensor.sovevaerelse_gardin_position') }}"
        open_cover:
          service: script.sovevaerelse_gardin
          data:
            modus: "open"
        close_cover:
          service: script.sovevaerelse_gardin
          data:
            modus: "close"
        stop_cover:
          service: script.sovevaerelse_gardin
          data:
            modus: "stop"
        set_cover_position:
          service: script.sovevaerelse_gardin_position
          data:
            position: "{{ position }}"

sensor:
  - platform: min_max
    name: stue_gardin_position
    round_digits: 0
    type: mean
    entity_ids:
      - sensor.stue_gardin_hojre_position
      - sensor.stue_gardin_venstre_position

  - platform: min_max
    name: sovevaerelse_gardin_position
    round_digits: 0
    type: mean
    entity_ids:
      - sensor.sovevaerelse_gardin_vindue_position
      - sensor.sovevaerelse_gardin_dor_position

  - platform: template
    sensors:
      stue_gardin_hojre_position:
        value_template: "{{ state_attr('cover.stue_gardin_hojre', 'current_position') }}"
      stue_gardin_venstre_position:
        value_template: "{{ state_attr('cover.stue_gardin_venstre', 'current_position') }}"
      sovevaerelse_gardin_vindue_position:
        value_template: "{{ state_attr('cover.sovevaerelse_gardin_vindue', 'current_position') }}"
      sovevaerelse_gardin_dor_position:
        value_template: "{{ state_attr('cover.sovevaerelse_gardin_dor', 'current_position') }}"
