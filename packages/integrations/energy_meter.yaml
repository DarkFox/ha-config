homeassistant:
  customize:
    sensor.energy_hourly:
      friendly_name: Elforbrug Denne Time
    sensor.energy_daily:
      friendly_name: Elforbrug I Dag
    sensor.energy_monthly:
      friendly_name: Elforbrug Denne M책ned
    sensor.energy_quarterly:
      friendly_name: Elforbrug Dette Kvartal
    sensor.energy_last_hour:
      icon: mdi:counter
    sensor.energy_last_day:
      icon: mdi:counter
    sensor.energy_last_month:
      icon: mdi:counter
    sensor.energy_last_quarter:
      icon: mdi:counter

mqtt:
  sensor:
    # - name: "Raw Electricity Price"
    #   state_topic: "kamstrup/prices"
    #   value_template: "{{ value_json.prices['0'] }}"
    #   json_attributes_topic: "kamstrup/prices"

    - name: "Pow K Uptime"
      state_topic: "kamstrup/uptime"

    - name: "Pow K VCC"
      state_topic: "kamstrup/vcc"
      unit_of_measurement: V
      device_class: voltage

    - name: "Pow K RSSI"
      state_topic: "kamstrup/rssi"
      unit_of_measurement: dBm
      device_class: signal_strength

    - name: Pow K Temperature
      state_topic: kamstrup/temperature
      unit_of_measurement: 째C
      device_class: temperature

    - name: Pow K Power Factor
      state_topic: kamstrup/meter/powerfactor
      value_template: "{{ ((value|float) * 100.0)|round(1) }}"
      device_class: power_factor
      unit_of_measurement: "%"

    - name: Pow K Import Reactive Accumulated
      state_topic: kamstrup/meter/import/reactive/accumulated
      state_class: total_increasing
      unit_of_measurement: kWh
      device_class: energy

    - name: Pow K Import Active Accumulated
      state_topic: kamstrup/meter/import/active/accumulated
      state_class: total_increasing
      unit_of_measurement: kWh
      device_class: energy

    - name: Pow K Export Reactive Accumulated
      state_topic: kamstrup/meter/export/reactive/accumulated
      state_class: total_increasing
      unit_of_measurement: kWh
      device_class: energy

    - name: Pow K Export Active Accumulated
      state_topic: kamstrup/meter/export/active/accumulated
      state_class: total_increasing
      unit_of_measurement: kWh
      device_class: energy

    - name: Pow K L1 Current
      state_topic: kamstrup/meter/l1/current
      unit_of_measurement: A
      device_class: current

    - name: Pow K L1 Voltage
      state_topic: kamstrup/meter/l1/voltage
      unit_of_measurement: V
      device_class: voltage

    - name: Pow K L1 Power Factor
      state_topic: kamstrup/meter/l1/powerfactor
      value_template: "{{ ((value|float) * 100.0)|round(1) }}"
      device_class: power_factor
      unit_of_measurement: "%"

    - name: Pow K L2 Current
      state_topic: kamstrup/meter/l2/current
      unit_of_measurement: A
      device_class: current

    - name: Pow K L2 Voltage
      state_topic: kamstrup/meter/l2/voltage
      unit_of_measurement: V
      device_class: voltage

    - name: Pow K L2 Power Factor
      state_topic: kamstrup/meter/l2/powerfactor
      value_template: "{{ ((value|float) * 100.0)|round(1) }}"
      device_class: power_factor
      unit_of_measurement: "%"

    - name: Pow K L3 Current
      state_topic: kamstrup/meter/l3/current
      unit_of_measurement: A
      device_class: current

    - name: Pow K L3 Voltage
      state_topic: kamstrup/meter/l3/voltage
      unit_of_measurement: V
      device_class: voltage

    - name: Pow K L3 Power Factor
      state_topic: kamstrup/meter/l3/powerfactor
      value_template: "{{ ((value|float) * 100.0)|round(1) }}"
      device_class: power_factor
      unit_of_measurement: "%"

    - name: Pow K Export Reactive
      state_topic: kamstrup/meter/export/reactive
      state_class: measurement
      unit_of_measurement: W
      device_class: power

    - name: Pow K Export Active
      state_topic: kamstrup/meter/export/active
      state_class: measurement
      unit_of_measurement: W
      device_class: power

    - name: Pow K Import Reactive
      state_topic: kamstrup/meter/import/reactive
      state_class: measurement
      unit_of_measurement: W
      device_class: power

    - name: Pow K Import Active
      state_topic: kamstrup/meter/import/active
      state_class: measurement
      unit_of_measurement: W
      device_class: power

    - name: Pow K Import Hour
      state_topic: kamstrup/realtime/import/hour
      state_class: total_increasing
      unit_of_measurement: kWh
      device_class: energy

    - name: Pow K Import Day
      state_topic: kamstrup/realtime/import/day
      state_class: total_increasing
      unit_of_measurement: kWh
      device_class: energy

    - name: Pow K Import Threshold
      state_topic: kamstrup/realtime/import/threshold
      state_class: measurement
      unit_of_measurement: kWh
      device_class: energy

    - name: Pow K Import Monthmax
      state_topic: kamstrup/realtime/import/monthmax
      state_class: total_increasing
      unit_of_measurement: kWh
      device_class: energy

utility_meter:
  energy_hourly:
    source: sensor.pow_k_import_active_accumulated
    cycle: hourly
  energy_daily:
    source: sensor.pow_k_import_active_accumulated
    cycle: daily
  energy_monthly:
    source: sensor.pow_k_import_active_accumulated
    cycle: monthly
  energy_quarterly:
    source: sensor.pow_k_import_active_accumulated
    cycle: quarterly

template:
  - sensor:
      - name: Pow K L1 Power
        state: >-
          {{
            (states('sensor.pow_k_l1_voltage')|float) *
            (states('sensor.pow_k_l1_current')|float) *
            (states('sensor.pow_k_l1_power_factor')|float/100.0)
          }}
        device_class: power
        unit_of_measurement: W
      - name: Pow K L2 Power
        state: >-
          {{
            (states('sensor.pow_k_l2_voltage')|float) *
            (states('sensor.pow_k_l2_current')|float) *
            (states('sensor.pow_k_l2_power_factor')|float/100.0)
          }}
        device_class: power
        unit_of_measurement: W
      - name: Pow K L3 Power
        state: >-
          {{
            (states('sensor.pow_k_l3_voltage')|float) *
            (states('sensor.pow_k_l3_current')|float) *
            (states('sensor.pow_k_l3_power_factor')|float/100.0)
          }}
        device_class: power
        unit_of_measurement: W

sensor:
  - platform: integration
    source: sensor.pow_k_l1_power
    name: Pow K L1 Power Accumulated
    unit_prefix: k
    round: 3
    method: left
  - platform: integration
    source: sensor.pow_k_l2_power
    name: Pow K L2 Power Accumulated
    unit_prefix: k
    round: 3
    method: left
  - platform: integration
    source: sensor.pow_k_l3_power
    name: Pow K L3 Power Accumulated
    unit_prefix: k
    round: 3
    method: left

  - platform: template
    sensors:
      energy_cost_hourly:
        friendly_name: "Elomkostning"
        value_template: "{{ (((states('sensor.pow_k_import_active')|float)/1000) * (states('sensor.energi_data_service')|float)) | round(3) }}"
        unit_of_measurement: kr/t
        device_class: monetary

      energy_cost_this_hour:
        friendly_name: "Elomkostning Denne Time"
        value_template: "{{ ((states('sensor.energy_hourly')|float) * (states('sensor.energi_data_service')|float)) | round(3) }}"
        unit_of_measurement: kr
        device_class: monetary

      energy_last_hour:
        friendly_name: "Elforbrug Sidste Time"
        value_template: "{{ state_attr('sensor.energy_hourly', 'last_period') }}"
        unit_of_measurement: kWh
        device_class: energy
      energy_last_day:
        friendly_name: "Elforbrug I G책r"
        value_template: "{{ state_attr('sensor.energy_daily', 'last_period') }}"
        unit_of_measurement: kWh
        device_class: energy
      energy_last_month:
        friendly_name: "Elforbrug Sidste M책ned"
        value_template: "{{ state_attr('sensor.energy_monthly', 'last_period') }}"
        unit_of_measurement: kWh
        device_class: energy
      energy_last_quarter:
        friendly_name: "Elforbrug Sidste Kvartal"
        value_template: "{{ state_attr('sensor.energy_quarterly', 'last_period') }}"
        unit_of_measurement: kWh
        device_class: energy
