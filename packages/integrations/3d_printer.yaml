camera:
  - platform: local_file
    file_path: /config/www/downloads/3d_printer/model.jpg
    name: "3D Printer Model Image"

binary_sensor:
  - platform: template
    sensors:
      3d_printer_running:
        value_template: "{{ states('sensor.3d_printer_afbryder_forbrug')|float > 0.01 }}"

sensor:
  - platform: template
    sensors:
      3d_printer_print_name:
        value_template: >-
          {{ states('sensor.octoprint_print_file') | replace('.gcode', '') | replace('CFFFP_', '') | replace('_', ' ') | title }}
      3d_printer_finish_time:
        icon_template: mdi:clock-outline
        friendly_name: 3D Printer Finish Time
        value_template: >-
          {{
            (as_timestamp(now())+(states('sensor.octoprint_print_time_left')|int))
            | timestamp_custom('%d. %H:%M')
            | replace((as_timestamp(now())
            | timestamp_custom('%d. ')), '')
          }}

script:
  update_model_image:
    alias: Update 3D Printer model image file
    sequence:
      - service: downloader.download_file
        data:
          url: "http://192.168.42.210/plugin/prusaslicerthumbnails/thumbnail/{{ states('sensor.octoprint_print_file') | replace('.gcode', '.png') }}?{{ now()|as_timestamp|int }}"
          subdir: 3d_printer
          filename: model.jpg # Yes, the URL says PNG, but the image is actually JPEG.
          overwrite: true

automation:
  - id: update_3d_printer_model_image_on_file_change
    alias: Update 3D Printer Model Image On File Change
    trigger:
      - platform: state
        entity_id: sensor.octoprint_print_file
    action:
      - service: script.turn_on
        target:
          entity_id: script.update_model_image

  - id: 3d_printer_turn_on_with_job
    alias: 3D Printer Turn On With Job
    initial_state: true
    mode: single
    trigger:
      - platform: mqtt
        topic: "octoPrint/event/Connecting"
    condition:
      - condition: state
        entity_id: switch.3d_printer_afbryder
        state: "off"
    action:
      - service: switch.turn_on
        target:
          entity_id: switch.3d_printer_afbryder
      - delay:
          seconds: 5
      - service: switch.turn_on
        target:
          entity_id: switch.octoprint_connect_to_printer
