
rest_command:
  desktop_pc_shutdown:
    url: 'http://192.168.32.100:8080/?Shutdown'
    username: hass
    password: !secret eventghost_password

automation:
  - alias: desktop_pc_status_webhook
    initial_state: True
    trigger:
      platform: webhook
      webhook_id: !secret desktop_pc_status_webhook
    action:
      - service_template: >
          input_boolean.turn_{{ trigger.data | regex_findall_index("\<MultiDictProxy\('(.+)': ''\)\>", 0) }}
        data:
          entity_id: input_boolean.desktop_pc_status
      - service: input_datetime.set_datetime
        data_template:
          entity_id: input_datetime.desktop_pc_ping
          date: >
            {{ now().timestamp() | timestamp_custom("%Y-%m-%d", true) }}
          time: >
            {{ now().timestamp() | timestamp_custom("%H:%M:%S", true) }}
      - delay: '00:00:31'
      - condition: template
        value_template: "{{ state_attr('input_datetime.desktop_pc_ping', 'timestamp') < (now().timestamp() - 30) }}"
      - service: input_boolean.turn_off
        data:
          entity_id: input_boolean.desktop_pc_status

  - alias: desktop_pc_status_timeout
    initial_state: True
    trigger:
      platform: time_pattern
      seconds: '/10'
    condition:
      condition: template
      value_template: "{{ as_timestamp(state_attr('automation.desktop_pc_status_webhook', 'last_triggered')) < (now().timestamp() - 30) }}"
    action:
      - service: input_boolean.turn_off
        data:
          entity_id: input_boolean.desktop_pc_status

  - alias: desktop_pc_idle_webhook
    initial_state: True
    trigger:
      platform: webhook
      webhook_id: !secret desktop_pc_idle_webhook
    action:
      service_template: >
        input_boolean.turn_{{ trigger.data | regex_findall_index("\<MultiDictProxy\('(.+)': ''\)\>", 0) }}
      data_template:
        entity_id: input_boolean.desktop_pc_idle

  - alias: desktop_pc_away_webhook
    initial_state: True
    trigger:
      platform: webhook
      webhook_id: !secret desktop_pc_away_webhook
    action:
      service_template: >
        input_boolean.turn_{{ trigger.data | regex_findall_index("\<MultiDictProxy\('(.+)': ''\)\>", 0) }}
      data_template:
        entity_id: input_boolean.desktop_pc_away

input_boolean:
  desktop_pc_status:
    name: desktop_pc_status

  desktop_pc_idle:
    name: desktop_pc_idle

  desktop_pc_away:
    name: desktop_pc_away

binary_sensor:
  - platform: template
    sensors:
      desktop_pc_activity:
        friendly_name: 'Desktop PC Activity'
        entity_id:
          - input_boolean.desktop_pc_status
          - input_boolean.desktop_pc_idle
          - sensor.steam_game
        value_template: >
          {% if is_state('input_boolean.desktop_pc_status', 'off') -%}
            false
          {% elif (is_state('input_boolean.desktop_pc_idle', 'on')
            and is_state('sensor.steam_game', 'None')) -%}
            false
          {% else -%}
            true
          {% endif -%}

switch:
  - platform: template
    switches:
      desktop_pc:
        friendly_name: PC
        icon_template: >-
          {% if is_state('switch.desktop_pc', 'on') %}
            mdi:desktop-mac-dashboard
          {% else %}
            mdi:desktop-mac
          {% endif %}
        value_template: "{{ is_state('input_boolean.desktop_pc_status', 'on') }}"
        turn_on:
          service: wake_on_lan.send_magic_packet
          data:
            broadcast_address: 192.168.32.255
            mac: !secret desktop_pc_mac_address
        turn_off:
          service: rest_command.desktop_pc_shutdown
