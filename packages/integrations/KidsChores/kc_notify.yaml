automation:
  - alias: Notify Rook about overdue chores
    id: 663a693f-d58b-4f0c-9340-6c8961e0c76f
    description: Notify Rook about chores that are overdue and have the Notify label
    initial_state: true
    mode: restart
    trigger:
      - trigger: state
        entity_id: sensor.rook_chores_overdue
        attribute: chores
    condition:
      - condition: numeric_state
        entity_id: sensor.rook_chores_overdue
        above: 0
    variables:
      chore_sensors: >-
        {{ state_attr('sensor.rook_chores_overdue', 'chores')
          | expand
          | selectattr('attributes.labels', 'search', 'Notify') 
          | map(attribute='entity_id') 
          | list }}
    actions:
      - condition: template
        value_template: >-
          {{ chore_sensors | length > 0 }}
      - action: notify.mobile_app_darkphone
        data:
          title: Opgaver forfaldne
          message: >-
            Følgende opgaver er forfaldne:
            {% for sensor in chore_sensors %}
              - {{ sensor.attributes.chore_name }}
            {% endfor %}
          data:
            tag: "kc_rook_overdue_chores_notification"
            channel: "Overdue Chores"
            importance: high
            clickAction: >-
              {% set ns = namespace(has_health_chores=false) %}
              {% for sensor in chore_sensors %}
                {% if 'Helbred' in sensor.attributes.labels %}
                  {% set ns.has_health_chores = true %}
                {% endif %}
              {% endfor %}
              {% if ns.has_health_chores %}
                /dashboard-health/symptomer
              {% else %}
                /dashboard-pligter/Rook
              {% endif %}

  - alias: Notify Rook about critical overdue chores
    id: 601e476d-eabd-4300-960d-80fd307f1c86
    description: Notify Rook about critical chores that are overdue every 5 minutes
    initial_state: true
    mode: restart
    trigger:
      - trigger: state
        entity_id: sensor.rook_chores_overdue
        attribute: chores
      - trigger: time_pattern
        minutes: "/5"
    condition:
      - condition: numeric_state
        entity_id: sensor.rook_chores_overdue
        above: 0
    variables:
      chore_sensors: >-
        {{ state_attr('sensor.rook_chores_overdue', 'chores')
          | expand
          | selectattr('attributes.labels', 'search', 'Critical Notify') 
          | list }}
    actions:
      - condition: template
        value_template: >-
          {{ chore_sensors | length > 0 }}
      - action: notify.mobile_app_darkphone
        data:
          title: Opgaver forfaldne
          message: >-
            Følgende kritiske opgaver er forfaldne:
            {% for sensor in chore_sensors %}
              - {{ sensor.attributes.chore_name }}
            {% endfor %}
          data:
            tag: "kc_rook_critical_overdue_chores_notification"
            channel: "Critical Overdue Chores"
            importance: high
            clickAction: >-
              {% set ns = namespace(has_health_chores=false) %}
              {% for sensor in chore_sensors %}
                {% if 'Helbred' in sensor.attributes.labels %}
                  {% set ns.has_health_chores = true %}
                {% endif %}
              {% endfor %}
              {% if ns.has_health_chores %}
                /dashboard-health/symptomer
              {% else %}
                /dashboard-pligter/Rook
              {% endif %}
