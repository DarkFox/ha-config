mqtt:
  sensor:
    - name: "DMI Aktuelle Varsler"
      state_topic: "dmi_current_warnings/state"
      json_attributes_topic: "dmi_current_warnings/attributes"

    - name: "DMI Kommende Varsler"
      state_topic: "dmi_future_warnings/state"
      json_attributes_topic: "dmi_future_warnings/attributes"

binary_sensor:
  - platform: template
    sensors:
      show_weather_warnings:
        value_template: "{{ not is_state('sensor.dmi_aktuelle_varsler', '0') }}"
  - platform: template
    sensors:
      show_coming_weather_warnings:
        value_template: "{{ not is_state('sensor.dmi_kommende_varsler', '0') }}"

sensor:
  - platform: template
    sensors:
      dmi_vejr:
        friendly_name: "DMI Vejr"
        value_template: >-
          {{ states.sensor.dmi_weather_raw.attributes.regiondata[0].products[0].text | regex_findall_index("<overskriftkoebenhavnognordsjaelland.+><text>(.*?)<\/text><\/overskriftkoebenhavnognordsjaelland>", 0) }}
        attribute_templates:
          date: >-
            {{ states.sensor.dmi_weather_raw.attributes.regiondata[0].products[0].text | regex_findall_index("<dato.+><text>(.*?)<\/text><\/dato>", 0) }}
          validity: >-
            {{ states.sensor.dmi_weather_raw.attributes.regiondata[0].products[0].text | regex_findall_index("<reggyld.+><text>(.*?)<\/text><\/reggyld>", 0) }}
          content: >-
            {{ states.sensor.dmi_weather_raw.attributes.regiondata[0].products[0].text | regex_findall_index("<koebenhavnognordsjaelland.+><text>(.*?)<\/text><\/koebenhavnognordsjaelland>", 0) }}

      dmi_vejr_tts:
        value_template: "Vejrudsigt: {{ states('sensor.dmi_vejr') }}."
        attribute_templates:
          text: >-
            {% if states('sensor.dmi_aktuel_varsel') %}
              Vejr Varsel kategori {{ state_attr('sensor.dmi_aktuel_varsel', 'category') }}: {{ states('sensor.dmi_aktuel_varsel') }}.
              {{ state_attr('sensor.dmi_aktuel_varsel', 'text') }}.
            {% endif %}
            {{ state_attr('sensor.dmi_vejr', 'content') | replace(' temp.', ' temperatur') | replace(' Temp.', ' Temperatur') | replace(' temp ', ' temperatur ') | replace(' Temp ', ' Temperatur ') }}

      dmi_aktuel_varsel:
        friendly_name: "DMI Aktuel Varsel"
        value_template: >-
          {{ state_attr('sensor.dmi_aktuel_varsel', 'raw')['warningTitle'] if state_attr('sensor.dmi_aktuel_varsel', 'raw') }}
        attribute_templates:
          raw: >-
            {% set actualWarnings = state_attr('sensor.dmi_warnings_specific_raw', 'actualWarnings') %}
            {% if actualWarnings and actualWarnings|length > 0 %}
              {{ actualWarnings[0]|tojson }}
            {% else %}
              {}
            {% endif %}
          text: >-
            {{ state_attr('sensor.dmi_aktuel_varsel', 'raw')['warningText'] if state_attr('sensor.dmi_aktuel_varsel', 'raw') }}
          additional_text: >-
            {{ state_attr('sensor.dmi_aktuel_varsel', 'raw')['additionalText'] if state_attr('sensor.dmi_aktuel_varsel', 'raw') }}
          valid_from: >-
            {{ state_attr('sensor.dmi_aktuel_varsel', 'raw')['validFromText'] if state_attr('sensor.dmi_aktuel_varsel', 'raw') }}
          valid_to: >-
            {{ state_attr('sensor.dmi_aktuel_varsel', 'raw')['validToText'] if state_attr('sensor.dmi_aktuel_varsel', 'raw') }}
          issued_at: >-
            {{ state_attr('sensor.dmi_aktuel_varsel', 'raw')['issuedAtText'] if state_attr('sensor.dmi_aktuel_varsel', 'raw') }}
          category: >-
            {{ state_attr('sensor.dmi_aktuel_varsel', 'raw')['formattedCategory'] if state_attr('sensor.dmi_aktuel_varsel', 'raw') }}
          valid_from_timestamp: >-
            {{ state_attr('sensor.dmi_aktuel_varsel', 'raw')['validFrom'] if state_attr('sensor.dmi_aktuel_varsel', 'raw') }}
          valid_to_timestamp: >-
            {{ state_attr('sensor.dmi_aktuel_varsel', 'raw')['validTo'] if state_attr('sensor.dmi_aktuel_varsel', 'raw') }}
          entity_picture: >-
            {{ '/local/downloads/dmi_warning_icons/'+state_attr('sensor.dmi_aktuel_varsel', 'raw')['icon'] if state_attr('sensor.dmi_aktuel_varsel', 'raw') }}

  - platform: rest
    name: dmi_weather_raw
    # https://dmi.dk/dmidk_byvejrWS/rest/texts/[ID from dmi.dk location weather URL]
    resource: !secret dmi_weather_url
    headers:
      User-Agent: !secret user_agent
    scan_interval: 300
    value_template: "{{ value_json.regiondata[0].products[0].timestamp }}"
    json_attributes:
      - regiondata

  - platform: rest
    name: dmi_warnings_raw
    # https://dmi.dk/dmidk_byvejrWS/rest/texts/varsler/geonameid/[ID from dmi.dk location weather URL]
    resource: !secret dmi_warnings_url
    headers:
      User-Agent: !secret user_agent
    scan_interval: 300
    force_update: True
    value_template: "{{ 0 if value_json.warnings|length < 1 else value_json.warnings[0].time }}"
    json_attributes:
      - warnings
      - day0
      - day1
      - day2
      - day3
      - day4
      - day5
      - vandstand
      - favorite

  - platform: rest
    name: dmi_warnings_specific_raw
    resource: !secret dmi_warnings_url
    headers:
      User-Agent: !secret user_agent
    scan_interval: 31536000
    force_update: True
    value_template: "{{ 0 if value_json.warnings|length < 1 else value_json.warnings[0].time }}"
    json_attributes:
      - locationWarnings
      - actualWarnings
      - fivedayWarnings

automation:
  # - alias: update_dmi_weather_radar
  #   trigger:
  #     - platform: state
  #       entity_id: sensor.dmi_weather_raw
  #     - platform: state
  #       entity_id: binary_sensor.home_assistant_loaded
  #       to: "on"
  #   action:
  #     - service: downloader.download_file
  #       data:
  #         url: "https://www.dmi.dk/dmidk_byvejrWS/rest/image/gif/Radar/"
  #         filename: radar.gif
  #         subdir: dmi_weather_radar
  #         overwrite: true

  - alias: severe_weather_warning
    initial_state: true
    trigger:
      platform: template
      value_template: "{{ (state_attr('sensor.dmi_aktuel_varsel', 'category') | int) > 1 }}"
    action:
      - service: notify.telegram_darkfox
        data:
          title: "Vejr Varsel: {{ states('sensor.dmi_aktuel_varsel') }}"
          message: "{{ state_attr('sensor.dmi_aktuel_varsel', 'text') }}"

  - alias: update_dmi_warning_specific_sensor
    trigger:
      - platform: state
        entity_id: sensor.dmi_warnings_raw
      - platform: state
        entity_id: binary_sensor.home_assistant_loaded
        to: "on"
    condition:
      - condition: template
        value_template: "{{ states.sensor.dmi_warnings_raw.attributes.warnings|length > 0 }}"
    action:
      - service: homeassistant.update_entity
        data:
          entity_id: sensor.dmi_warnings_specific_raw

  - alias: update_dmi_warning_sensor
    initial_state: true
    trigger:
      - platform: state
        entity_id: sensor.dmi_warnings_raw
      - platform: state
        entity_id: binary_sensor.home_assistant_loaded
        to: "on"
    action:
      - delay:
          seconds: 5

      - variables:
          actualWarnings: >-
            {% set actualWarnings = state_attr('sensor.dmi_warnings_specific_raw', 'actualWarnings') %}
            {% if actualWarnings and actualWarnings|length > 0 %}
              {{ actualWarnings|tojson }}
            {% else %}
              []
            {% endif %}
          fivedayWarnings: >-
            {% set fivedayWarnings = state_attr('sensor.dmi_warnings_specific_raw', 'fivedayWarnings') %}
            {% if fivedayWarnings and fivedayWarnings|length > 0 %}
              {{ fivedayWarnings|tojson }}
            {% else %}
              []
            {% endif %}

      - service: mqtt.publish
        data:
          topic: "dmi_current_warnings/state"
          retain: True
          payload: >-
            {{ actualWarnings | length }}

      - service: mqtt.publish
        data:
          topic: "dmi_current_warnings/attributes"
          retain: True
          payload: >-
            {% if actualWarnings|length < 1 %}
              {}
            {% else %}
              {
              {% for warning in actualWarnings %}
                "{{ warning.issuedAtText }} {{warning.warningTitle}}": {{ warning | string | replace("'", '"') }}{%- if not loop.last %},{%- endif %}
              {% endfor %}
              }
            {% endif %}

      - service: mqtt.publish
        data:
          topic: "dmi_future_warnings/state"
          retain: True
          payload: >-
            {{ fivedayWarnings|length }}

      - service: mqtt.publish
        data:
          topic: "dmi_future_warnings/attributes"
          retain: True
          payload: >-
            {% if fivedayWarnings|length < 1 %}
              {}
            {% else %}
              {
              {% for warning in fivedayWarnings %}
                "{{ warning.issuedAtText }} {{warning.warningTitle}}": {{ warning | string | replace("'", '"') }}{%- if not loop.last %},{%- endif %}
              {% endfor %}
              }
            {% endif %}

      - condition: template
        value_template: "{{ actualWarnings|length > 0 }}"

      - service: downloader.download_file
        data:
          url: "https://www.dmi.dk/fileadmin/assets/Varselsikoner/{{ actualWarnings[0].icon }}"
          subdir: dmi_warning_icons
          overwrite: true
