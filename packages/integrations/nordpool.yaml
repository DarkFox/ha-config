template:
  - sensor:
      - name: Billigste time
        state: >
          {% set start_time = now().hour %}
          {% set prices = (state_attr("sensor.nordpool_kwh_dk2_dkk",
          "today") + state_attr("sensor.nordpool_kwh_dk2_dkk", "tomorrow"))[start_time:] %}
          {% set index = prices.index(prices | min) %}
          {{today_at("00:00") + timedelta(hours = index + start_time)}}
      - name: Additional Costs
        state: >-
          {% set s = {
            "abonnement": 0.03,
            "elafgift": 0.90,
            "systemydelse": 0.0,
            "transport_lavlast_2021": 0.2363,
            "transport_spidslast_2021": 0.6307,
            "transport_lavlast_2022": 0.3003,
            "transport_spidslast_2022": 0.7651,
          } %}
          {% set afgiftsum = s.abonnement + s.elafgift + s.systemydelse %}
          {% set cdt = now() %}
          {% if cdt < as_datetime("2022-04-01 00:00:00.00+01:00") %}
            {% set transport_lavlast = s.transport_lavlast_2021 %}
            {% set transport_spidslast = s.transport_spidslast_2021 %}
          {% else %}
            {% set transport_lavlast = s.transport_lavlast_2022 %}
            {% set transport_spidslast = s.transport_spidslast_2022 %}
          {% endif %}
          {% if cdt.month >= 10 or cdt.month < 4 %}
            {% if cdt.hour >= 17 and cdt.hour < 20 %}
              {{ ((transport_spidslast + afgiftsum) * 1.25) | round(4) }}
            {% else %}
              {{ ((transport_lavlast + afgiftsum) * 1.25) | round(4) }}
            {% endif %}
          {% else %}
            {{ ((transport_lavlast + afgiftsum) * 1.25) | round(4) }}
          {% endif %}

sensor:
  - platform: template
    sensors:
      nordpool_today_hr_00_01:
        friendly_name: "Today 0-1"
        icon_template: mdi:cash
        unit_of_measurement: "DKK"
        value_template: "{{ states.sensor.nordpool_kwh_dk2_dkk.attributes.today[0] }}"

      nordpool_today_hr_01_02:
        friendly_name: "Today 1-2"
        icon_template: mdi:cash
        unit_of_measurement: "DKK"
        value_template: "{{ states.sensor.nordpool_kwh_dk2_dkk.attributes.today[1] }}"

      nordpool_today_hr_02_03:
        friendly_name: "Today 2-3"
        icon_template: mdi:cash
        unit_of_measurement: "DKK"
        value_template: "{{ states.sensor.nordpool_kwh_dk2_dkk.attributes.today[2] }}"

      nordpool_today_hr_03_04:
        friendly_name: "Today 3-4"
        icon_template: mdi:cash
        unit_of_measurement: "DKK"
        value_template: "{{ states.sensor.nordpool_kwh_dk2_dkk.attributes.today[3] }}"

      nordpool_today_hr_04_05:
        friendly_name: "Today 4-5"
        icon_template: mdi:cash
        unit_of_measurement: "DKK"
        value_template: "{{ states.sensor.nordpool_kwh_dk2_dkk.attributes.today[4] }}"

      nordpool_today_hr_05_06:
        friendly_name: "Today 5-6"
        icon_template: mdi:cash
        unit_of_measurement: "DKK"
        value_template: "{{ states.sensor.nordpool_kwh_dk2_dkk.attributes.today[5] }}"

      nordpool_today_hr_06_07:
        friendly_name: "Today 6-7"
        icon_template: mdi:cash
        unit_of_measurement: "DKK"
        value_template: "{{ states.sensor.nordpool_kwh_dk2_dkk.attributes.today[6] }}"

      nordpool_today_hr_07_08:
        friendly_name: "Today 7-8"
        icon_template: mdi:cash
        unit_of_measurement: "DKK"
        value_template: "{{ states.sensor.nordpool_kwh_dk2_dkk.attributes.today[7] }}"

      nordpool_today_hr_08_09:
        friendly_name: "Today 8-9"
        icon_template: mdi:cash
        unit_of_measurement: "DKK"
        value_template: "{{ states.sensor.nordpool_kwh_dk2_dkk.attributes.today[8] }}"

      nordpool_today_hr_09_10:
        friendly_name: "Today 9-10"
        icon_template: mdi:cash
        unit_of_measurement: "DKK"
        value_template: "{{ states.sensor.nordpool_kwh_dk2_dkk.attributes.today[9] }}"

      nordpool_today_hr_10_11:
        friendly_name: "Today 10-11"
        icon_template: mdi:cash
        unit_of_measurement: "DKK"
        value_template: "{{ states.sensor.nordpool_kwh_dk2_dkk.attributes.today[10] }}"

      nordpool_today_hr_11_12:
        friendly_name: "Today 11-12"
        icon_template: mdi:cash
        unit_of_measurement: "DKK"
        value_template: "{{ states.sensor.nordpool_kwh_dk2_dkk.attributes.today[11] }}"

      nordpool_today_hr_12_13:
        friendly_name: "Today 12-13"
        icon_template: mdi:cash
        unit_of_measurement: "DKK"
        value_template: "{{ states.sensor.nordpool_kwh_dk2_dkk.attributes.today[12] }}"

      nordpool_today_hr_13_14:
        friendly_name: "Today 13-14"
        icon_template: mdi:cash
        unit_of_measurement: "DKK"
        value_template: "{{ states.sensor.nordpool_kwh_dk2_dkk.attributes.today[13] }}"

      nordpool_today_hr_14_15:
        friendly_name: "Today 14-15"
        icon_template: mdi:cash
        unit_of_measurement: "DKK"
        value_template: "{{ states.sensor.nordpool_kwh_dk2_dkk.attributes.today[14] }}"

      nordpool_today_hr_15_16:
        friendly_name: "Today 15-16"
        icon_template: mdi:cash
        unit_of_measurement: "DKK"
        value_template: "{{ states.sensor.nordpool_kwh_dk2_dkk.attributes.today[15] }}"

      nordpool_today_hr_16_17:
        friendly_name: "Today 16-17"
        icon_template: mdi:cash
        unit_of_measurement: "DKK"
        value_template: "{{ states.sensor.nordpool_kwh_dk2_dkk.attributes.today[16] }}"

      nordpool_today_hr_17_18:
        friendly_name: "Today 17-18"
        icon_template: mdi:cash
        unit_of_measurement: "DKK"
        value_template: "{{ states.sensor.nordpool_kwh_dk2_dkk.attributes.today[17] }}"

      nordpool_today_hr_18_19:
        friendly_name: "Today 18-19"
        icon_template: mdi:cash
        unit_of_measurement: "DKK"
        value_template: "{{ states.sensor.nordpool_kwh_dk2_dkk.attributes.today[18] }}"

      nordpool_today_hr_19_20:
        friendly_name: "Today 19-20"
        icon_template: mdi:cash
        unit_of_measurement: "DKK"
        value_template: "{{ states.sensor.nordpool_kwh_dk2_dkk.attributes.today[19] }}"

      nordpool_today_hr_20_21:
        friendly_name: "Today 20-21"
        icon_template: mdi:cash
        unit_of_measurement: "DKK"
        value_template: "{{ states.sensor.nordpool_kwh_dk2_dkk.attributes.today[20] }}"

      nordpool_today_hr_21_22:
        friendly_name: "Today 21-22"
        icon_template: mdi:cash
        unit_of_measurement: "DKK"
        value_template: "{{ states.sensor.nordpool_kwh_dk2_dkk.attributes.today[21] }}"

      nordpool_today_hr_22_23:
        friendly_name: "Today 22-23"
        icon_template: mdi:cash
        unit_of_measurement: "DKK"
        value_template: "{{ states.sensor.nordpool_kwh_dk2_dkk.attributes.today[22] }}"

      nordpool_today_hr_23_24:
        friendly_name: "Today 23-24"
        icon_template: mdi:cash
        unit_of_measurement: "DKK"
        value_template: "{{ states.sensor.nordpool_kwh_dk2_dkk.attributes.today[23] }}"

      nordpool_tomorrow_hr_00_01:
        friendly_name: "Tomorrow 0-1"
        icon_template: mdi:cash
        unit_of_measurement: "DKK"
        value_template: "{{ states.sensor.nordpool_kwh_dk2_dkk.attributes.tomorrow[0] }}"

      nordpool_tomorrow_hr_01_02:
        friendly_name: "Tomorrow 1-2"
        icon_template: mdi:cash
        unit_of_measurement: "DKK"
        value_template: "{{ states.sensor.nordpool_kwh_dk2_dkk.attributes.tomorrow[1] }}"

      nordpool_tomorrow_hr_02_03:
        friendly_name: "Tomorrow 2-3"
        icon_template: mdi:cash
        unit_of_measurement: "DKK"
        value_template: "{{ states.sensor.nordpool_kwh_dk2_dkk.attributes.tomorrow[2] }}"

      nordpool_tomorrow_hr_03_04:
        friendly_name: "Tomorrow 3-4"
        icon_template: mdi:cash
        unit_of_measurement: "DKK"
        value_template: "{{ states.sensor.nordpool_kwh_dk2_dkk.attributes.tomorrow[3] }}"

      nordpool_tomorrow_hr_04_05:
        friendly_name: "Tomorrow 4-5"
        icon_template: mdi:cash
        unit_of_measurement: "DKK"
        value_template: "{{ states.sensor.nordpool_kwh_dk2_dkk.attributes.tomorrow[4] }}"

      nordpool_tomorrow_hr_05_06:
        friendly_name: "Tomorrow 5-6"
        icon_template: mdi:cash
        unit_of_measurement: "DKK"
        value_template: "{{ states.sensor.nordpool_kwh_dk2_dkk.attributes.tomorrow[5] }}"

      nordpool_tomorrow_hr_06_07:
        friendly_name: "Tomorrow 6-7"
        icon_template: mdi:cash
        unit_of_measurement: "DKK"
        value_template: "{{ states.sensor.nordpool_kwh_dk2_dkk.attributes.tomorrow[6] }}"

      nordpool_tomorrow_hr_07_08:
        friendly_name: "Tomorrow 7-8"
        icon_template: mdi:cash
        unit_of_measurement: "DKK"
        value_template: "{{ states.sensor.nordpool_kwh_dk2_dkk.attributes.tomorrow[7] }}"

      nordpool_tomorrow_hr_08_09:
        friendly_name: "Tomorrow 8-9"
        icon_template: mdi:cash
        unit_of_measurement: "DKK"
        value_template: "{{ states.sensor.nordpool_kwh_dk2_dkk.attributes.tomorrow[8] }}"

      nordpool_tomorrow_hr_09_10:
        friendly_name: "Tomorrow 9-10"
        icon_template: mdi:cash
        unit_of_measurement: "DKK"
        value_template: "{{ states.sensor.nordpool_kwh_dk2_dkk.attributes.tomorrow[9] }}"

      nordpool_tomorrow_hr_10_11:
        friendly_name: "Tomorrow 10-11"
        icon_template: mdi:cash
        unit_of_measurement: "DKK"
        value_template: "{{ states.sensor.nordpool_kwh_dk2_dkk.attributes.tomorrow[10] }}"

      nordpool_tomorrow_hr_11_12:
        friendly_name: "Tomorrow 11-12"
        icon_template: mdi:cash
        unit_of_measurement: "DKK"
        value_template: "{{ states.sensor.nordpool_kwh_dk2_dkk.attributes.tomorrow[11] }}"

      nordpool_tomorrow_hr_12_13:
        friendly_name: "Tomorrow 12-13"
        icon_template: mdi:cash
        unit_of_measurement: "DKK"
        value_template: "{{ states.sensor.nordpool_kwh_dk2_dkk.attributes.tomorrow[12] }}"

      nordpool_tomorrow_hr_13_14:
        friendly_name: "Tomorrow 13-14"
        icon_template: mdi:cash
        unit_of_measurement: "DKK"
        value_template: "{{ states.sensor.nordpool_kwh_dk2_dkk.attributes.tomorrow[13] }}"

      nordpool_tomorrow_hr_14_15:
        friendly_name: "Tomorrow 14-15"
        icon_template: mdi:cash
        unit_of_measurement: "DKK"
        value_template: "{{ states.sensor.nordpool_kwh_dk2_dkk.attributes.tomorrow[14] }}"

      nordpool_tomorrow_hr_15_16:
        friendly_name: "Tomorrow 15-16"
        icon_template: mdi:cash
        unit_of_measurement: "DKK"
        value_template: "{{ states.sensor.nordpool_kwh_dk2_dkk.attributes.tomorrow[15] }}"

      nordpool_tomorrow_hr_16_17:
        friendly_name: "Tomorrow 16-17"
        icon_template: mdi:cash
        unit_of_measurement: "DKK"
        value_template: "{{ states.sensor.nordpool_kwh_dk2_dkk.attributes.tomorrow[16] }}"

      nordpool_tomorrow_hr_17_18:
        friendly_name: "Tomorrow 17-18"
        icon_template: mdi:cash
        unit_of_measurement: "DKK"
        value_template: "{{ states.sensor.nordpool_kwh_dk2_dkk.attributes.tomorrow[17] }}"

      nordpool_tomorrow_hr_18_19:
        friendly_name: "Tomorrow 18-19"
        icon_template: mdi:cash
        unit_of_measurement: "DKK"
        value_template: "{{ states.sensor.nordpool_kwh_dk2_dkk.attributes.tomorrow[18] }}"

      nordpool_tomorrow_hr_19_20:
        friendly_name: "Tomorrow 19-20"
        icon_template: mdi:cash
        unit_of_measurement: "DKK"
        value_template: "{{ states.sensor.nordpool_kwh_dk2_dkk.attributes.tomorrow[19] }}"

      nordpool_tomorrow_hr_20_21:
        friendly_name: "Tomorrow 20-21"
        icon_template: mdi:cash
        unit_of_measurement: "DKK"
        value_template: "{{ states.sensor.nordpool_kwh_dk2_dkk.attributes.tomorrow[20] }}"

      nordpool_tomorrow_hr_21_22:
        friendly_name: "Tomorrow 21-22"
        icon_template: mdi:cash
        unit_of_measurement: "DKK"
        value_template: "{{ states.sensor.nordpool_kwh_dk2_dkk.attributes.tomorrow[21] }}"

      nordpool_tomorrow_hr_22_23:
        friendly_name: "Tomorrow 22-23"
        icon_template: mdi:cash
        unit_of_measurement: "DKK"
        value_template: "{{ states.sensor.nordpool_kwh_dk2_dkk.attributes.tomorrow[22] }}"

      nordpool_tomorrow_hr_23_24:
        friendly_name: "Tomorrow 23-24"
        icon_template: mdi:cash
        unit_of_measurement: "DKK"
        value_template: "{{ states.sensor.nordpool_kwh_dk2_dkk.attributes.tomorrow[23] }}"
