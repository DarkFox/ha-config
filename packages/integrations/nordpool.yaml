template:
  - sensor:
      - name: Kommende Elpriser
        state: "{{ states('sensor.nordpool_kwh_dk2_dkk') }}"
        attributes:
          prices: >-
            {{ (state_attr("sensor.nordpool_kwh_dk2_dkk", "today") + state_attr("sensor.nordpool_kwh_dk2_dkk", "tomorrow"))[now().hour:] }}

      - name: Elpriser Extrema
        state: "OK"
        attributes:
          min: "{{ state_attr('sensor.kommende_elpriser', 'prices') | min }}"
          max: "{{ state_attr('sensor.kommende_elpriser', 'prices') | max }}"
          minima: >-
            {%- set prices = state_attr('sensor.kommende_elpriser', 'prices') -%}
            {%- for price in prices -%}
                {%- if not loop.last and prices[loop.index0-1] > price and prices[loop.index0+1] > price -%}
                  {{ price }},
                {%- endif -%}
            {%- endfor -%}
          maxima: >-
            {%- set prices = state_attr('sensor.kommende_elpriser', 'prices') -%}
            {%- for price in prices -%}
                {%- if not loop.last and prices[loop.index0-1] < price and prices[loop.index0+1] < price -%}
                  {{ price }},
                {%- endif -%}
            {%- endfor -%}

      - name: Næste billige time
        state: >-
          {%- set prices = state_attr('sensor.kommende_elpriser', 'prices') -%}
          {%- set index = prices.index(state_attr('sensor.elpriser_extrema', 'minima')[0]) -%}
          {{today_at("00:00") + timedelta(hours = index + now().hour)}}

      - name: Næste billige time relative
        state: >-
          {% set time_diff =  ((as_timestamp(states('sensor.naeste_billige_time')) - as_timestamp(now())) / 60) | int %}
          {% if time_diff <= 0 %}
            Nu!
          {% elif time_diff > 60 %}
            Om {{(time_diff / 60) | int}} time{{ 'r' if time_diff > 120 }} og {{(time_diff % 60) }} minutter
          {% else %}
            Om {{time_diff}} minutter
          {% endif %}

      - name: Billigste time
        state: >-
          {%- set prices = state_attr('sensor.kommende_elpriser', 'prices') -%}
          {%- set index = prices.index(state_attr('sensor.elpriser_extrema', 'min')) -%}
          {{today_at("00:00") + timedelta(hours = index + now().hour)}}

      - name: Billigste time relative
        state: >-
          {% set time_diff =  ((as_timestamp(states('sensor.billigste_time')) - as_timestamp(now())) / 60) | int %}
          {% if time_diff <= 0 %}
            Nu!
          {% elif time_diff > 60 %}
            Om {{(time_diff / 60) | int}} time{{ 'r' if time_diff > 120 }} og {{(time_diff % 60) }} minutter
          {% else %}
            Om {{time_diff}} minutter
          {% endif %}

      - name: Nordpool Additional Costs
        state: >-
          {% set s = {
            "abonnement": 0.03,
            "elafgift": 0.90,
            "systemydelse": 0.0,
            "transport_lavlast_2021": 0.2363,
            "transport_spidslast_2021": 0.6307,
            "transport_lavlast_2022": 0.3003,
            "transport_spidslast_2022": 0.7651,
          } %}
          {% set afgiftsum = s.abonnement + s.elafgift + s.systemydelse %}
          {% set cdt = now() %}
          {% if cdt < as_datetime("2022-04-01 00:00:00.00+01:00") %}
            {% set transport_lavlast = s.transport_lavlast_2021 %}
            {% set transport_spidslast = s.transport_spidslast_2021 %}
          {% else %}
            {% set transport_lavlast = s.transport_lavlast_2022 %}
            {% set transport_spidslast = s.transport_spidslast_2022 %}
          {% endif %}
          {% if cdt.month >= 10 or cdt.month < 4 %}
            {% if cdt.hour >= 17 and cdt.hour < 20 %}
              {{ ((transport_spidslast + afgiftsum) * 1.25) | round(4) }}
            {% else %}
              {{ ((transport_lavlast + afgiftsum) * 1.25) | round(4) }}
            {% endif %}
          {% else %}
            {{ ((transport_lavlast + afgiftsum) * 1.25) | round(4) }}
          {% endif %}
