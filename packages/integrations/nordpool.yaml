template:
  - sensor:
      - name: Billigste time
        state: >-
          {% set start_time = now().hour %}
          {% set off_peak_1 = state_attr("sensor.nordpool_kwh_dk2_dkk", "off_peak_1") %}
          {% set off_peak_2 = state_attr("sensor.nordpool_kwh_dk2_dkk", "off_peak_2") %}
          {% set prices = (state_attr("sensor.nordpool_kwh_dk2_dkk", "today") + state_attr("sensor.nordpool_kwh_dk2_dkk", "tomorrow"))[start_time:] %}

          {% set index_min = prices.index(prices | min) %}
          {% set index_off_peak_1 = prices.index(off_peak_1) if off_peak_1 in prices else 999 %}
          {% set index_off_peak_2 = prices.index(off_peak_2) if off_peak_2 in prices else 999 %}
          {% set index = [index_min, index_off_peak_1, index_off_peak_2] | min %}

          {{today_at("00:00") + timedelta(hours = index + start_time)}}

      - name: Billigste time relative
        state: >-
          {% set time_diff =  ((as_timestamp(states('sensor.billigste_time')) - as_timestamp(now())) / 60) | int %}
          {% if time_diff <= 0 %}
            Nu!
          {% elif time_diff > 60 %}
            Om {{(time_diff / 60) | int}} time{{ 'r' if time_diff > 120 }} og {{(time_diff % 60) }} minutter
          {% else %}
            Om {{time_diff}} minutter
          {% endif %}

      - name: Nordpool Additional Costs
        state: >-
          {% set s = {
            "abonnement": 0.03,
            "elafgift": 0.90,
            "systemydelse": 0.0,
            "transport_lavlast_2021": 0.2363,
            "transport_spidslast_2021": 0.6307,
            "transport_lavlast_2022": 0.3003,
            "transport_spidslast_2022": 0.7651,
          } %}
          {% set afgiftsum = s.abonnement + s.elafgift + s.systemydelse %}
          {% set cdt = now() %}
          {% if cdt < as_datetime("2022-04-01 00:00:00.00+01:00") %}
            {% set transport_lavlast = s.transport_lavlast_2021 %}
            {% set transport_spidslast = s.transport_spidslast_2021 %}
          {% else %}
            {% set transport_lavlast = s.transport_lavlast_2022 %}
            {% set transport_spidslast = s.transport_spidslast_2022 %}
          {% endif %}
          {% if cdt.month >= 10 or cdt.month < 4 %}
            {% if cdt.hour >= 17 and cdt.hour < 20 %}
              {{ ((transport_spidslast + afgiftsum) * 1.25) | round(4) }}
            {% else %}
              {{ ((transport_lavlast + afgiftsum) * 1.25) | round(4) }}
            {% endif %}
          {% else %}
            {{ ((transport_lavlast + afgiftsum) * 1.25) | round(4) }}
          {% endif %}
