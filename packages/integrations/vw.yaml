switch:
  - platform: template
    switches:
      id3_charging:
        friendly_name: ID.3 Charging
        value_template: "{{ not is_state('sensor.id3_charging_mode', 'off') }}"
        icon_template: "{{ 'mdi:battery-charging' if not is_state('sensor.id3_charging_mode', 'off') else 'mdi:battery' }}"
        turn_on:
          service: volkswagen_we_connect_id.volkswagen_id_start_stop_charging
          data:
            vin: !secret vw_vin
            start_stop: "start"
        turn_off:
          service: volkswagen_we_connect_id.volkswagen_id_start_stop_charging
          data:
            vin: !secret vw_vin
            start_stop: "stop"

      id3_climatisation:
        friendly_name: ID.3 Climatisation
        value_template: "{{ is_state('binary_sensor.id3_climatising', 'on') }}"
        icon_template: "{{ 'mdi:hvac' if is_state('binary_sensor.id3_climatising', 'on') else 'mdi:hvac-off' }}"
        turn_on:
          service: volkswagen_we_connect_id.volkswagen_id_set_climatisation
          data:
            vin: !secret vw_vin
            start_stop: "start"
        turn_off:
          service: volkswagen_we_connect_id.volkswagen_id_set_climatisation
          data:
            vin: !secret vw_vin
            start_stop: "stop"

      id3_reduced_ac_charging_speed:
        friendly_name: ID.3 Reduced AC Charging Speed
        value_template: "{{ is_state('sensor.id3_max_charge_current_ac', 'reduced') }}"
        icon_template: mdi:flash
        turn_on:
          service: volkswagen_we_connect_id.volkswagen_id_set_ac_charge_speed
          data:
            vin: !secret vw_vin
            maximum_reduced: "reduced"
        turn_off:
          service: volkswagen_we_connect_id.volkswagen_id_set_ac_charge_speed
          data:
            vin: !secret vw_vin
            maximum_reduced: "maximum"

binary_sensor:
  - platform: template
    sensors:
      id3_climatising:
        friendly_name: "ID.3 Klimatisering"
        value_template: "{{ states('sensor.id3_remaining_climatisation_time') | int > 0 }}"
        icon_template: "{{ 'mdi:hvac' if is_state('binary_sensor.id3_climatising', 'on') else 'mdi:hvac-off' }}"
      id3_charging:
        friendly_name: ID.3 Is Charging
        value_template: "{{ is_state('sensor.id3_charging_state', 'charging') }}"
        icon_template: "{{ 'mdi:battery-charging' if not is_state('sensor.id3_charging', 'off') else 'mdi:battery' }}"

sensor:
  - platform: template
    sensors:
      id3_remaining_charging_time_to_complete:
        friendly_name: "ID.3 Charging Time Remaining"
        value_template: "{{ (timedelta(minutes=states('sensor.id3_remaining_charging_time')|int)|string)[:-3] }}"
        icon_template: mdi:clock-end
      id3_charging_complete_at:
        friendly_name: ID.3 Charging Complete At
        value_template: >-
          {%- if is_state('binary_sensor.id3_charging', 'on') -%}
            {%- set end_time = (states('sensor.id3_remaining_charging_time')|int*60) + (as_timestamp(now())|int) -%}
            {{ end_time | timestamp_custom('%Y-%m-%d %H:%M') }}
          {%- else -%}
            unknown
          {%- endif -%}
        icon_template: mdi:clock-end
      abrp_url_data:
        friendly_name: ABRP URL data
        value_template: "OK"
        attribute_templates:
          url_data: >-
            {
              "soc": {{int(states('sensor.id3_state_of_charge'))}},
              "est_battery_range": {{int(states('sensor.id3_range'))}},
              {% if is_state('binary_sensor.id3_charging', 'on') %}
                "power": {{-float(states('sensor.id3_charge_power'))}},
              {% endif %}
              "is_charging": {{bool(states('binary_sensor.id3_charging'))}},
              "is_dcfc": {{bool(is_state('sensor.id3_charge_type', 'dc'))}},
              "is_parked": {{not bool(states('binary_sensor.volkswagen_id_3_ignition'))}},
              "ext_temp": {{int(states('sensor.volkswagen_id_3_outdoortemperature'))}},
              "odometer": {{int(states('sensor.volkswagen_id_3_odometer'))}},
              {% if is_state('binary_sensor.darkphone_high_accuracy_mode', 'on') %}
                "speed": {{int(state_attr('device_tracker.darkphone', 'speed'))}},
                "lat": {{float(state_attr('device_tracker.darkphone', 'latitude'))}},
                "lon": {{float(state_attr('device_tracker.darkphone', 'longitude'))}},
                "heading": {{int(state_attr('device_tracker.darkphone', 'course'), 0)}},
                "elevation": {{float(state_attr('device_tracker.darkphone', 'altitude'))}}
              {% else %}
                "speed": {{int(states('sensor.volkswagen_id_3_speed'))}},
                "lat": {{float(state_attr('device_tracker.volkswagen_id_3_geolocation', 'latitude'))}},
                "lon": {{float(state_attr('device_tracker.volkswagen_id_3_geolocation', 'longitude'))}},
                "heading": {{int(state_attr('sensor.volkswagen_id_3_speed', 'direction'), 0)}}
              {% endif %}
            }
      abrp_url_params:
        friendly_name: ABRP URL params
        value_template: "OK"
        attribute_templates:
          url_params: >-
            {%- set p = state_attr('sensor.abrp_url_data', 'url_data') -%}
            {%- if p == None -%}
              unknown
            {%- else -%}
              {
                "utc": {{int(as_timestamp(utcnow()))}},
                {%- for k in p -%}
                  "{{k}}": {{p[k]}},
                {%- endfor -%}
              }
            {%- endif -%}

rest_command:
  update_abrp:
    method: POST
    content_type: "charset=utf-8; application/x-www-form-urlencoded"
    url: "https://api.iternio.com/1/tlm/send?api_key={{api_key}}&token={{token}}&tlm={{state_attr('sensor.abrp_url_params', 'url_params')|to_json|urlencode}}"

automation:
  - alias: Push car to ABRP
    initial_state: true
    mode: single
    trigger:
      - platform: state
        entity_id: sensor.abrp_url_data
        attribute: url_data
      - platform: time_pattern
        minutes: "/8"
    action:
      - service: rest_command.update_abrp
        data:
          token: !secret abrp_token
          api_key: !secret abrp_api_key
      - delay:
          seconds: 1
