switch:
  - platform: template
    switches:
      id_3_pro_charging:
        friendly_name: ID.3 Pro Charging
        unique_id: id_3_pro_charging
        value_template: "{{ not is_state('sensor.id_3_pro_charging_mode', 'off') }}"
        icon_template: "{{ 'mdi:battery-charging' if not is_state('sensor.id_3_pro_charging_mode', 'off') else 'mdi:battery' }}"
        turn_on:
          service: volkswagen_we_connect_id.volkswagen_id_start_stop_charging
          data:
            vin: !secret vw_vin
            start_stop: "start"
        turn_off:
          service: volkswagen_we_connect_id.volkswagen_id_start_stop_charging
          data:
            vin: !secret vw_vin
            start_stop: "stop"

      id_3_pro_climatisation:
        friendly_name: ID.3 Pro Climatisation
        unique_id: id_3_pro_climatisation
        value_template: "{{ is_state('binary_sensor.id_3_pro_klimatisering', 'on') }}"
        icon_template: "{{ 'mdi:hvac' if is_state('binary_sensor.id_3_pro_klimatisering', 'on') else 'mdi:hvac-off' }}"
        turn_on:
          service: volkswagen_we_connect_id.volkswagen_id_set_climatisation
          data:
            vin: !secret vw_vin
            start_stop: "start"
        turn_off:
          service: volkswagen_we_connect_id.volkswagen_id_set_climatisation
          data:
            vin: !secret vw_vin
            start_stop: "stop"

      id_3_pro_reduced_ac_charging_speed:
        friendly_name: ID.3 Pro Reduced AC Charging Speed
        unique_id: id_3_pro_reduced_ac_charging_speed
        value_template: "{{ is_state('sensor.id_3_pro_max_charge_current_ac', 'reduced') }}"
        icon_template: mdi:flash
        turn_on:
          service: volkswagen_we_connect_id.volkswagen_id_set_ac_charge_speed
          data:
            vin: !secret vw_vin
            maximum_reduced: "reduced"
        turn_off:
          service: volkswagen_we_connect_id.volkswagen_id_set_ac_charge_speed
          data:
            vin: !secret vw_vin
            maximum_reduced: "maximum"

template:
  - binary_sensor:
      - name: ID.3 Pro Locked
        unique_id: id_3_pro_locked
        state: >-
          {{
            is_state('sensor.id_3_pro_door_front_left_lock_status', 'unlocked')
            or is_state('sensor.id_3_pro_door_front_right_lock_status', 'unlocked')
            or is_state('sensor.id_3_pro_door_rear_left_lock_status', 'unlocked')
            or is_state('sensor.id_3_pro_door_rear_right_lock_status', 'unlocked')
            or is_state('sensor.id_3_pro_trunk_lock_status', 'unlocked')
          }}
        device_class: lock
      - name: "ID.3 Pro Klimatisering"
        unique_id: id_3_pro_climatising
        state: "{{ states('sensor.id_3_pro_remaining_climatisation_time') | int > 0 }}"
        attributes:
          icon: "{{ 'mdi:hvac' if is_state('binary_sensor.id_3_pro_klimatisering', 'on') else 'mdi:hvac-off' }}"
      - name: ID.3 Pro Is Charging
        unique_id: id_3_pro_charging
        state: "{{ is_state('sensor.id_3_pro_charging_state', 'charging') }}"
        attributes:
          icon: "{{ 'mdi:battery-charging' if not is_state('sensor.id_3_pro_charging', 'off') else 'mdi:battery' }}"

  - sensor:
      - name: "ID.3 Pro Charging Time Remaining"
        unique_id: id_3_pro_remaining_charging_time_to_complete
        state: "{{ (timedelta(minutes=states('sensor.id_3_pro_remaining_charging_time')|int)|string)[:-3] }}"
        attributes:
          icon: mdi:clock-end

      - name: ID.3 Pro Charging Complete At
        unique_id: id_3_pro_charging_complete_at
        state: >-
          {%- if is_state('binary_sensor.id_3_pro_is_charging', 'on') -%}
            {%- set end_time = (states('sensor.id_3_pro_remaining_charging_time')|int*60) + (as_timestamp(now())|int) -%}
            {{ end_time | timestamp_local }}
          {%- else -%}
            unknown
          {%- endif -%}
        attributes:
          icon: mdi:clock-end
        device_class: timestamp

automation:
  - alias: Force VW data update on phone notification
    initial_state: true
    mode: single
    trigger:
      - platform: state
        entity_id: sensor.darkphone_last_notification_post_time
    condition:
      - condition: state
        entity_id: sensor.darkphone_last_notification
        state: "com.volkswagen.weconnect"
    action:
      - service: homeassistant.update_entity
        target:
          entity_id: sensor.id_3_pro_charging_mode
