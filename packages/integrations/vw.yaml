input_number:
  id_3_target_soc:
    name: Lademål
    min: 50
    max: 100
    step: 10

climate:
  - platform: mqtt
    name: ID.3 Klima
    retain: true
    current_temperature_topic: vw-connect/0/status/climatisationSettings/targetTemperature_C
    mode_command_topic: virtual/id3/climatisation
    mode_state_topic: vw-connect/0/remote/climatisation
    mode_state_template: "{{ 'auto' if value == 'true' else 'off' }}"
    modes:
      - "off"
      - "auto"
    temperature_command_topic: vw-connect/0/status/climatisationSettings/targetTemperature_C
    temperature_state_topic: vw-connect/0/status/climatisationSettings/targetTemperature_C
    action_topic: vw-connect/0/status/climatisationStatus/climatisationState
    temp_step: 0.5
    min_temp: 16
    max_temp: 29.5
    send_if_off: true

automation:
  - alias: id3_hvac_mode_transform
    initial_state: true
    trigger:
      - platform: mqtt
        topic: virtual/id3/climatisation
    action:
      - service: "switch.turn_{{ 'on' if trigger.payload == 'auto' else 'off' }}"
        data:
          entity_id: switch.vw_connect_climatisation

  - alias: "Set ID.3 target SoC slider"
    initial_state: true
    trigger:
      platform: mqtt
      topic: vw-connect/0/status/chargingSettings/targetSOC_pct
    action:
      service: input_number.set_value
      target:
        entity_id: input_number.id_3_target_soc
      data:
        value: "{{ trigger.payload }}"
  - alias: "ID.3 target SoC slider moved"
    initial_state: true
    trigger:
      platform: state
      entity_id: input_number.id_3_target_soc
    action:
      service: mqtt.publish
      data:
        topic: vw-connect/0/status/chargingSettings/targetSOC_pct
        retain: true
        payload: "{{ states('input_number.id_3_target_soc') | int }}"

switch:
  - platform: mqtt
    name: vw_connect_charging
    command_topic: vw-connect/0/remote/charging
    state_topic: vw-connect/0/remote/charging
    payload_on: "true"
    payload_off: "false"

  - platform: mqtt
    name: vw_connect_auto_unlock_plug_when_charged
    command_topic: vw-connect/0/status/chargingSettings/autoUnlockPlugWhenCharged
    state_topic: vw-connect/0/status/chargingSettings/autoUnlockPlugWhenCharged
    payload_on: "true"
    payload_off: "false"

  - platform: mqtt
    name: vw_connect_reduced_charge_current_ac
    command_topic: vw-connect/0/status/chargingSettings/maxChargeCurrentAC
    state_topic: vw-connect/0/status/chargingSettings/maxChargeCurrentAC
    payload_on: "reduced"
    payload_off: "maximum"

  - platform: mqtt
    name: vw_connect_climatisation
    command_topic: vw-connect/0/remote/climatisation
    state_topic: vw-connect/0/remote/climatisation
    payload_on: "true"
    payload_off: "false"

  - platform: mqtt
    name: vw_connect_climatisation_without_external_power
    command_topic: vw-connect/0/status/climatisationSettings/climatisationWithoutExternalPower
    state_topic: vw-connect/0/status/climatisationSettings/climatisationWithoutExternalPower
    payload_on: "true"
    payload_off: "false"

  - platform: mqtt
    name: vw_connect_climatization_at_unlock
    command_topic: vw-connect/0/status/climatisationSettings/climatizationAtUnlock
    state_topic: vw-connect/0/status/climatisationSettings/climatizationAtUnlock
    payload_on: "true"
    payload_off: "false"

  - platform: mqtt
    name: vw_connect_window_heating_enabled
    command_topic: vw-connect/0/status/climatisationSettings/windowHeatingEnabled
    state_topic: vw-connect/0/status/climatisationSettings/windowHeatingEnabled
    payload_on: "true"
    payload_off: "false"

  - platform: mqtt
    name: vw_connect_climatisation_front_left
    command_topic: vw-connect/0/status/climatisationSettings/zoneFrontLeftEnabled
    state_topic: vw-connect/0/status/climatisationSettings/zoneFrontLeftEnabled
    payload_on: "true"
    payload_off: "false"

  - platform: mqtt
    name: vw_connect_climatisation_front_right
    command_topic: vw-connect/0/status/climatisationSettings/zoneFrontRightEnabled
    state_topic: vw-connect/0/status/climatisationSettings/zoneFrontRightEnabled
    payload_on: "true"
    payload_off: "false"

binary_sensor:
  - platform: template
    sensors:
      id_3_climatising:
        friendly_name: "ID.3 Klimatisering"
        value_template: "{{ states('sensor.vw_connect_remaining_climatisation_time_min') | int > 0 }}"

      id_3_timer_1:
        friendly_name: "ID.3 Timer 1"
        value_template: "{{ is_state('binary_sensor.vw_connect_climatisation_timer_1_enabled', 'on') }}"
        attribute_templates:
          recurring: "{{ is_state('group.id_3_timer_1_recurring', 'on') }}"
          single_start_date_time: "{{ states('sensor.vw_connect_climatisation_timer_1_single_start_date_time') }}"
          recurring_start_time: "{{ states('sensor.vw_connect_climatisation_timer_1_recurring_start_time') }}"
          recurring_on_mondays: "{{ is_state('binary_sensor.vw_connect_climatisation_timer_1_recurring_on_mondays', 'on') }}"
          recurring_on_tuesdays: "{{ is_state('binary_sensor.vw_connect_climatisation_timer_1_recurring_on_tuesdays', 'on') }}"
          recurring_on_wednesdays: "{{ is_state('binary_sensor.vw_connect_climatisation_timer_1_recurring_on_wednesdays', 'on') }}"
          recurring_on_thursdays: "{{ is_state('binary_sensor.vw_connect_climatisation_timer_1_recurring_on_thursdays', 'on') }}"
          recurring_on_fridays: "{{ is_state('binary_sensor.vw_connect_climatisation_timer_1_recurring_on_fridays', 'on') }}"
          recurring_on_saturdays: "{{ is_state('binary_sensor.vw_connect_climatisation_timer_1_recurring_on_saturdays', 'on') }}"
          recurring_on_sundays: "{{ is_state('binary_sensor.vw_connect_climatisation_timer_1_recurring_on_sundays', 'on') }}"
          description: >-
            {% if is_state('binary_sensor.id_3_timer_1', 'on') %}
              {% set attr = states.binary_sensor.id_3_timer_1.attributes %}
              {% if attr.recurring %}
                {%- set days = [
                  'man' if attr.recurring_on_mondays,
                  "tir" if attr.recurring_on_tuesdays,
                  "ons" if attr.recurring_on_wednesdays,
                  "tor" if attr.recurring_on_thursdays,
                  "fre" if attr.recurring_on_fridays,
                  "lør" if attr.recurring_on_saturdays,
                  "søn" if attr.recurring_on_sundays
                ]|select("defined")|list -%}
                {{ attr.recurring_start_time }} - {{ days|join(', ') }}.
              {% else %}
                {{ attr.single_start_date_time }}
              {% endif %}
            {% else %}
              Off
            {% endif %}

      id_3_timer_2:
        friendly_name: "ID.3 Timer 2"
        value_template: "{{ is_state('binary_sensor.vw_connect_climatisation_timer_2_enabled', 'on') }}"
        attribute_templates:
          recurring: "{{ is_state('group.id_3_timer_2_recurring', 'on') }}"
          single_start_date_time: "{{ states('sensor.vw_connect_climatisation_timer_2_single_start_date_time') }}"
          recurring_start_time: "{{ states('sensor.vw_connect_climatisation_timer_2_recurring_start_time') }}"
          recurring_on_mondays: "{{ is_state('binary_sensor.vw_connect_climatisation_timer_2_recurring_on_mondays', 'on') }}"
          recurring_on_tuesdays: "{{ is_state('binary_sensor.vw_connect_climatisation_timer_2_recurring_on_tuesdays', 'on') }}"
          recurring_on_wednesdays: "{{ is_state('binary_sensor.vw_connect_climatisation_timer_2_recurring_on_wednesdays', 'on') }}"
          recurring_on_thursdays: "{{ is_state('binary_sensor.vw_connect_climatisation_timer_2_recurring_on_thursdays', 'on') }}"
          recurring_on_fridays: "{{ is_state('binary_sensor.vw_connect_climatisation_timer_2_recurring_on_fridays', 'on') }}"
          recurring_on_saturdays: "{{ is_state('binary_sensor.vw_connect_climatisation_timer_2_recurring_on_saturdays', 'on') }}"
          recurring_on_sundays: "{{ is_state('binary_sensor.vw_connect_climatisation_timer_2_recurring_on_sundays', 'on') }}"
          description: >-
            {% if is_state('binary_sensor.id_3_timer_2', 'on') %}
              {% set attr = states.binary_sensor.id_3_timer_2.attributes %}
              {% if attr.recurring %}
                {%- set days = [
                  'man' if attr.recurring_on_mondays,
                  "tir" if attr.recurring_on_tuesdays,
                  "ons" if attr.recurring_on_wednesdays,
                  "tor" if attr.recurring_on_thursdays,
                  "fre" if attr.recurring_on_fridays,
                  "lør" if attr.recurring_on_saturdays,
                  "søn" if attr.recurring_on_sundays
                ]|select("defined")|list -%}
                {{ attr.recurring_start_time }} - {{ days|join(', ') }}.
              {% else %}
                {{ attr.single_start_date_time }}
              {% endif %}
            {% else %}
              Off
            {% endif %}

  - platform: mqtt
    state_topic: vw-connect/0/info/connection
    name: vw_connect_connection
    payload_on: "true"
    payload_off: "false"

  - platform: mqtt
    state_topic: vw-connect/0/status/windowHeatingStatus/windowHeatingStatus/front
    name: vw_connect_window_heating_status_front
    payload_on: "true"
    payload_off: "false"

  - platform: mqtt
    state_topic: vw-connect/0/status/windowHeatingStatus/windowHeatingStatus/rear
    name: vw_connect_window_heating_status_rear
    payload_on: "true"
    payload_off: "false"

  - platform: mqtt
    state_topic: vw-connect/0/status/climatisationTimer/1/enabled
    name: vw_connect_climatisation_timer_1_enabled
    payload_on: "true"
    payload_off: "false"
  - platform: mqtt
    name: vw_connect_climatisation_timer_1_recurring_on_mondays
    state_topic: vw-connect/0/status/climatisationTimer/1/recurringTimer/recurringOn/mondays
    payload_on: "true"
    payload_off: "false"
  - platform: mqtt
    name: vw_connect_climatisation_timer_1_recurring_on_tuesdays
    state_topic: vw-connect/0/status/climatisationTimer/1/recurringTimer/recurringOn/tuesdays
    payload_on: "true"
    payload_off: "false"
  - platform: mqtt
    name: vw_connect_climatisation_timer_1_recurring_on_wednesdays
    state_topic: vw-connect/0/status/climatisationTimer/1/recurringTimer/recurringOn/wednesdays
    payload_on: "true"
    payload_off: "false"
  - platform: mqtt
    name: vw_connect_climatisation_timer_1_recurring_on_thursdays
    state_topic: vw-connect/0/status/climatisationTimer/1/recurringTimer/recurringOn/thursdays
    payload_on: "true"
    payload_off: "false"
  - platform: mqtt
    name: vw_connect_climatisation_timer_1_recurring_on_fridays
    state_topic: vw-connect/0/status/climatisationTimer/1/recurringTimer/recurringOn/fridays
    payload_on: "true"
    payload_off: "false"
  - platform: mqtt
    name: vw_connect_climatisation_timer_1_recurring_on_saturdays
    state_topic: vw-connect/0/status/climatisationTimer/1/recurringTimer/recurringOn/saturdays
    payload_on: "true"
    payload_off: "false"
  - platform: mqtt
    name: vw_connect_climatisation_timer_1_recurring_on_sundays
    state_topic: vw-connect/0/status/climatisationTimer/1/recurringTimer/recurringOn/sundays
    payload_on: "true"
    payload_off: "false"

  - platform: mqtt
    state_topic: vw-connect/0/status/climatisationTimer/2/enabled
    name: vw_connect_climatisation_timer_2_enabled
    payload_on: "true"
    payload_off: "false"
  - platform: mqtt
    name: vw_connect_climatisation_timer_2_recurring_on_mondays
    state_topic: vw-connect/0/status/climatisationTimer/2/recurringTimer/recurringOn/mondays
    payload_on: "true"
    payload_off: "false"
  - platform: mqtt
    name: vw_connect_climatisation_timer_2_recurring_on_tuesdays
    state_topic: vw-connect/0/status/climatisationTimer/2/recurringTimer/recurringOn/tuesdays
    payload_on: "true"
    payload_off: "false"
  - platform: mqtt
    name: vw_connect_climatisation_timer_2_recurring_on_wednesdays
    state_topic: vw-connect/0/status/climatisationTimer/2/recurringTimer/recurringOn/wednesdays
    payload_on: "true"
    payload_off: "false"
  - platform: mqtt
    name: vw_connect_climatisation_timer_2_recurring_on_thursdays
    state_topic: vw-connect/0/status/climatisationTimer/2/recurringTimer/recurringOn/thursdays
    payload_on: "true"
    payload_off: "false"
  - platform: mqtt
    name: vw_connect_climatisation_timer_2_recurring_on_fridays
    state_topic: vw-connect/0/status/climatisationTimer/2/recurringTimer/recurringOn/fridays
    payload_on: "true"
    payload_off: "false"
  - platform: mqtt
    name: vw_connect_climatisation_timer_2_recurring_on_saturdays
    state_topic: vw-connect/0/status/climatisationTimer/2/recurringTimer/recurringOn/saturdays
    payload_on: "true"
    payload_off: "false"
  - platform: mqtt
    name: vw_connect_climatisation_timer_2_recurring_on_sundays
    state_topic: vw-connect/0/status/climatisationTimer/2/recurringTimer/recurringOn/sundays
    payload_on: "true"
    payload_off: "false"

  - platform: mqtt
    name: vw_connect_plug_connected
    state_topic: vw-connect/0/status/plugStatus/plugConnectionState
    payload_on: "connected"
    payload_off: "disconnected"
  - platform: mqtt
    name: vw_connect_plug_locked
    state_topic: vw-connect/0/status/plugStatus/plugLockState
    payload_off: "locked"
    payload_on: "unlocked"

  - platform: mqtt
    name: vw_connect_charging
    state_topic: vw-connect/0/status/chargingStatus/chargingState
    payload_on: "charging"
    payload_off: "readyForCharging"

sensor:
  - platform: template
    sensors:
      id_3_battery:
        friendly_name: "ID.3 Batteri"
        unit_of_measurement: "%"
        value_template: "{{ states('sensor.vw_connect_current_soc_pct') }}"
        attribute_templates:
          range_km: "{{ states('sensor.vw_connect_cruising_range_electric_km') }}"
          target_soc_pct: "{{ states('sensor.vw_connect_target_soc_pct') }}"
          charging_state: "{{ states('sensor.vw_connect_charging_state') }}"
          charge_power_kw: "{{ states('sensor.vw_connect_charge_power_kw') }}"
          charge_rate_kmph: "{{ states('sensor.vw_connect_charge_rate_kmph') }}"
          charge_time_remaining: "{{ states('sensor.vw_connect_remaining_charging_time_to_complete') }}"
          charge_time_remaining_min: "{{ states('sensor.vw_connect_remaining_charging_time_to_complete_min') }}"
          charging_finished_at: "{{ states('sensor.vw_connect_charging_complete_at') }}"
          unlock_plug_when_charged: "{{ is_state('binary_sensor.vw_connect_auto_unlock_plug_when_charged', 'on') }}"
          plug_locked: "{{ is_state('sensor.vw_connect_plug_lock_state', 'locked') }}"
          plug_connected: "{{ is_state('sensor.vw_connect_plug_connection_state', 'connected') }}"
          is_charging: "{{ is_state('sensor.vw_connect_charging_state', 'charging') }}"
          ac_current_limited: "{{ is_state('binary_sensor.vw_connect_reduced_charge_current_ac', 'on') }}"

      id_3_climatisation:
        friendly_name: "ID.3 Klimastyring"
        unit_of_measurement: °C
        value_template: "{{ states('sensor.vw_connect_target_temperature_c') }}"
        attribute_templates:
          state: "{{ states('sensor.vw_connect_climatisation_state') }}"
          climatisation_without_external_power: "{{ is_state('switch.vw_connect_climatisation_without_external_power', 'on') }}"
          time_in_car: "{{ states('sensor.vw_connect_climatisation_timer_time_in_car') }}"
          window_heating_front: "{{ is_state('binary_sensor.vw_connect_window_heating_status_front', 'on') }}"
          window_heating_rear: "{{ is_state('binary_sensor.vw_connect_window_heating_status_rear', 'on') }}"
          target_temperature_c: "{{ states('sensor.vw_connect_target_temperature_c') }}"
          front_left_zone_enabled: "{{ is_state('switch.vw_connect_climatisation_front_left', 'on') }}"
          front_right_zone_enabled: "{{ is_state('switch.vw_connect_climatisation_front_right', 'on') }}"
          remaining_climatisation_time_min: "{{ states('sensor.vw_connect_remaining_climatisation_time_min') }}"

      vw_connect_remaining_charging_time_to_complete:
        friendly_name: "Ladetid Tilbage"
        value_template: "{{ (timedelta(minutes=states('sensor.vw_connect_remaining_charging_time_to_complete_min')|int)|string)[:-3] }}"
        icon_template: mdi:clock-end
      vw_connect_charging_complete_at:
        friendly_name: Opladning færdig Tidspunkt
        value_template: >-
          {%- if is_state('binary_sensor.vw_connect_charging', 'on') -%}
            {%- set end_time = (states('sensor.vw_connect_remaining_charging_time_to_complete_min')|int*60) + (as_timestamp(now())|int) -%}
            {{ end_time | timestamp_custom('%Y-%m-%d %H:%M') }}
          {%- else -%}
            unknown
          {%- endif -%}
        icon_template: mdi:clock-end

  - platform: mqtt
    state_topic: vw-connect/0/status/climatisationStatus/climatisationState
    name: vw_connect_climatisation_state

  - platform: mqtt
    state_topic: vw-connect/0/status/climatisationSettings/targetTemperature_C
    name: vw_connect_target_temperature_c
    unit_of_measurement: °C

  - platform: mqtt
    state_topic: vw-connect/0/status/climatisationStatus/remainingClimatisationTime_min
    name: vw_connect_remaining_climatisation_time_min
    unit_of_measurement: min

  - platform: mqtt
    state_topic: vw-connect/0/status/climatisationTimer/1/singleTimer/startDateTime
    name: vw_connect_climatisation_timer_1_single_start_date_time
    value_template: "{{ as_local(strptime(value, '%Y-%m-%dT%H:%M:%S%z'))}}"

  - platform: mqtt
    state_topic: vw-connect/0/status/climatisationTimer/1/recurringTimer/startTime
    name: vw_connect_climatisation_timer_1_recurring_start_time
    value_template: >
      {%- set schdtime = strptime((utcnow().strftime('%Y-%m-%d ') + value+'Z'), '%Y-%m-%d %H:%M%z')|as_local -%}
      {{ schdtime.hour }}:{{ schdtime.minute }}

  - platform: mqtt
    state_topic: vw-connect/0/status/climatisationTimer/2/singleTimer/startDateTime
    name: vw_connect_climatisation_timer_2_single_start_date_time
    value_template: "{{ as_local(strptime(value, '%Y-%m-%dT%H:%M:%S%z'))}}"

  - platform: mqtt
    state_topic: vw-connect/0/status/climatisationTimer/2/recurringTimer/startTime
    name: vw_connect_climatisation_timer_2_recurring_start_time
    value_template: >
      {%- set schdtime = strptime((utcnow().strftime('%Y-%m-%d ') + value+'Z'), '%Y-%m-%d %H:%M%z')|as_local -%}
      {{ schdtime.hour }}:{{ schdtime.minute }}

  - platform: mqtt
    state_topic: vw-connect/0/status/climatisationTimer/timeInCar
    name: vw_connect_climatisation_timer_time_in_car
    value_template: "{{ as_local(strptime(value, '%Y-%m-%dT%H:%M:%S%z'))}}"

  - platform: mqtt
    state_topic: vw-connect/0/status/plugStatus/plugConnectionState
    name: vw_connect_plug_connection_state

  - platform: mqtt
    state_topic: vw-connect/0/status/plugStatus/plugLockState
    name: vw_connect_plug_lock_state

  - platform: mqtt
    state_topic: vw-connect/0/status/chargingSettings/targetSOC_pct
    name: vw_connect_target_soc_pct
    unit_of_measurement: "%"

  - platform: mqtt
    state_topic: vw-connect/0/status/chargingStatus/chargeRate_kmph
    name: vw_connect_charge_rate_kmph
    unit_of_measurement: "km/t"

  - platform: mqtt
    state_topic: vw-connect/0/status/chargingStatus/chargePower_kW
    name: vw_connect_charge_power_kw
    unit_of_measurement: "kW"

  - platform: mqtt
    state_topic: vw-connect/0/status/chargingStatus/chargingState
    name: vw_connect_charging_state

  - platform: mqtt
    state_topic: vw-connect/0/status/chargingStatus/remainingChargingTimeToComplete_min
    name: vw_connect_remaining_charging_time_to_complete_min
    unit_of_measurement: "min"

  - platform: mqtt
    state_topic: vw-connect/0/status/batteryStatus/cruisingRangeElectric_km
    name: vw_connect_cruising_range_electric_km
    unit_of_measurement: "km"

  - platform: mqtt
    state_topic: vw-connect/0/status/batteryStatus/currentSOC_pct
    name: vw_connect_current_soc_pct
    unit_of_measurement: "%"

  - platform: mqtt
    state_topic: vw-connect/0/status/climatisationRequestStatus/info
    name: vw_connect_climatisation_request_status_info

  - platform: mqtt
    state_topic: vw-connect/0/status/climatisationRequestStatus/status
    name: vw_connect_status_climatisation_request_status

group:
  id_3_timer_1_recurring:
    name: ID.3 Timer 1 Recurring
    entities:
      - binary_sensor.vw_connect_climatisation_timer_1_recurring_on_mondays
      - binary_sensor.vw_connect_climatisation_timer_1_recurring_on_tuesdays
      - binary_sensor.vw_connect_climatisation_timer_1_recurring_on_wednesdays
      - binary_sensor.vw_connect_climatisation_timer_1_recurring_on_thursdays
      - binary_sensor.vw_connect_climatisation_timer_1_recurring_on_fridays
      - binary_sensor.vw_connect_climatisation_timer_1_recurring_on_saturdays
      - binary_sensor.vw_connect_climatisation_timer_1_recurring_on_sundays

  id_3_timer_2_recurring:
    name: ID.3 Timer 2 Recurring
    entities:
      - binary_sensor.vw_connect_climatisation_timer_2_recurring_on_mondays
      - binary_sensor.vw_connect_climatisation_timer_2_recurring_on_tuesdays
      - binary_sensor.vw_connect_climatisation_timer_2_recurring_on_wednesdays
      - binary_sensor.vw_connect_climatisation_timer_2_recurring_on_thursdays
      - binary_sensor.vw_connect_climatisation_timer_2_recurring_on_fridays
      - binary_sensor.vw_connect_climatisation_timer_2_recurring_on_saturdays
      - binary_sensor.vw_connect_climatisation_timer_2_recurring_on_sundays
