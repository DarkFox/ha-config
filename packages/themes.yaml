automation:
  - alias: Light Profile Frontend Theme Setter
    id: light_profile_frontend_theme_setter
    initial_state: True
    trigger:
      - platform: homeassistant
        event: start
      - platform: state
        entity_id: input_select.light_profile
      - platform: template
        alias: Set current mode when a browser becomes available
        value_template: >-
          [
            {%- for entity in states.binary_sensor | rejectattr('state', 'eq', 'unavailable') | selectattr('entity_id', 'match', '.+_browser_dark_mode') | list -%}
              "{{ entity.attributes.get('browserID') }}",
            {% endfor -%}
          ]
    variables:
      browser_ids: >-
        {{ (trigger.to_state.attributes.browserID | reject('in', trigger.from_state.attributes.browserID)) if trigger.platform == 'template' else none }}
    action:
      - choose:
          - conditions:
              - condition: state
                entity_id: input_select.light_profile
                state:
                  - "Bright"
                  - "Default"
            sequence:
              service: browser_mod.set_theme
              data:
                dark: light
                browser_id: "{{ browser_ids or [] }}"
          - conditions:
              - condition: state
                entity_id: input_select.light_profile
                state:
                  - "Night"
                  - "Off"
            sequence:
              service: browser_mod.set_theme
              data:
                dark: dark
                browser_id: "{{ browser_ids or [] }}"
        default:
          service: browser_mod.set_theme
          data:
            dark: auto
            browser_id: "{{ browser_ids or [] }}"

template:
  - binary_sensor:
      - name: Dark Mode
        state: "{{ states('input_select.light_profile') not in ['Bright', 'Default'] }}"
